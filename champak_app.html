<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Champak Comics</title>
<link rel="manifest" href="#" id="pwaManifest">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Champak">
<meta name="theme-color" content="#FF6B00">
<link rel="apple-touch-icon" href="./champak_icon.png">
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&family=Lilita+One&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{font-family:'Baloo 2',cursive;background:var(--bg);color:var(--text);transition:background .3s,color .3s;}
:root{--a:#FF6B00;--a2:#FF4400;--s:#CC3300;--p:#FFD700;--p2:#FFC200;--bd:#E8A800;--bg:#FFF5C0;--nav:#FFE566;--card:#fff;--text:#333;--sub:#888;--h1:#CC2200;--h2:#884400;--h3:#886600;--tab:#FF4400;}
body.theme-blue{--a:#1565C0;--a2:#0D47A1;--s:#01579B;--p:#4FC3F7;--p2:#0288D1;--bd:#0277BD;--bg:#E3F2FD;--nav:#B3E5FC;--h1:#0D47A1;--h2:#1565C0;--h3:#1976D2;--tab:#1565C0;}
body.theme-green{--a:#2E7D32;--a2:#1B5E20;--s:#1B5E20;--p:#A5D6A7;--p2:#43A047;--bd:#2E7D32;--bg:#E8F5E9;--nav:#C8E6C9;--h1:#1B5E20;--h2:#2E7D32;--h3:#388E3C;--tab:#2E7D32;}
body.theme-purple{--a:#6A1B9A;--a2:#4A148C;--s:#4A148C;--p:#CE93D8;--p2:#8E24AA;--bd:#6A1B9A;--bg:#F3E5F5;--nav:#E1BEE7;--h1:#4A148C;--h2:#6A1B9A;--h3:#7B1FA2;--tab:#6A1B9A;}
body.theme-pink{--a:#C2185B;--a2:#880E4F;--s:#880E4F;--p:#F48FB1;--p2:#E91E63;--bd:#C2185B;--bg:#FCE4EC;--nav:#F8BBD0;--h1:#880E4F;--h2:#C2185B;--h3:#D81B60;--tab:#C2185B;}
body.dark{--bg:#12121e;--card:#1e1e30;--text:#e8e0ff;--sub:#888;}
body.dark .home-hdr{background:linear-gradient(135deg,#1e1e30,#12121e)!important;border-color:#333358!important;}
body.dark #bNav{background:linear-gradient(180deg,#1e1e30,#12121e)!important;border-color:#333358!important;}
body.dark .nav-ico:not(.act-ico){background:rgba(255,255,255,.07)!important;}
body.dark .lcard,body.dark .acard,body.dark .game-card,body.dark .topic-card,body.dark .lrn-card,body.dark .ttt-cell,body.dark .mem-card-inner,body.dark .sett-group,body.dark .sett-row,body.dark .fb-form,body.dark .quiz-question,body.dark .q-opt,body.dark .msg-item,body.dark .notif-panel,body.dark .cat-tabs,body.dark .search-bar,body.dark .streak-bar,body.dark .sl-info,body.dark .ludo-info{background:#1e1e30!important;border-color:#333358!important;}
body.dark .fb-input,body.dark .fb-textarea{background:#12121e!important;color:#e8e0ff!important;border-color:#333358!important;}
body.dark .lcard-name,body.dark .acard-name,body.dark .sett-label,body.dark .sec-title,body.dark .game-title,body.dark .topic-title,body.dark .lrn-w,body.dark .q-text,body.dark .lrn-n{color:#e8e0ff!important;}
body.dark .xp-bar-bg{background:#333358!important;}
.page{display:none;position:fixed;inset:0;flex-direction:column;overflow:hidden;}
.page.active{display:flex;}

/* ANIMATIONS */
@keyframes cin{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes pop{0%{transform:scale(0)}65%{transform:scale(1.18)}100%{transform:scale(1)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes shimmer{0%{left:-80%}65%,100%{left:140%}}
@keyframes btnGlow{0%,100%{box-shadow:0 6px 0 #A03000,0 9px 22px rgba(180,60,0,.4)}50%{box-shadow:0 6px 0 #A03000,0 14px 34px rgba(255,110,0,.7)}}
@keyframes confettiFall{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}
@keyframes diceRoll{0%,100%{transform:rotate(0)}25%{transform:rotate(-16deg)}75%{transform:rotate(16deg)}}
@keyframes lvlUp{0%{transform:scale(.5) translateY(20px);opacity:0}30%{transform:scale(1.3) translateY(0);opacity:1}70%{transform:scale(1.1);opacity:1}100%{transform:scale(1) translateY(-30px);opacity:0}}
@keyframes ripple-anim{to{transform:scale(4);opacity:0}}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
@keyframes tokenMove{0%{transform:scale(1)}50%{transform:scale(1.4)}100%{transform:scale(1)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* RIPPLE */
.ripple-wrap{position:relative;overflow:hidden;}
.ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,.35);transform:scale(0);animation:ripple-anim .55s linear;pointer-events:none;}

/* SPLASH */
#pgSplash{transition:opacity .8s;z-index:999;background:#ffd84d;}
.sp-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center top;}
.sp-btn-wrap{position:absolute;bottom:22%;left:50%;transform:translateX(-50%);z-index:10;width:72%;max-width:290px;}
.sp-btn{width:100%;padding:15px 20px;background:linear-gradient(180deg,#FFAA00,#FF6A00 55%,#E84500);color:#fff;font-family:'Baloo 2',cursive;font-size:25px;font-weight:800;border:none;border-radius:50px;cursor:pointer;box-shadow:0 6px 0 #A03000;display:flex;align-items:center;justify-content:center;gap:10px;position:relative;overflow:hidden;animation:btnGlow 2s ease-in-out infinite;}
.sp-btn::after{content:'';position:absolute;top:0;left:-80%;width:55%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.38),transparent);animation:shimmer 2.6s ease-in-out infinite;}
.sp-btn:active{transform:translateY(4px);}

/* ONBOARD */
#pgOnboard{background:linear-gradient(160deg,#FFE566,#FFD000 50%,#8DC42A);align-items:center;justify-content:flex-start;overflow-y:auto;}
#pgOnboard::-webkit-scrollbar{width:0;}
.ob-inner{width:100%;max-width:360px;margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:14px;padding:30px 22px 28px;}
.ob-title{font-family:'Lilita One',cursive;font-size:26px;color:#CC2200;text-align:center;}
.ob-sub{font-size:13px;color:#665500;font-weight:700;text-align:center;}
.ob-input{width:100%;padding:13px 16px;border-radius:14px;border:3px solid #E8A800;font-family:'Baloo 2',cursive;font-size:17px;font-weight:700;color:#333;outline:none;text-align:center;background:#fff;}
.char-lbl{font-family:'Lilita One',cursive;font-size:15px;color:#CC2200;align-self:flex-start;}
.char-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:9px;width:100%;}
.char-btn{background:#fff;border-radius:14px;padding:10px 6px;text-align:center;border:3px solid transparent;cursor:pointer;transition:all .15s;box-shadow:0 3px 8px rgba(0,0,0,.1);}
.char-btn.sel{border-color:var(--a,#FF6B00);background:rgba(255,107,0,.08);transform:scale(1.05);}
.char-btn:active{transform:scale(.93);}
.char-btn-e{font-size:30px;}
.char-btn-n{font-size:10px;font-weight:800;color:#555;margin-top:2px;}
.ob-btn{width:100%;padding:14px;background:linear-gradient(135deg,#FF7700,#FF4400);color:#fff;font-family:'Lilita One',cursive;font-size:20px;border:none;border-radius:16px;box-shadow:0 5px 0 #CC3300;cursor:pointer;}
.ob-btn:active{transform:translateY(3px);}

/* HEADERS */
.home-hdr{background:linear-gradient(135deg,var(--p),var(--p2));padding:10px 12px;display:flex;align-items:center;gap:9px;border-bottom:3px solid var(--bd);box-shadow:0 3px 10px rgba(0,0,0,.12);flex-shrink:0;}
.app-hdr{padding:5px 10px 2px;display:flex;align-items:center;gap:8px;flex-shrink:0;background:transparent;min-height:44px;}
.hdr-avatar{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--a),var(--a2));border:2.5px solid rgba(255,255,255,.5);display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer;flex-shrink:0;box-shadow:0 3px 8px rgba(0,0,0,.18);}
.hdr-uname{font-family:'Lilita One',cursive;font-size:17px;color:var(--h1);line-height:1.1;}
.hdr-rank{display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.45);border-radius:8px;padding:2px 8px;font-size:11px;font-weight:800;color:var(--h2);margin-top:2px;}
.hdr-btn{background:rgba(255,255,255,.4);border:2px solid rgba(255,255,255,.55);color:var(--h2);width:36px;height:36px;border-radius:11px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;position:relative;}
.hdr-back{background:rgba(128,128,128,.15);border:1.5px solid rgba(128,128,128,.25);color:var(--text);width:36px;height:36px;border-radius:11px;font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.notif-dot{position:absolute;top:2px;right:2px;width:9px;height:9px;background:#FF3D00;border-radius:50%;border:1.5px solid var(--p);}

/* NOTIF PANEL */
.notif-panel{position:fixed;top:0;right:0;width:290px;max-width:88vw;height:100%;background:var(--card);z-index:900;box-shadow:-4px 0 20px rgba(0,0,0,.2);transform:translateX(100%);transition:transform .3s;display:flex;flex-direction:column;}
.notif-panel.open{transform:translateX(0);}
.notif-hdr{background:linear-gradient(135deg,var(--a),var(--a2));padding:13px 14px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.notif-close{background:rgba(255,255,255,.25);border:none;color:#fff;width:28px;height:28px;border-radius:7px;font-size:14px;cursor:pointer;}
.notif-list{flex:1;overflow-y:auto;padding:7px;}
.notif-list::-webkit-scrollbar{width:0;}
.notif-item{padding:10px 11px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;gap:9px;animation:cin .3s ease;}
.notif-item.reply-msg{background:linear-gradient(135deg,rgba(255,200,0,.1),rgba(255,107,0,.06));border-left:3px solid var(--a);border-radius:0 8px 8px 0;}
.notif-empty{text-align:center;padding:40px 14px;color:var(--sub);font-size:13px;font-weight:700;}
.notif-ov{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:899;display:none;}
.notif-ov.show{display:block;}

/* PLAYER SETUP MODAL */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:800;display:flex;align-items:center;justify-content:center;}
.modal-box{background:var(--bg);border-radius:20px;padding:20px;width:320px;max-width:90vw;border:3px solid var(--bd);box-shadow:0 8px 24px rgba(0,0,0,.3);animation:pop .3s ease;}
.modal-title{font-family:'Lilita One',cursive;font-size:20px;color:var(--h1);text-align:center;margin-bottom:14px;}
.modal-in{width:100%;padding:10px 13px;border-radius:12px;border:2.5px solid var(--bd);font-family:'Baloo 2',cursive;font-size:15px;font-weight:700;color:var(--text);background:var(--card);outline:none;margin-bottom:9px;}
.colour-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;margin-bottom:13px;}
.colour-dot{width:100%;aspect-ratio:1;border-radius:50%;cursor:pointer;border:3px solid transparent;display:flex;align-items:center;justify-content:center;font-size:13px;}
.colour-dot.sel{border-color:#333;box-shadow:0 0 0 2px #fff,0 0 0 4px #333;}
.modal-btn{width:100%;padding:12px;background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;border:none;border-radius:12px;font-family:'Lilita One',cursive;font-size:16px;box-shadow:0 4px 0 var(--s);cursor:pointer;}
.modal-btn:active{transform:translateY(3px);}

/* FAVS OVERLAY */
#favsOv{display:none;position:fixed;inset:0;z-index:800;background:rgba(0,0,0,.5);animation:fadeIn .2s ease;}
#favsOv.show{display:flex;flex-direction:column;}
.favs-panel{background:var(--bg);flex:1;margin-top:60px;border-radius:20px 20px 0 0;overflow:hidden;display:flex;flex-direction:column;animation:slideUp .3s ease;}
.favs-phdr{background:linear-gradient(135deg,var(--a),var(--a2));padding:13px 14px;display:flex;align-items:center;justify-content:space-between;}
.favs-px{background:rgba(255,255,255,.25);border:none;color:#fff;width:30px;height:30px;border-radius:8px;font-size:16px;cursor:pointer;}
.favs-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;padding:12px;overflow-y:auto;flex:1;}
.favs-grid::-webkit-scrollbar{width:0;}
.fav-card{background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 3px 9px rgba(0,0,0,.09);cursor:pointer;border:2px solid rgba(255,200,0,.12);}
.fav-card:active{transform:scale(.95);}
.fav-thumb{height:130px;position:relative;overflow:hidden;background:linear-gradient(135deg,#FF9500,#FF6B00);}
.fav-thumb img{position:absolute;inset:-2px;width:calc(100% + 4px);height:calc(100% + 4px);object-fit:cover;object-position:center;}
.fav-name{font-size:10px;font-weight:700;color:var(--text);padding:6px 8px 4px;line-height:1.3;}
.fav-rm{width:calc(100% - 14px);margin:0 7px 7px;padding:5px;background:linear-gradient(135deg,#E91E63,#C2185B);color:#fff;border:none;border-radius:8px;font-family:'Lilita One',cursive;font-size:10px;cursor:pointer;}

/* HOME */
#pgHome{background:var(--bg);}
#homeScroll{flex:1;overflow-y:auto;padding-bottom:68px;}
#homeScroll::-webkit-scrollbar{width:0;}
.ann-bar{background:linear-gradient(135deg,var(--a),var(--a2));padding:8px 13px;display:flex;align-items:center;gap:7px;flex-shrink:0;}
.ann-x{background:rgba(255,255,255,.25);border:none;color:#fff;width:22px;height:22px;border-radius:6px;font-size:11px;cursor:pointer;}
.streak-bar{background:var(--card);margin:10px 13px 0;border-radius:13px;padding:9px 13px;display:flex;align-items:center;gap:9px;box-shadow:0 2px 7px rgba(0,0,0,.08);border:2px solid rgba(255,200,0,.2);}
.xp-bar-bg{height:6px;width:60px;background:#eee;border-radius:3px;overflow:hidden;}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--a),var(--a2));border-radius:3px;transition:width .5s;}
.hero-banner{margin:10px 13px 8px;border-radius:16px;overflow:hidden;border:3px solid var(--bd);box-shadow:0 5px 0 rgba(0,0,0,.12);cursor:pointer;}
.hero-img{height:140px;overflow:hidden;background:#FFB300;}
.hero-img img{width:100%;height:100%;object-fit:cover;}
.hero-foot{background:linear-gradient(135deg,#4A9A18,#5BB320);padding:8px 13px;display:flex;align-items:center;justify-content:space-between;}
.cotd-wrap{margin:0 13px 8px;}
.cotd-lbl{font-family:'Lilita One',cursive;font-size:13px;color:var(--a);margin-bottom:5px;}
.cotd-card{background:linear-gradient(135deg,var(--a),var(--a2));border-radius:13px;padding:10px;display:flex;align-items:center;gap:11px;box-shadow:0 4px 0 var(--s);cursor:pointer;}
.cotd-thumb{width:52px;height:65px;border-radius:8px;overflow:hidden;flex-shrink:0;background:#ffbb77;}
.cotd-thumb img{width:100%;height:100%;object-fit:cover;object-position:center top;}
.cotd-btn{background:rgba(255,255,255,.22);border:2px solid rgba(255,255,255,.35);color:#fff;font-family:'Lilita One',cursive;font-size:11px;padding:5px 10px;border-radius:8px;cursor:pointer;white-space:nowrap;}
.search-wrap{padding:0 13px 8px;}
.search-bar{display:flex;align-items:center;gap:8px;background:var(--card);border-radius:12px;padding:9px 12px;border:2px solid rgba(255,200,0,.25);box-shadow:0 2px 6px rgba(0,0,0,.07);}
.search-bar input{flex:1;border:none;outline:none;font-family:'Baloo 2',cursive;font-size:13px;font-weight:700;color:var(--text);background:transparent;}
.search-bar input::placeholder{color:#bbb;font-weight:400;}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;padding:4px 13px 7px;}
.sec-title{font-family:'Lilita One',cursive;font-size:15px;color:var(--text);}
.see-all{font-size:11px;color:var(--a);font-weight:700;background:rgba(255,107,0,.1);padding:4px 9px;border-radius:9px;cursor:pointer;border:none;font-family:'Baloo 2',cursive;}

/* CARDS */
.lib-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 13px;}
.lcard{background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.1);cursor:pointer;border:2px solid rgba(255,200,0,.12);animation:cin .4s ease both;position:relative;}
.lcard:active{transform:scale(.95);}
.lcard-thumb{height:145px;position:relative;overflow:hidden;background:linear-gradient(135deg,#FF9500,#FF6B00);}
.lcard-thumb img{position:absolute;inset:-2px;width:calc(100% + 4px);height:calc(100% + 4px);object-fit:cover;object-position:center;}
.lcard-name{font-size:10px;font-weight:700;color:var(--text);padding:7px 9px 5px;line-height:1.3;}
.lread-btn{width:calc(100% - 18px);margin:0 9px 9px;padding:6px;background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;border:none;border-radius:9px;font-family:'Lilita One',cursive;font-size:11px;box-shadow:0 3px 0 var(--s);cursor:pointer;}
.cbadge{position:absolute;top:7px;font-size:9px;font-weight:800;padding:2px 7px;border-radius:7px;z-index:2;}
.bl{left:7px;}.br{right:7px;}
.b-hi{background:#138808;color:#fff;}.b-en{background:#003087;color:#fff;}
.b-new{background:#FF3D00;color:#fff;}.b-pin{background:#FFD700;color:#8B1A00;}

/* BOTTOM NAV */
#bNav{position:fixed;bottom:0;left:0;right:0;height:62px;background:linear-gradient(180deg,var(--nav),var(--p));border-top:3px solid var(--bd);display:flex;align-items:center;box-shadow:0 -3px 10px rgba(0,0,0,.12);z-index:50;}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;cursor:pointer;padding:3px 2px;position:relative;}
.nav-ico{width:36px;height:36px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:17px;transition:transform .15s;}
.act-ico{background:linear-gradient(135deg,var(--a),var(--a2));box-shadow:0 3px 8px rgba(255,100,0,.35);}
.nav-item:not([data-active]) .nav-ico{background:rgba(255,255,255,.5);}
.nav-label{font-size:9px;font-weight:700;color:var(--h2);}
.nav-item[data-active] .nav-label{color:var(--a2);}
.nav-item:active .nav-ico{transform:scale(.85);}
.nav-badge{position:absolute;top:1px;right:calc(50% - 21px);background:#FF3D00;color:#fff;font-size:8px;font-weight:800;min-width:14px;height:14px;border-radius:7px;display:flex;align-items:center;justify-content:center;padding:0 3px;border:2px solid var(--bg);}

/* LEADERBOARD */
#pgLeaderboard{background:var(--bg);}
.lb-scr{flex:1;overflow-y:auto;padding:12px 13px 74px;}
.lb-scr::-webkit-scrollbar{width:0;}
.lb-my-card{background:linear-gradient(135deg,var(--a),var(--a2));border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:0 5px 0 var(--s);}
.lb-row{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--card);border-radius:12px;margin-bottom:7px;border:2px solid rgba(255,200,0,.1);box-shadow:0 2px 6px rgba(0,0,0,.06);animation:cin .3s ease both;}
.lb-rank-num{font-family:'Lilita One',cursive;font-size:18px;color:var(--sub);width:26px;text-align:center;flex-shrink:0;}
.lb-ava{font-size:26px;flex-shrink:0;}
.lb-row.top1{background:linear-gradient(135deg,#FFF9E6,#FFF0B3);border-color:#FFD700;}
.lb-row.top2{background:linear-gradient(135deg,#F5F5F5,#E8E8E8);border-color:#BDBDBD;}
.lb-row.top3{background:linear-gradient(135deg,#FFF0E6,#FFE0CC);border-color:#FF8C42;}
.lb-row.is-me{border-color:var(--a);background:linear-gradient(135deg,rgba(255,107,0,.06),rgba(255,68,0,.03));}
.lb-sync{display:flex;align-items:center;justify-content:center;gap:7px;padding:8px;color:var(--sub);font-size:11px;font-weight:700;}

/* COMICS PAGE */
#pgSeeAll{background:var(--bg);}
.cat-tabs{display:flex;background:var(--card);padding:0 13px;border-bottom:2px solid rgba(255,200,0,.2);flex-shrink:0;}
.cat-tab{flex-shrink:0;padding:10px 14px 9px;font-family:'Lilita One',cursive;font-size:13px;color:#aaa;background:transparent;border:none;cursor:pointer;position:relative;}
.cat-tab.on{color:var(--tab);}
.cat-tab.on::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:var(--tab);border-radius:3px 3px 0 0;}
.scr{flex:1;overflow-y:auto;}
.scr::-webkit-scrollbar{width:0;}
.all-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px 13px 8px;}
.acard{background:var(--card);border-radius:16px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.09);cursor:pointer;border:2px solid rgba(255,200,0,.1);animation:cin .4s ease both;position:relative;}
.acard:active{transform:scale(.96);}
.acard-thumb{height:168px;position:relative;overflow:hidden;background:linear-gradient(135deg,#FF9500,#FF6B00);}
.acard-thumb img{position:absolute;inset:-2px;width:calc(100% + 4px);height:calc(100% + 4px);object-fit:cover;object-position:center;}
.acard-ov{position:absolute;inset:0;background:linear-gradient(to bottom,transparent 55%,rgba(0,0,0,.4));}
.acard-date{position:absolute;top:7px;right:7px;background:#FFE100;color:#8B1A00;font-size:9px;font-weight:800;padding:2px 6px;border-radius:6px;}
.acard-pages{position:absolute;bottom:7px;left:7px;background:rgba(0,0,0,.55);color:#fff;font-size:9px;padding:2px 5px;border-radius:5px;}
.acard-info{padding:9px 10px 10px;}
.acard-name{color:var(--text);font-size:12px;font-weight:800;line-height:1.3;margin-bottom:7px;}
.aread-btn{flex:1;padding:7px;background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;border:none;border-radius:8px;font-family:'Lilita One',cursive;font-size:11px;box-shadow:0 3px 0 var(--s);cursor:pointer;}
.no-items{grid-column:1/-1;text-align:center;padding:40px 18px;color:#bbb;font-size:14px;font-weight:700;line-height:1.8;}

/* GAMES */
#pgGames{background:var(--bg);}
.games-grid{display:grid;grid-template-columns:1fr 1fr;gap:11px;padding:13px;}
.game-card{background:var(--card);border-radius:17px;padding:18px 12px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.09);cursor:pointer;border:2px solid rgba(255,200,0,.12);animation:cin .4s ease both;}
.game-card:active{transform:scale(.93);}
.game-ico{font-size:40px;margin-bottom:7px;}
.game-title{font-family:'Lilita One',cursive;font-size:14px;color:var(--text);margin-bottom:3px;}
.game-sub{font-size:10px;color:var(--sub);font-weight:600;}
.game-btn{width:100%;margin-top:9px;padding:8px;background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;border:none;border-radius:10px;font-family:'Lilita One',cursive;font-size:12px;box-shadow:0 3px 0 var(--s);cursor:pointer;}

/* TTT */
#pgTTT{background:var(--bg);}
.ttt-wrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;gap:13px;}
.ttt-status{font-family:'Lilita One',cursive;font-size:20px;color:var(--text);text-align:center;}
.ttt-board{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;width:260px;}
.ttt-cell{height:82px;background:var(--card);border-radius:13px;border:3px solid rgba(255,200,0,.25);display:flex;align-items:center;justify-content:center;font-size:36px;cursor:pointer;box-shadow:0 3px 7px rgba(0,0,0,.08);transition:transform .1s;}
.ttt-cell:active{transform:scale(.91);}
.ttt-cell.x{color:#FF4400;}.ttt-cell.o{color:#0066CC;}
.ttt-cell.win{background:linear-gradient(135deg,#FFE566,#FFD700)!important;animation:pop .3s ease;}
.ttt-mode-wrap{display:flex;gap:8px;}
.ttt-mode-btn{padding:7px 15px;border-radius:10px;border:2px solid rgba(255,200,0,.3);background:var(--card);font-family:'Baloo 2',cursive;font-size:12px;font-weight:700;color:var(--text);cursor:pointer;}
.ttt-mode-btn.on{background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;border-color:var(--a);}
.g-btn{padding:10px 20px;border:none;border-radius:12px;font-family:'Lilita One',cursive;font-size:14px;cursor:pointer;background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;box-shadow:0 3px 0 var(--s);}

/* SNAKE & LADDER */
#pgSnake{background:var(--bg);}
.sl-outer{flex:1;overflow-y:auto;padding:10px;}
.sl-outer::-webkit-scrollbar{width:0;}
.sl-canvas-wrap{width:100%;max-width:400px;margin:0 auto;position:relative;}
.sl-board-svg{width:100%;border-radius:12px;border:4px solid var(--bd);box-shadow:0 5px 14px rgba(0,0,0,.15);}
.sl-info{background:var(--card);border-radius:14px;padding:12px 13px;margin:9px auto 0;max-width:400px;box-shadow:0 3px 8px rgba(0,0,0,.08);}
.sl-players-row{display:flex;gap:8px;margin-bottom:10px;}
.sl-player-chip{flex:1;border-radius:10px;padding:8px 10px;text-align:center;border:3px solid transparent;transition:all .2s;}
.sl-player-chip.cur{animation:pulse 1s ease-in-out infinite;}
.dice-btn{width:100%;padding:11px;border:none;border-radius:12px;font-family:'Lilita One',cursive;font-size:16px;background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;box-shadow:0 4px 0 var(--s);cursor:pointer;}
.dice-btn:active{transform:translateY(2px);}
.dice-btn.rolling{animation:diceRoll .4s ease;}

/* MEMORY */
#pgMemory{background:var(--bg);}
.mem-wrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:13px;gap:10px;}
.mem-stats{display:flex;gap:20px;}
.mem-stat-num{font-family:'Lilita One',cursive;font-size:22px;color:var(--a);}
.mem-stat-lbl{font-size:10px;color:var(--sub);font-weight:700;}
.mem-board{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;width:100%;max-width:330px;}
.mem-card{aspect-ratio:.74;perspective:600px;cursor:pointer;}
.mem-card-inner{width:100%;height:100%;position:relative;transition:transform .35s;transform-style:preserve-3d;border-radius:10px;}
.mem-card.flipped .mem-card-inner{transform:rotateY(180deg);}
.mem-card-front,.mem-card-back{position:absolute;inset:0;border-radius:10px;display:flex;align-items:center;justify-content:center;backface-visibility:hidden;-webkit-backface-visibility:hidden;}
.mem-card-front{background:linear-gradient(135deg,var(--a),var(--a2));font-size:20px;}
.mem-card-back{background:var(--card);font-size:24px;transform:rotateY(180deg);box-shadow:0 3px 7px rgba(0,0,0,.1);border:2px solid rgba(255,200,0,.2);}
.mem-card.matched .mem-card-back{background:linear-gradient(135deg,#E8F5E9,#C8E6C9);border-color:#81C784;}

/* LUDO */
#pgLudo{background:var(--bg);}
.ludo-outer{flex:1;overflow-y:auto;padding:10px;}
.ludo-outer::-webkit-scrollbar{width:0;}
.ludo-board-wrap{width:100%;max-width:360px;margin:0 auto;position:relative;}
.ludo-svg{width:100%;border-radius:8px;border:3px solid var(--bd);box-shadow:0 5px 14px rgba(0,0,0,.15);}
.ludo-info{background:var(--card);border-radius:14px;padding:11px 13px;margin:9px auto 0;max-width:360px;box-shadow:0 3px 8px rgba(0,0,0,.08);}
.lu-players-row{display:flex;gap:7px;margin-bottom:9px;flex-wrap:wrap;}
.lu-chip{flex:1;min-width:70px;border-radius:10px;padding:7px 9px;text-align:center;border:3px solid transparent;}
.lu-chip.cur{animation:pulse 1s ease-in-out infinite;}

/* LEARN */
#pgLearn{background:var(--bg);}
.learn-scr{flex:1;overflow-y:auto;padding:12px 13px 68px;}
.learn-scr::-webkit-scrollbar{width:0;}
.age-title{font-family:'Lilita One',cursive;font-size:15px;color:var(--text);margin-bottom:9px;padding:0 2px;}
.learn-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px;}
.topic-card{background:var(--card);border-radius:15px;padding:14px 10px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,.09);cursor:pointer;border:2px solid rgba(255,200,0,.12);animation:cin .4s ease both;}
.topic-card:active{transform:scale(.93);}
.topic-ico{font-size:36px;margin-bottom:5px;}
.topic-title{font-family:'Lilita One',cursive;font-size:13px;color:var(--text);margin-bottom:2px;}
.topic-sub{font-size:10px;color:var(--sub);font-weight:600;}
.topic-prog{height:5px;background:#eee;border-radius:3px;margin-top:7px;overflow:hidden;}

/* TOPIC + QUIZ */
#pgTopic{background:var(--bg);}
.topic-scr{flex:1;overflow-y:auto;padding:12px 13px 14px;}
.topic-scr::-webkit-scrollbar{width:0;}
.lrn-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.lrn-card{background:var(--card);border-radius:15px;padding:12px 9px;text-align:center;box-shadow:0 3px 9px rgba(0,0,0,.08);cursor:pointer;animation:cin .3s ease both;border:2px solid rgba(255,200,0,.1);}
.lrn-card:active{transform:scale(.93);}
.lrn-e{font-size:42px;margin-bottom:5px;display:block;}
.lrn-w{font-family:'Lilita One',cursive;font-size:15px;color:var(--a);margin-bottom:2px;}
.lrn-n{font-size:10px;font-weight:700;color:var(--text);}
.quiz-start{width:100%;margin:12px 0 0;padding:13px;background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;border:none;border-radius:13px;font-family:'Lilita One',cursive;font-size:17px;box-shadow:0 5px 0 var(--s);cursor:pointer;}
#pgQuiz{background:var(--bg);}
.quiz-wrap{flex:1;display:flex;flex-direction:column;padding:13px;gap:11px;}
.q-prog-bar{height:7px;background:#eee;border-radius:4px;overflow:hidden;}
.q-prog-fill{height:100%;background:linear-gradient(90deg,var(--a),var(--a2));border-radius:4px;transition:width .3s;}
.quiz-question{background:var(--card);border-radius:16px;padding:17px;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,.08);}
.q-emoji{font-size:50px;margin-bottom:9px;display:block;}
.q-text{font-family:'Lilita One',cursive;font-size:17px;color:var(--text);}
.quiz-opts{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.q-opt{padding:12px 8px;background:var(--card);border:3px solid rgba(255,200,0,.2);border-radius:13px;font-family:'Baloo 2',cursive;font-size:13px;font-weight:700;color:var(--text);cursor:pointer;text-align:center;box-shadow:0 3px 7px rgba(0,0,0,.07);}
.q-opt:active{transform:scale(.93);}
.q-opt.correct{background:linear-gradient(135deg,#E8F5E9,#C8E6C9);border-color:#66BB6A;color:#1B5E20;}
.q-opt.wrong{background:linear-gradient(135deg,#FFEBEE,#FFCDD2);border-color:#EF9A9A;color:#B71C1C;}

/* SETTINGS */
#pgSettings{background:var(--bg);}
.sett-scr{flex:1;overflow-y:auto;padding:13px;padding-bottom:76px;}
.sett-scr::-webkit-scrollbar{width:0;}
.user-profile-card{background:linear-gradient(135deg,var(--a),var(--a2));border-radius:18px;padding:16px;margin-bottom:16px;box-shadow:0 5px 0 var(--s);}
.user-pc-top{display:flex;align-items:center;gap:13px;margin-bottom:12px;}
.user-pc-av{width:60px;height:60px;border-radius:16px;background:rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;font-size:32px;border:2.5px solid rgba(255,255,255,.45);}
.user-pc-name{font-family:'Lilita One',cursive;font-size:22px;color:#fff;}
.user-pc-rank{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.2);border-radius:10px;padding:3px 10px;font-size:12px;font-weight:800;color:#fff;margin-top:3px;}
.user-pc-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;}
.user-pc-stat{background:rgba(0,0,0,.12);border-radius:10px;padding:8px;text-align:center;}
.user-pc-stat-n{font-family:'Lilita One',cursive;font-size:18px;color:#FFE100;}
.user-pc-stat-l{font-size:9px;color:rgba(255,255,255,.75);font-weight:700;}
.sett-sec{font-family:'Lilita One',cursive;font-size:11px;color:var(--sub);letter-spacing:.8px;text-transform:uppercase;padding:0 2px 7px;}
.sett-group{background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 3px 8px rgba(0,0,0,.07);margin-bottom:15px;border:2px solid rgba(255,200,0,.1);}
.sett-row{display:flex;align-items:center;padding:11px 13px;border-bottom:1.5px solid rgba(0,0,0,.05);cursor:pointer;}
.sett-row:last-child{border-bottom:none;}
.sett-row:active{background:rgba(255,200,0,.07);}
.sett-ico{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;margin-right:10px;}
.sett-label{font-size:13px;font-weight:700;color:var(--text);flex:1;}
.sett-val{font-size:10px;color:var(--sub);margin-top:1px;}
.sett-arr{color:#ccc;font-size:14px;}
.toggle{width:42px;height:23px;background:#ddd;border-radius:12px;position:relative;cursor:pointer;transition:background .25s;flex-shrink:0;}
.toggle.on{background:linear-gradient(135deg,var(--a),var(--a2));}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:17px;height:17px;background:#fff;border-radius:50%;transition:transform .25s;box-shadow:0 2px 4px rgba(0,0,0,.2);}
.toggle.on::after{transform:translateX(19px);}
.theme-row{padding:10px 13px;border-bottom:1.5px solid rgba(0,0,0,.05);}
.tdot{width:28px;height:28px;border-radius:50%;cursor:pointer;border:3px solid transparent;display:inline-block;margin-right:8px;}
.tdot.on{border-color:#333;box-shadow:0 0 0 2px #fff;}
.badges-wrap{display:flex;flex-wrap:wrap;gap:6px;padding:10px 13px;}
.badge-chip{display:flex;align-items:center;gap:4px;background:var(--bg);border-radius:9px;padding:4px 9px;border:2px solid rgba(255,200,0,.15);}
.badge-chip.locked{opacity:.3;}
.hist-item{display:flex;align-items:center;gap:8px;padding:8px 13px;border-bottom:1px solid rgba(0,0,0,.04);cursor:pointer;}
.hist-item:last-child{border:none;}
.hist-thumb{width:30px;height:38px;border-radius:6px;overflow:hidden;background:#FFB300;flex-shrink:0;}

/* FEEDBACK + INBOX */
#pgFeedback{background:var(--bg);}
.fb-scr{flex:1;overflow-y:auto;padding:13px 13px 16px;}
.fb-scr::-webkit-scrollbar{width:0;}
.fb-form{background:var(--card);border-radius:17px;padding:14px;box-shadow:0 4px 12px rgba(0,0,0,.08);}
.fb-type-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px;}
.fb-type-btn{padding:9px 5px;border-radius:10px;border:2px solid rgba(255,200,0,.2);background:var(--bg);font-family:'Baloo 2',cursive;font-size:11px;font-weight:700;color:var(--text);cursor:pointer;text-align:center;}
.fb-type-btn.sel{background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;border-color:var(--a);box-shadow:0 3px 0 var(--s);}
.fb-lbl{font-size:11px;font-weight:800;color:var(--sub);margin-bottom:5px;}
.fb-input,.fb-textarea{width:100%;padding:9px 12px;border-radius:10px;border:2px solid rgba(255,200,0,.28);font-family:'Baloo 2',cursive;font-size:13px;font-weight:600;color:var(--text);background:var(--bg);outline:none;margin-bottom:10px;}
.fb-textarea{height:88px;resize:none;}
.fb-submit{width:100%;padding:12px;background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;border:none;border-radius:12px;font-family:'Lilita One',cursive;font-size:16px;box-shadow:0 5px 0 var(--s);cursor:pointer;}
#pgInbox{background:var(--bg);}
.inbox-scr{flex:1;overflow-y:auto;padding:13px;}
.inbox-scr::-webkit-scrollbar{width:0;}
.msg-item{background:var(--card);border-radius:13px;padding:12px 13px;margin-bottom:9px;border:2px solid rgba(255,200,0,.15);box-shadow:0 3px 8px rgba(0,0,0,.07);animation:cin .3s ease;}
.msg-item.from-dev{border-color:var(--a);}
.msg-reply{background:linear-gradient(135deg,rgba(255,107,0,.1),rgba(255,68,0,.07));border-radius:9px;padding:9px 11px;margin-top:8px;border-left:3px solid var(--a);}

/* DEV PANEL */
#pgDev{background:#12121e;}
.dev-hdr{background:linear-gradient(135deg,#1e1e30,#12121e);padding:10px 13px;display:flex;align-items:center;gap:9px;border-bottom:2px solid #333358;flex-shrink:0;}
.dev-hdr-t{font-family:'Lilita One',cursive;font-size:16px;color:#FFD700;flex:1;}
.dev-scr{flex:1;overflow-y:auto;padding:11px;}
.dev-scr::-webkit-scrollbar{width:0;}
.dev-sec{background:#1e1e30;border-radius:12px;border:1px solid #333358;margin-bottom:13px;overflow:hidden;}
.dev-sec-h{background:linear-gradient(135deg,var(--a),var(--a2));padding:8px 12px;font-family:'Lilita One',cursive;font-size:12px;color:#fff;display:flex;align-items:center;justify-content:space-between;}
.dev-sec-b{padding:10px;}
.dev-stat-g{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;}
.dev-stat{background:#12121e;border-radius:8px;padding:8px;text-align:center;}
.dev-stat-n{font-family:'Lilita One',cursive;font-size:20px;color:var(--a);}
.dev-stat-l{font-size:9px;color:#888;font-weight:700;}
.dev-cr{background:#12121e;border-radius:8px;padding:8px 10px;margin-bottom:6px;border:1px solid #333358;}
.dev-cn{font-size:11px;font-weight:800;color:#e8e0ff;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.dev-cm{font-size:9px;color:#888;margin-bottom:6px;}
.dev-btns{display:flex;flex-wrap:wrap;gap:3px;}
.dev-btn{padding:3px 8px;border-radius:6px;border:none;font-family:'Baloo 2',cursive;font-size:9px;font-weight:700;cursor:pointer;}
.dbe{background:#2d5a8e;color:#fff;}.dbh{background:#5a3a6e;color:#fff;}.dbp{background:#8e6a00;color:#fff;}
.dbn{background:#8e2a00;color:#fff;}.dbu{background:#1e3a1e;color:#adf;}.dbd{background:#8e1a1a;color:#fff;}.dbr{background:#2d7a3a;color:#fff;}
.dev-in{width:100%;padding:7px 10px;background:#12121e;color:#e8e0ff;border:1px solid #333358;border-radius:7px;font-family:'Baloo 2',cursive;font-size:12px;outline:none;margin-bottom:6px;}
.dev-sel{width:100%;padding:7px 10px;background:#12121e;color:#e8e0ff;border:1px solid #333358;border-radius:7px;font-family:'Baloo 2',cursive;font-size:12px;outline:none;margin-bottom:6px;}
.dev-add{width:100%;padding:9px;background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;border:none;border-radius:8px;font-family:'Lilita One',cursive;font-size:13px;cursor:pointer;box-shadow:0 3px 0 var(--s);}
.fb-mi{background:#12121e;border-radius:8px;padding:8px 10px;margin-bottom:7px;border:1px solid #333358;}
.dev-reply-wrap{margin-top:7px;display:flex;gap:5px;}
.dev-reply-in{flex:1;padding:5px 8px;background:#1e1e30;color:#e8e0ff;border:1px solid #444;border-radius:7px;font-family:'Baloo 2',cursive;font-size:11px;outline:none;}
.dev-reply-btn{padding:5px 10px;background:linear-gradient(135deg,#44BB44,#2E7D32);color:#fff;border:none;border-radius:7px;font-family:'Lilita One',cursive;font-size:11px;cursor:pointer;}
.dev-bk{width:100%;padding:9px;border:none;border-radius:8px;font-family:'Lilita One',cursive;font-size:12px;cursor:pointer;margin-bottom:6px;}
.dev-user-row{background:#12121e;border-radius:8px;padding:8px 10px;margin-bottom:6px;border:1px solid #333358;display:flex;align-items:center;gap:8px;}
.dev-tag{display:inline-block;padding:1px 6px;border-radius:5px;font-size:9px;font-weight:800;margin-right:4px;}

/* TOASTS & OVERLAYS */
#ovOpen{display:none;position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#FFD700,#FF8C00);flex-direction:column;align-items:center;justify-content:center;}
#ovOpen.show{display:flex;animation:fadeIn .25s ease;}
#cfLayer{position:fixed;inset:0;pointer-events:none;z-index:9990;overflow:hidden;}
.cf{position:absolute;border-radius:2px;animation:confettiFall linear forwards;}
#badgeToast{position:fixed;bottom:74px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#FFD700,#FF8C00);border-radius:13px;padding:10px 15px;display:none;align-items:center;gap:8px;box-shadow:0 5px 14px rgba(0,0,0,.22);z-index:9995;white-space:nowrap;}
#xpToast{position:fixed;top:72px;right:13px;background:#FFD700;border-radius:10px;padding:6px 11px;display:none;font-family:'Lilita One',cursive;font-size:14px;color:#CC2200;box-shadow:0 4px 9px rgba(0,0,0,.18);z-index:9995;animation:pop .4s ease;}
#lvlToast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#FFD700,#FF4400);border-radius:20px;padding:18px 24px;display:none;flex-direction:column;align-items:center;gap:7px;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:9996;text-align:center;}
#lvlToast.show{display:flex;animation:pop .5s ease;}
#maintScreen{display:none;position:fixed;inset:0;z-index:9997;background:linear-gradient(160deg,#FFD700,#FF6B00);flex-direction:column;align-items:center;justify-content:center;gap:13px;padding:28px;text-align:center;}
#maintScreen.show{display:flex;}
#pwModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:9998;align-items:center;justify-content:center;}
#pwModal.show{display:flex;}
.pw-box{background:#1e1e30;border-radius:17px;padding:24px;width:260px;text-align:center;border:2px solid #FFD700;animation:pop .3s ease;}
.pw-input{width:100%;padding:10px;background:#12121e;color:#e8e0ff;border:2px solid #FFD700;border-radius:10px;font-family:'Baloo 2',cursive;font-size:16px;text-align:center;letter-spacing:4px;outline:none;margin-bottom:11px;}
.pw-btns{display:flex;gap:7px;}
.pw-ok{flex:1;padding:9px;background:linear-gradient(135deg,#FF7700,#FF4400);color:#fff;border:none;border-radius:9px;font-family:'Lilita One',cursive;font-size:14px;cursor:pointer;}
.pw-cancel{padding:9px 13px;background:#333;color:#aaa;border:none;border-radius:9px;font-family:'Baloo 2',cursive;font-size:12px;cursor:pointer;}

/* ARCADE PAGE */
#pgArcade{background:var(--bg);}
.arcade-tabs{display:flex;background:var(--card);border-bottom:2px solid rgba(255,200,0,.2);flex-shrink:0;overflow-x:auto;}
.arcade-tabs::-webkit-scrollbar{width:0;height:0;}
.arc-tab{flex-shrink:0;padding:10px 16px 9px;font-family:'Lilita One',cursive;font-size:13px;color:#aaa;background:transparent;border:none;cursor:pointer;white-space:nowrap;position:relative;}
.arc-tab.on{color:var(--tab);}
.arc-tab.on::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:var(--tab);border-radius:3px 3px 0 0;}
.arc-scr{flex:1;overflow-y:auto;}
.arc-scr::-webkit-scrollbar{width:0;}

/* EMULATOR */
#pgEmulator{background:#0a0a1a;}
.emu-wrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;gap:14px;}
.emu-drop{background:rgba(255,215,0,.05);border:2px dashed rgba(255,215,0,.4);border-radius:16px;padding:32px 20px;text-align:center;cursor:pointer;width:100%;max-width:360px;}
.emu-drop:hover{background:rgba(255,215,0,.1);}
#emuContainer{width:100%;max-width:500px;display:none;}
#emuContainer iframe{width:100%;height:350px;border:3px solid #FFD700;border-radius:8px;}
.free-roms-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;width:100%;max-width:400px;}
.rom-card{background:#1e1e30;border-radius:12px;padding:12px 10px;text-align:center;border:1.5px solid #333358;cursor:pointer;}
.rom-card:active{transform:scale(.95);}
.rom-ico{font-size:28px;margin-bottom:4px;}
.rom-name{font-size:11px;font-weight:800;color:#e8e0ff;margin-bottom:3px;}
.rom-genre{font-size:9px;color:#888;font-weight:600;}


/* RETRO EMULATOR PAGE */
#pgRetro{background:#0d0d0d;}
.retro-hdr{background:linear-gradient(135deg,#1a1a2e,#16213e);padding:9px 12px;display:flex;align-items:center;gap:9px;border-bottom:2px solid #FFD700;flex-shrink:0;}
.retro-scr{flex:1;overflow-y:auto;background:#0d0d0d;}
.retro-scr::-webkit-scrollbar{width:0;}
/* System selector */
.sys-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:13px;}
.sys-card{background:#1a1a2e;border-radius:12px;padding:12px 8px;text-align:center;border:2px solid #2a2a4e;cursor:pointer;transition:all .15s;}
.sys-card:active{transform:scale(.93);}
.sys-card.sel{border-color:#FFD700;background:#2a2a1e;}
.sys-ico{font-size:30px;margin-bottom:5px;}
.sys-name{font-family:'Lilita One',cursive;font-size:11px;color:#e8e0ff;margin-bottom:2px;}
.sys-sub{font-size:9px;color:#888;}
/* ROM loader */
.rom-loader{background:#1a1a2e;border-radius:14px;margin:0 13px 13px;border:2px solid #2a2a4e;overflow:hidden;}
.rom-loader-hdr{background:linear-gradient(135deg,#FFD700,#FF8C00);padding:10px 13px;font-family:'Lilita One',cursive;font-size:14px;color:#fff;}
.rom-loader-body{padding:13px;}
.rom-drop-area{border:2px dashed #FFD700;border-radius:12px;padding:28px 16px;text-align:center;cursor:pointer;transition:background .2s;}
.rom-drop-area:hover{background:rgba(255,215,0,.07);}
.rom-drop-area:active{background:rgba(255,215,0,.15);}
/* Emulator screen */
#retroEmuWrap{display:none;flex-direction:column;background:#000;height:100%;}
#emujs-container{width:100%;flex:1;position:relative;background:#000;}
#emujs-container canvas{width:100%!important;height:100%!important;display:block;image-rendering:pixelated;}
/* Controls overlay */
.retro-ctrl-bar{background:#1a1a2e;border-top:2px solid #2a2a4e;padding:8px 10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;flex-shrink:0;}
.retro-ctrl-btn{padding:7px 12px;border-radius:9px;border:none;font-family:'Lilita One',cursive;font-size:12px;cursor:pointer;}
.rcb-pause{background:rgba(255,215,0,.15);color:#FFD700;border:1.5px solid #FFD700;}
.rcb-reset{background:rgba(255,68,0,.15);color:#FF4400;border:1.5px solid #FF4400;}
.rcb-save{background:rgba(0,255,100,.1);color:#00FF64;border:1.5px solid #00FF64;}
.rcb-load{background:rgba(0,180,255,.1);color:#00B4FF;border:1.5px solid #00B4FF;}
.rcb-full{background:rgba(255,255,255,.08);color:#ccc;border:1.5px solid #555;}
.rcb-eject{background:rgba(150,0,0,.2);color:#FF6666;border:1.5px solid #FF4444;}
/* Touch D-Pad */
.retro-dpad-wrap{background:#111;padding:10px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.dpad-cross{display:grid;grid-template-columns:1fr 1fr 1fr;gap:3px;width:130px;}
.dc-btn{height:42px;background:#222;border:1.5px solid #444;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;user-select:none;-webkit-user-select:none;}
.dc-btn:active,.dc-btn.pressed{background:#333;border-color:#FFD700;}
.dc-center{background:#1a1a1a;border-radius:50%;}
.retro-ab-wrap{display:flex;flex-direction:column;gap:8px;align-items:center;}
.retro-ab-row{display:flex;gap:10px;}
.ab-btn{width:48px;height:48px;border-radius:50%;border:3px solid;display:flex;align-items:center;justify-content:center;font-family:'Lilita One',cursive;font-size:16px;cursor:pointer;user-select:none;-webkit-user-select:none;}
.ab-btn:active,.ab-btn.pressed{opacity:.7;transform:scale(.93);}
.retro-menu-btns{display:flex;gap:7px;margin-top:4px;}
.menu-btn{padding:5px 10px;background:#1a1a1a;border:1.5px solid #444;color:#aaa;border-radius:7px;font-family:'Lilita One',cursive;font-size:10px;cursor:pointer;}
/* Recent ROMs */
.recent-list{padding:0 13px 13px;}
.recent-item{background:#1a1a2e;border-radius:10px;padding:10px 12px;margin-bottom:7px;display:flex;align-items:center;gap:10px;border:1.5px solid #2a2a4e;cursor:pointer;}
.recent-item:active{background:#2a2a3e;}
/* Loading screen */
#emuLoading{position:absolute;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:13px;z-index:10;}
.emu-load-bar{width:80%;height:6px;background:#1a1a2e;border-radius:3px;overflow:hidden;}
.emu-load-fill{height:100%;background:linear-gradient(90deg,#FFD700,#FF8C00);border-radius:3px;transition:width .3s;}


/* PROFILE EDIT MODAL */
.pedit-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:850;align-items:center;justify-content:center;}
.pedit-modal.open{display:flex;}
.pedit-box{background:var(--bg);border-radius:20px;padding:20px;width:310px;max-width:92vw;border:3px solid var(--bd);animation:pop .3s ease;}
.pedit-av-row{display:flex;justify-content:center;margin-bottom:14px;}
.pedit-av{width:70px;height:70px;border-radius:18px;background:linear-gradient(135deg,var(--a),var(--a2));display:flex;align-items:center;justify-content:center;font-size:38px;border:3px solid rgba(255,255,255,.4);cursor:pointer;}
.pedit-chars{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:10px 0 14px;}
.pedit-char{background:var(--card);border-radius:11px;padding:9px 5px;text-align:center;border:2.5px solid transparent;cursor:pointer;}
.pedit-char.sel{border-color:var(--a);background:rgba(255,107,0,.08);}
.pedit-char:active{transform:scale(.92);}

/* SKELETON LOADER */
.skel{background:linear-gradient(90deg,#eee 25%,#f5f5f5 50%,#eee 75%);background-size:200% 100%;animation:skelShimmer 1.5s infinite;border-radius:8px;}
body.dark .skel{background:linear-gradient(90deg,#1e1e30 25%,#2a2a40 50%,#1e1e30 75%);background-size:200% 100%;}
@keyframes skelShimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skel-card{height:200px;border-radius:14px;margin-bottom:10px;}
.skel-line{height:12px;border-radius:6px;margin-bottom:7px;}
.skel-line.short{width:60%;}

/* CONTACT PAGE */
#pgContact{background:var(--bg);}
.contact-scr{flex:1;overflow-y:auto;padding:13px 13px 20px;}
.contact-scr::-webkit-scrollbar{width:0;}
.contact-card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:12px;border:2px solid rgba(255,200,0,.12);box-shadow:0 3px 9px rgba(0,0,0,.08);}
.contact-method{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1.5px solid rgba(0,0,0,.05);cursor:pointer;}
.contact-method:last-child{border:none;}
.contact-method:active{opacity:.7;}
.cm-ico{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}

/* LANGUAGE TOGGLE */
.lang-row{display:flex;gap:7px;padding:10px 13px;border-bottom:1.5px solid rgba(0,0,0,.05);}
.lang-btn{flex:1;padding:8px;border-radius:10px;border:2.5px solid rgba(255,200,0,.2);background:var(--bg);font-family:'Baloo 2',cursive;font-size:12px;font-weight:800;color:var(--text);cursor:pointer;text-align:center;}
.lang-btn.on{background:linear-gradient(135deg,var(--a),var(--a2));color:#fff;border-color:var(--a);box-shadow:0 3px 0 var(--s);}

/* SHARE BUTTON */
.share-fab{position:fixed;bottom:74px;right:13px;width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--a),var(--a2));border:none;box-shadow:0 4px 12px rgba(255,107,0,.4);font-size:20px;cursor:pointer;z-index:40;display:flex;align-items:center;justify-content:center;transition:transform .15s;}
.share-fab:active{transform:scale(.88);}

/* NOTIF TOAST (local push-style) */
#pushToast{position:fixed;top:-80px;left:50%;transform:translateX(-50%);width:90%;max-width:340px;background:var(--card);border-radius:14px;padding:12px 14px;display:flex;align-items:center;gap:11px;box-shadow:0 6px 20px rgba(0,0,0,.22);z-index:9993;border-left:4px solid var(--a);transition:top .4s cubic-bezier(.175,.885,.32,1.275);}
#pushToast.show{top:14px;}

/* MUSIC PLAYER (hidden) */
#bgMusicBar{position:fixed;bottom:62px;left:0;right:0;height:0;overflow:hidden;transition:height .3s;background:linear-gradient(135deg,var(--a),var(--a2));z-index:45;}
#bgMusicBar.open{height:38px;}
.music-bar-inner{height:38px;display:flex;align-items:center;padding:0 14px;gap:10px;}

/* LANDSCAPE */
@media (orientation:landscape){
  #bNav{flex-direction:row;}
  .home-hdr,.app-hdr{padding:6px 14px;}
  .hero-img{height:100px;}
  .lib-grid,.all-grid,.games-grid,.learn-grid{grid-template-columns:1fr 1fr 1fr;}
  .lcard-thumb,.acard-thumb{height:110px;}
  .ttt-board{width:210px;}
  .ttt-cell{height:68px;font-size:30px;}
  .retro-dpad-wrap{padding:6px 10px;}
  .ab-btn{width:40px;height:40px;}
}


/* VIDEO SPLASH */
#pgSplash{background:#000;}


/* EMULATOR FULLSCREEN */
#retroEmuWrap{position:relative;}
#retroOverlay{opacity:1;}
#retroOverlay.hidden{opacity:0;pointer-events:none!important;}
#retroOverlay button{pointer-events:all!important;}
#emujs-container{touch-action:none;}
#emujs-container canvas,
#emujs-container iframe,
#EJS_player{
  width:100%!important;
  height:100%!important;
  max-width:100%!important;
  max-height:100%!important;
  display:block!important;
}
/* EmulatorJS built-in control bar  keep it, style it nicely */
.ejs_menu_bar{background:rgba(0,0,0,.8)!important;}
/* Portrait: game takes full height minus EJS controls */
@media (orientation:portrait){
  #retroEmuWrap{height:100vh;}
  #emujs-container{flex:1;}
}
@media (orientation:landscape){
  #retroEmuWrap{height:100vh;flex-direction:row;}
  #emujs-container{flex:1;height:100%;}
}


/* Hide EJS toolbar buttons that cover game */
.ejs_menu_bar, .ejs_menu, #ejs_menu_bar,
div[id*="ejs_menu"], div[class*="ejs_menu"],
.ejs_bar, #ejs_bar {
  display:none!important;
  height:0!important;
  overflow:hidden!important;
}
/* Make game canvas fill entire container */
#EJS_player {
  width:100%!important;
  height:100%!important;
  position:absolute!important;
  inset:0!important;
}
#EJS_player canvas,
#EJS_player iframe,
#EJS_player video {
  width:100%!important;
  height:100%!important;
  object-fit:contain!important;
  display:block!important;
}
/* Portrait  full screen */
@media (orientation:portrait){
  #retroEmuWrap{height:100vh!important;}
  #emujs-container{
    position:fixed!important;
    inset:0!important;
    z-index:200!important;
    background:#000!important;
  }
  #retroOverlay{position:fixed!important;z-index:210!important;}
}
/* Landscape  full screen */
@media (orientation:landscape){
  #retroEmuWrap{height:100vh!important;flex-direction:column!important;}
  #emujs-container{
    position:fixed!important;
    inset:0!important;
    z-index:200!important;
    background:#000!important;
  }
  #retroOverlay{position:fixed!important;z-index:210!important;}
}

</style>
</head>
<body>
<!-- FIXED OVERLAYS -->
<div id="maintScreen"><div style="font-size:76px;animation:bounce 2s ease-in-out infinite"></div><div style="font-family:'Lilita One',cursive;font-size:24px;color:#CC2200;">Coming Soon!</div><div style="font-size:13px;color:#884400;font-weight:700;line-height:1.6;">Update in progress...<br>Please wait </div></div>
<div id="cfLayer"></div>
<div id="badgeToast" style="display:none;"><span id="btIco" style="font-size:24px"></span><div style="font-size:11px;font-weight:800;color:#CC2200" id="btTxt">New Badge!</div></div>
<div id="xpToast">+10 XP </div>
<div id="lvlToast"><div style="font-size:48px"></div><div style="font-family:'Lilita One',cursive;font-size:22px;color:#fff;" id="lvlTitle">Level Up!</div><div style="font-size:14px;color:rgba(255,255,255,.9);" id="lvlSub">New Rank!</div></div>
<div class="notif-ov" id="notifOv" onclick="closeNotif()"></div>
<div class="notif-panel" id="notifPanel">
  <div class="notif-hdr"><div style="font-family:'Lilita One',cursive;font-size:17px;color:#fff;"> Notifications</div><button class="notif-close" onclick="closeNotif()"></button></div>
  <div class="notif-list" id="notifList"></div>
</div>
<div id="favsOv" onclick="closeFavsOv(event)">
  <div class="favs-panel">
    <div class="favs-phdr"><div style="font-family:'Lilita One',cursive;font-size:19px;color:#fff;"> Favourites</div><button class="favs-px" onclick="closeFavsOv()"></button></div>
    <div class="favs-grid" id="favsGrid"></div>
  </div>
</div>
<div id="pwModal"><div class="pw-box"><div style="font-family:'Lilita One',cursive;font-size:18px;color:#FFD700;margin-bottom:5px;"> Dev Panel</div><div style="font-size:11px;color:#FF4444;min-height:15px;margin-bottom:5px;" id="pwErr"></div><input class="pw-input" type="password" id="pwIn" maxlength="20" placeholder="" onkeydown="if(event.key==='Enter')checkPw()"><div class="pw-btns"><button class="pw-cancel" onclick="closePwModal()">Cancel</button><button class="pw-ok" onclick="checkPw()">Enter</button></div></div></div>

<!-- SHARE FAB -->
<button class="share-fab ripple-wrap" onclick="addRipple(event,this);shareApp()" title="Share App" id="shareFab"></button>

<!-- PROFILE EDIT MODAL -->
<div class="pedit-modal" id="peditModal">
  <div class="pedit-box">
    <div style="font-family:'Lilita One',cursive;font-size:19px;color:var(--h1);text-align:center;margin-bottom:12px;"> Edit Profile</div>
    <div class="pedit-av-row"><div class="pedit-av" id="peditAv"></div></div>
    <input class="ob-input" type="text" id="peditName" placeholder="Your name..." maxlength="22" autocomplete="off" style="margin-bottom:10px;width:100%;">
    <div style="font-size:11px;font-weight:800;color:var(--sub);margin-bottom:8px;">Choose Character:</div>
    <div class="pedit-chars" id="peditChars"></div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button onclick="closePedit()" style="flex:1;padding:10px;background:var(--bg);border:2px solid rgba(255,200,0,.3);border-radius:12px;font-family:'Baloo 2',cursive;font-size:13px;font-weight:700;color:var(--sub);cursor:pointer;">Cancel</button>
      <button onclick="savePedit()" style="flex:2;padding:10px;background:linear-gradient(135deg,var(--a),var(--a2));border:none;border-radius:12px;font-family:'Lilita One',cursive;font-size:15px;color:#fff;box-shadow:0 4px 0 var(--s);cursor:pointer;">Save </button>
    </div>
  </div>
</div>

<!-- Player Setup Modal -->
<div id="playerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:700;align-items:center;justify-content:center;"><div class="modal-box" id="playerModalBox"></div></div>

<!-- SPLASH with VIDEO -->
<div id="pgSplash" class="page active" style="background:#000;overflow:hidden;position:relative;">
  <!-- VIDEO  frozen on first frame until tap -->
  <video id="splashVideo" playsinline
    style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1;pointer-events:none;"
    onended="onSplashVideoEnd()"
    onerror="onSplashVideoError()">
    <source src="./champak_intro.mp4" type="video/mp4">
    <source src="./champak_intro.webm" type="video/webm">
  </video>
  <!-- FALLBACK image -->
  <img id="splashFallback" src="./champak_splash.png" alt=""
    style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;display:none;pointer-events:none;">
  <!-- FULL SCREEN TAP LAYER  entire screen triggers start -->
  <div id="tapLayer" onclick="onTapStart()" ontouchend="onTapStart()"
    style="position:absolute;inset:0;z-index:99;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:14%;cursor:pointer;">
    <!-- Pulsing tap button (purely visual, tap layer handles the click) -->
    <div id="tapStartBtn" style="background:linear-gradient(180deg,#FFAA00,#FF6A00 55%,#E84500);color:#fff;font-family:'Baloo 2',cursive;font-size:24px;font-weight:800;border-radius:50px;padding:16px 48px;box-shadow:0 6px 0 #A03000;animation:btnGlow 2s ease-in-out infinite;pointer-events:none;">
       Tap to Start
    </div>
  </div>
</div>

<!-- ONBOARD -->
<div id="pgOnboard" class="page">
  <div class="ob-inner">
    <div style="font-size:66px;animation:bounce 2s ease-in-out infinite;"></div>
    <div class="ob-title">Welcome to Champak! </div>
    <div class="ob-sub">Enter your name and pick your character!</div>
    <input class="ob-input" type="text" id="nameIn" placeholder="Your name..." maxlength="22" autocomplete="off">
    <div class="char-lbl"> Choose Your Character:</div>
    <div class="char-grid" id="charGrid"></div>
    <button class="ob-btn ripple-wrap" onclick="addRipple(event,this);saveNameAndStart()">Let's Go! </button>
  </div>
</div>

<!-- HOME -->
<div id="pgHome" class="page">
  <div class="home-hdr">
    <div class="hdr-avatar ripple-wrap" id="logoTap" onclick="addRipple(event,this);tapLogo()"><span id="hdrChar"></span></div>
    <div style="flex:1;">
      <div class="hdr-uname" id="hdrName">Player</div>
      <div class="hdr-rank" id="hdrRank"> Beginner</div>
    </div>
    <button class="hdr-btn ripple-wrap" onclick="addRipple(event,this);openFavsOv()" title="Favourites"></button>
    <button class="hdr-btn" id="notifBtn" onclick="openNotif()"><div class="notif-dot" id="notifDot" style="display:none;"></div></button>
    <button class="hdr-btn" id="refreshBtn" onclick="refreshPage()"></button>
  </div>
  <div class="ann-bar" id="annBar" style="display:none;"><span></span><span style="font-size:12px;font-weight:800;color:#fff;flex:1;" id="annTxt"></span><button class="ann-x" onclick="closeAnn()"></button></div>
  <div id="homeScroll">
    <div class="streak-bar"><div style="font-size:20px;" id="strkFire"></div><div style="flex:1;"><div style="font-size:12px;font-weight:800;color:var(--text);" id="strkTitle">Reading Streak</div><div style="font-size:10px;color:var(--sub);font-weight:600;" id="strkSub">Read today!</div></div><div><div style="font-size:10px;font-weight:800;color:var(--a);" id="xpLbl">0 XP</div><div class="xp-bar-bg"><div class="xp-bar-fill" id="xpFill" style="width:0%"></div></div></div></div>
    <div class="hero-banner" onclick="goComics('all')"><div class="hero-img"><img src="./champak_banner.png" alt="Champak" onerror="this.style.background='#FF9500'"></div><div class="hero-foot"><div style="font-size:12px;font-weight:800;color:#fff;"> Champak World!</div></div></div>
    <div class="cotd-wrap" id="cotdWrap"><div class="cotd-lbl"> Comic of the Day</div><div class="cotd-card" id="cotdCard"><div class="cotd-thumb"><img id="cotdImg" src="" alt="" onerror="this.style.display='none'"></div><div style="flex:1;"><div style="font-size:13px;font-weight:800;color:#fff;line-height:1.3;margin-bottom:3px;" id="cotdTitle">Loading...</div><div style="font-size:10px;color:rgba(255,255,255,.8);font-weight:700;" id="cotdSub"></div></div></div></div>
    <div class="search-wrap"><div class="search-bar"><span></span><input type="text" id="homeSearch" placeholder="Search comics..." oninput="doSearch(this.value)" autocomplete="off"></div></div>
    <div class="sec-hdr"><div class="sec-title"> Hindi Comics</div><button class="see-all" onclick="goComics('hi')">See All </button></div>
    <div class="lib-grid" id="libHi"></div>
    <div style="height:10px;"></div>
    <div class="sec-hdr"><div class="sec-title"> English Comics</div><button class="see-all" onclick="goComics('en')">See All </button></div>
    <div class="lib-grid" id="libEn"></div>
    <div style="height:8px;"></div>
  </div>
  <div id="bNav">
    <div class="nav-item" id="nav-home" data-active onclick="setNav('home');showPage('pgHome')"><div class="nav-ico act-ico"></div><div class="nav-label">Home</div></div>
    <div class="nav-item" id="nav-comics" onclick="setNav('comics');goComics('all')"><div class="nav-ico"></div><div class="nav-label">Comics</div><div class="nav-badge" id="newBadge" style="display:none">0</div></div>
    <div class="nav-item" id="nav-games" onclick="setNav('games');showPage('pgGames')"><div class="nav-ico"></div><div class="nav-label">Games</div></div>
    <div class="nav-item" id="nav-learn" onclick="setNav('learn');showPage('pgLearn')"><div class="nav-ico"></div><div class="nav-label">Learn</div></div>
    <div class="nav-item" id="nav-settings" onclick="setNav('settings');showPage('pgSettings');renderSettings()"><div class="nav-ico"></div><div class="nav-label">Settings</div></div>
  </div>
</div>

<!-- COMICS -->
<div id="pgSeeAll" class="page"><div class="app-hdr"><button class="hdr-back" onclick="showPage('pgHome');setNav('home')"></button><div style="flex:1"><div style="font-family:'Lilita One',cursive;font-size:18px;color:var(--h2);">Champak Comics</div><div style="font-size:9px;font-weight:700;color:var(--h3);" id="allCount"></div></div></div><div class="cat-tabs"><button class="cat-tab on" id="tab-all" onclick="switchTab('all')"> All</button><button class="cat-tab" id="tab-hi" onclick="switchTab('hi')"> Hindi</button><button class="cat-tab" id="tab-en" onclick="switchTab('en')"> English</button></div><div class="scr"><div class="all-grid" id="allGrid"></div></div></div>

<!-- GAMES HUB -->
<div id="pgGames" class="page"><div class="app-hdr"><button class="hdr-back" onclick="showPage('pgHome');setNav('home')"></button><div style="flex:1"><div style="font-family:'Lilita One',cursive;font-size:19px;color:var(--h2);"> Games</div><div style="font-size:9px;font-weight:700;color:var(--h3);">Play games, earn XP!</div></div></div><div class="scr" style="padding:13px;"><div class="games-grid" style="grid-template-columns:1fr;">
<div class="game-card" style="animation-delay:.0s;background:linear-gradient(135deg,#1a0533,#2d0a5a);border-color:#6B21A8;">
  <div class="game-ico"></div>
  <div class="game-title" style="color:#E879F9;font-size:22px;">Retro Emulator</div>
  <div class="game-sub" style="color:#C084FC;font-size:12px;margin-top:4px;">NES  SNES  Sega Genesis<br>Load any ROM and play!</div>
  <button class="game-btn ripple-wrap" style="background:linear-gradient(135deg,#9333EA,#6B21A8);box-shadow:0 3px 0 #4C1D95;margin-top:12px;padding:12px;" onclick="addRipple(event,this);showPage('pgArcade')"> Launch Emulator</button>
</div>
</div></div></div>

<!-- SNAKE LADDER -->
<div id="pgLearn" class="page"><div class="app-hdr"><button class="hdr-back" onclick="showPage('pgHome');setNav('home')"></button><div style="flex:1"><div style="font-family:'Lilita One',cursive;font-size:19px;color:var(--h2);"> Learn Zone</div><div style="font-size:9px;font-weight:700;color:var(--h3);">Learn, play, earn!</div></div></div><div class="learn-scr"><div class="age-title"> Little Learners (47 years)</div><div class="learn-grid" id="lg1"></div><div class="age-title"> Smart Kids (610 years)</div><div class="learn-grid" id="lg2"></div></div></div>

<!-- TOPIC PAGE -->
<div id="pgTopic" class="page"><div class="app-hdr"><button class="hdr-back" onclick="showPage('pgLearn')"></button><div style="flex:1"><div style="font-family:'Lilita One',cursive;font-size:17px;color:var(--h2);" id="topicTitle">Learn</div></div></div><div class="topic-scr"><div class="lrn-grid" id="topicGrid"></div><button class="quiz-start ripple-wrap" onclick="addRipple(event,this);startQuiz()"> Take Quiz!</button></div></div>

<!-- QUIZ -->
<div id="pgQuiz" class="page"><div class="app-hdr"><button class="hdr-back" onclick="showPage('pgTopic')"></button><div style="flex:1"><div style="font-family:'Lilita One',cursive;font-size:17px;color:var(--h2);"> Quiz Time!</div></div></div><div class="quiz-wrap" id="quizWrap"></div></div>

<!-- LEADERBOARD -->
<div id="pgLeaderboard" class="page"><div class="app-hdr"><button class="hdr-back" onclick="showPage('pgSettings')"></button><div style="flex:1"><div style="font-family:'Lilita One',cursive;font-size:18px;color:var(--h2);"> Leaderboard</div><div style="font-size:9px;font-weight:700;color:var(--h3);" id="lbStatus">Global rankings</div></div><button class="hdr-btn" onclick="loadLeaderboard(true)"></button></div><div class="lb-scr" id="lbScr"></div></div>

<!-- SETTINGS -->
<div id="pgSettings" class="page">
  <div class="app-hdr"><button class="hdr-back" onclick="showPage('pgHome');setNav('home')"></button><div style="flex:1"><div style="font-family:'Lilita One',cursive;font-size:18px;color:var(--h2);"> Settings</div></div></div>
  <div class="sett-scr">
    <div class="user-profile-card">
      <div class="user-pc-top">
        <div class="user-pc-av" id="settAv"></div>
        <div><div class="user-pc-name" id="settName">Player</div><div class="user-pc-rank" id="settRank"> Beginner</div></div>
      </div>
      <button onclick="openPedit()" style="width:100%;padding:8px;background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.35);border-radius:10px;font-family:'Lilita One',cursive;font-size:13px;color:#fff;cursor:pointer;margin-bottom:11px;"> Edit Profile</button>
    <div class="user-pc-stats">
        <div class="user-pc-stat"><div class="user-pc-stat-n" id="settXP">0</div><div class="user-pc-stat-l">XP</div></div>
        <div class="user-pc-stat"><div class="user-pc-stat-n" id="settStreak">0</div><div class="user-pc-stat-l">Day Streak</div></div>
        <div class="user-pc-stat"><div class="user-pc-stat-n" id="settReads">0</div><div class="user-pc-stat-l">Comics Read</div></div>
      </div>
    </div>
    <div class="sett-sec"> Appearance</div>
    <div class="sett-group">
      <div class="lang-row" id="langRow"><button class="lang-btn on" id="lang-en" onclick="setLang('en',this)"> English</button><button class="lang-btn" id="lang-hi" onclick="setLang('hi',this)"> </button></div>
      <div class="sett-row" onclick="toggleMusic()"><div class="sett-ico" style="background:#FFF0F8"></div><div style="flex:1"><div class="sett-label" id="musicLabel">Background Music</div><div class="sett-val" id="musicVal">Tap to play kids BGM</div></div><div class="toggle" id="musicToggleEl"></div></div>
      <div class="sett-row" onclick="toggleDark()"><div class="sett-ico" style="background:#1a1a2e"></div><div style="flex:1"><div class="sett-label">Dark Mode</div></div><div class="toggle" id="darkToggle"></div></div>
      <div class="sett-row" onclick="toggleSound()"><div class="sett-ico" style="background:#FFF0E0"></div><div style="flex:1"><div class="sett-label">Sound Effects</div></div><div class="toggle on" id="soundToggle"></div></div>
      <div class="theme-row"><div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:7px;"> Colour Theme</div><div><span class="tdot on" id="td-orange" style="background:linear-gradient(135deg,#FFD700,#FF6B00)" onclick="setTheme('orange')"></span><span class="tdot" id="td-blue" style="background:linear-gradient(135deg,#4FC3F7,#1565C0)" onclick="setTheme('blue')"></span><span class="tdot" id="td-green" style="background:linear-gradient(135deg,#A5D6A7,#2E7D32)" onclick="setTheme('green')"></span><span class="tdot" id="td-purple" style="background:linear-gradient(135deg,#CE93D8,#6A1B9A)" onclick="setTheme('purple')"></span><span class="tdot" id="td-pink" style="background:linear-gradient(135deg,#F48FB1,#C2185B)" onclick="setTheme('pink')"></span></div></div>
    </div>
    <div class="sett-sec"> Rank & Progress</div>
    <div class="sett-group"><div id="rankProgressWrap" style="padding:13px;"></div></div>
    <div class="sett-sec"> Global Leaderboard</div>
    <div class="sett-group">
      <div class="sett-row" onclick="showPage('pgLeaderboard');loadLeaderboard()"><div class="sett-ico" style="background:#FFF9E6"></div><div style="flex:1"><div class="sett-label">Leaderboard</div><div class="sett-val" id="lbRankHint">See where you rank globally</div></div><div class="sett-arr"></div></div>
    </div>
    <div class="sett-sec"> Badges</div><div class="sett-group"><div class="badges-wrap" id="badgesWrap"></div></div>
    <div class="sett-sec"> Reading History</div><div class="sett-group" id="histList"></div>
    <div class="sett-sec"> App Info</div>
    <div class="sett-group">
      <div class="sett-row"><div class="sett-ico" style="background:#FFF3CD"></div><div style="flex:1"><div class="sett-label">Version</div><div class="sett-val">v5.0  Latest </div></div></div>
      <div class="sett-row"><div class="sett-ico" style="background:#FFE0E0"></div><div style="flex:1"><div class="sett-label">Total Comics</div><div class="sett-val" id="settTotal"></div></div></div>
      <div class="sett-row"><div class="sett-ico" style="background:#E0FFE8"></div><div style="flex:1"><div class="sett-label">Kid Safe</div><div class="sett-val">100% Ad-free</div></div><div class="sett-arr" style="color:#22aa44"></div></div>
    </div>
    <div class="sett-sec"> Feedback & Messages</div>
    <div class="sett-group">
      <div class="sett-row" onclick="showPage('pgFeedback')"><div class="sett-ico" style="background:#FFF0E0"></div><div style="flex:1"><div class="sett-label">Send Feedback</div><div class="sett-val">Ideas, bugs, comic requests</div></div><div class="sett-arr"></div></div>
      <div class="sett-row" onclick="showPage('pgInbox');renderInbox()"><div class="sett-ico" style="background:#E8F5E9"></div><div style="flex:1"><div class="sett-label">My Inbox</div><div class="sett-val" id="inboxCount">Dev replies will appear here</div></div><div class="sett-arr"></div></div>
    <div class="sett-row" onclick="showPage('pgContact')"><div class="sett-ico" style="background:#E3F2FD"></div><div style="flex:1"><div class="sett-label">Contact & Support</div><div class="sett-val">FAQ, feedback, share app</div></div><div class="sett-arr"></div></div>
    </div>
    <div class="sett-sec"> About</div>
    <div class="sett-group">
      <div class="sett-row"><div class="sett-ico" style="background:#FFF0E0"></div><div style="flex:1"><div class="sett-label">Developed by</div><div class="sett-val">Baadal  Made with </div></div></div>
      <div style="flex:1"></div><div class="sett-arr"></div></div>
    </div>
    <div style="text-align:center;padding:9px 0 4px;color:#bbb;font-size:10px;font-weight:700;">Made with  by Baadal  v5.0</div>
  </div>
</div>

<!-- INBOX PAGE -->
<div id="pgInbox" class="page"><div class="app-hdr"><button class="hdr-back" onclick="showPage('pgSettings')"></button><div style="flex:1"><div style="font-family:'Lilita One',cursive;font-size:18px;color:var(--h2);"> My Inbox</div><div style="font-size:9px;font-weight:700;color:var(--h3);">Developer replies</div></div></div><div class="inbox-scr" id="inboxScr"></div></div>

<!-- FEEDBACK -->
<div id="pgFeedback" class="page"><div class="app-hdr"><button class="hdr-back" onclick="showPage('pgSettings')"></button><div style="flex:1"><div style="font-family:'Lilita One',cursive;font-size:17px;color:var(--h2);"> Feedback</div></div></div>
<div class="fb-scr"><div style="background:linear-gradient(135deg,#E8F5E9,#C8E6C9);border-radius:12px;padding:10px 12px;margin-bottom:11px;display:flex;align-items:center;gap:8px;border:2px solid #81C784;"><div style="font-size:22px"></div><div><div style="font-size:11px;font-weight:800;color:#1B5E20;">100% In-App  No Links!</div><div style="font-size:10px;color:#388E3C;font-weight:600;margin-top:1px;">Message goes to developer's panel  Reply comes to your inbox!</div></div></div>
  <div class="fb-form"><div class="fb-lbl"> Type:</div><div class="fb-type-grid" id="fbTypeGrid"><button class="fb-type-btn sel" onclick="selectFbType(this,'idea')"> Feature Idea</button><button class="fb-type-btn" onclick="selectFbType(this,'bug')"> Report Bug</button><button class="fb-type-btn" onclick="selectFbType(this,'msg')"> General Msg</button><button class="fb-type-btn" onclick="selectFbType(this,'request')"> Comic Request</button></div>
  <div class="fb-lbl"> Message</div><textarea class="fb-textarea" id="fbMsg" placeholder="Write here..."></textarea>
  <button class="fb-submit ripple-wrap" onclick="addRipple(event,this);submitFeedback()"> Send!</button>
  <div style="text-align:center;margin-top:8px;font-size:10px;color:#aaa;font-weight:600;"> No email   In-app only   Reply in inbox</div></div>
</div></div>

<!-- DEV PANEL -->
<div id="pgDev" class="page"><div class="dev-hdr"><button style="background:rgba(255,255,255,.1);border:1px solid #555;color:#aaa;width:30px;height:30px;border-radius:7px;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;" onclick="showPage('pgHome');setNav('home')"></button><div class="dev-hdr-t"> Dev Panel v5</div><button style="background:rgba(255,100,0,.2);border:1px solid #FF6B00;color:#FF6B00;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;" onclick="devLock()"> Lock</button></div>
<div class="dev-scr">
  <div class="dev-sec"><div class="dev-sec-h"> Live Stats</div><div class="dev-sec-b"><div class="dev-stat-g" id="devStats"></div><div id="devTop3" style="margin-top:9px;"></div></div></div>
  <div class="dev-sec"><div class="dev-sec-h"> All Users <span id="devUserCount" style="font-size:10px;opacity:.8;"></span></div><div class="dev-sec-b" id="devUserList"></div></div>
  <div class="dev-sec"><div class="dev-sec-h"> Add Comic</div><div class="dev-sec-b"><input class="dev-in" id="daN" placeholder="Comic name..."><input class="dev-in" id="daU" placeholder="FlipHTML5 URL..."><select class="dev-sel" id="daL"><option value="hi"> Hindi</option><option value="en"> English</option></select><input class="dev-in" id="daD" placeholder="Date (Jan 2024)"><input class="dev-in" id="daP" placeholder="Pages" type="number"><button class="dev-add" onclick="devAdd()"> Add Comic</button></div></div>
  <div class="dev-sec"><div class="dev-sec-h"> Manage Comics <span id="devCC" style="font-size:10px;opacity:.8;"></span></div><div class="dev-sec-b" id="devComics"></div></div>
  <div class="dev-sec"><div class="dev-sec-h"> Announcement</div><div class="dev-sec-b"><textarea class="dev-in" id="devAnnTxt" style="height:60px;resize:none;" placeholder="Announcement..."></textarea><input class="dev-in" id="devAnnExp" placeholder="Expiry date (e.g. 2024-12-31)  optional"><div style="display:flex;gap:6px;"><button class="dev-add" style="flex:1;" onclick="devSaveAnn()"> Save</button><button class="dev-add" style="flex:1;background:#8e1a1a;" onclick="devHideAnn()"> Hide</button></div></div></div>
  <div class="dev-sec"><div class="dev-sec-h"> Controls</div><div class="dev-sec-b">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;"><div><div style="font-size:12px;font-weight:700;color:#e8e0ff;">Maintenance Mode</div></div><div class="toggle" id="devMaintT" onclick="devToggleMaint()"></div></div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <button class="dev-btn dbe" style="padding:6px 10px;" onclick="devResetAllXP()"> Reset All XP</button>
      <button class="dev-btn dbh" style="padding:6px 10px;" onclick="devClearNotifs()"> Clear Notifs</button>
      <button class="dev-btn dbr" style="padding:6px 10px;" onclick="devClearLB()"> Clear Leaderboard</button>
    </div>
  </div></div>
  <div class="dev-sec"><div class="dev-sec-h"> Feedback & Reply <span id="devFbC" style="font-size:10px;opacity:.8;"></span><button style="background:rgba(255,255,255,.15);border:none;color:#fff;padding:2px 6px;border-radius:5px;font-size:9px;cursor:pointer;margin-left:4px;" onclick="devClearFb()">Clear</button></div><div class="dev-sec-b" id="devFbList"></div></div>
  <div class="dev-sec"><div class="dev-sec-h"> Backup & Restore</div><div class="dev-sec-b"><button class="dev-bk" style="background:linear-gradient(135deg,#1565C0,#0D47A1);color:#fff;" onclick="devBackup()"> Export JSON</button><textarea class="dev-in" id="devRI" style="height:65px;resize:none;" placeholder="Paste JSON to restore..."></textarea><button class="dev-bk" style="background:linear-gradient(135deg,#2E7D32,#1B5E20);color:#fff;" onclick="devRestore()"> Restore</button></div></div>
  <div class="dev-sec"><div class="dev-sec-h"> Change Password</div><div class="dev-sec-b"><input class="dev-in" type="password" id="devP1" placeholder="New password..."><input class="dev-in" type="password" id="devP2" placeholder="Confirm..."><button class="dev-add" onclick="devChangePass()"> Update</button></div></div>
</div></div>


<!-- ARCADE HUB -->
<div id="pgArcade" class="page">
  <div class="app-hdr">
    <button class="hdr-back" onclick="showPage('pgGames')"></button>
    <div style="flex:1"><div style="font-family:'Lilita One',cursive;font-size:19px;color:var(--h2);"> Arcade Zone</div><div style="font-size:9px;font-weight:700;color:var(--h3);">NES  SNES  Sega Genesis Emulator</div></div>
  </div>
  <div class="arcade-tabs">
    
    <button class="arc-tab on" id="atab-emu" onclick="switchArcadeTab('emu',this)"> Emulator</button>
    <button class="arc-tab" id="atab-free" onclick="switchArcadeTab('free',this)"> Free ROMs</button>
  </div>
  <div class="arc-scr" id="arcScr">
    <!-- Built-in tab (default) -->
    <div id="arcBuilt" style="display:none;"></div>
    <!-- Emulator tab  launches full RetroArch-style page -->
    <div id="arcEmu" style="display:block;padding:13px;">
      <div style="background:#1a1a2e;border-radius:14px;padding:16px;border:2px solid #2a2a4e;text-align:center;">
        <div style="font-size:52px;margin-bottom:10px;"></div>
        <div style="font-family:'Lilita One',cursive;font-size:20px;color:#FFD700;margin-bottom:6px;">RetroArch-Style Emulator</div>
        <div style="font-size:12px;color:#aaa;line-height:1.7;margin-bottom:14px;">Supports NES  SNES  GBA  Sega  N64<br>Full touch controls  Save states  Multiple systems<br><span style="color:#888;font-size:10px;">Load your own ROM file from your phone</span></div>
        <button onclick="showPage('pgRetro');retroInit()" style="width:100%;padding:14px;background:linear-gradient(135deg,#FFD700,#FF8C00);border:none;border-radius:13px;font-family:'Lilita One',cursive;font-size:18px;color:#fff;box-shadow:0 5px 0 #CC6000;cursor:pointer;"> Launch Emulator</button>
      </div>
      <div style="background:#1a1a2e;border-radius:12px;padding:12px;margin-top:11px;border:1.5px solid #2a2a4e;">
        <div style="font-size:11px;color:#888;line-height:1.8;"> Emulator is open-source (EmulatorJS)<br> You load your own ROM  you control it<br> Same approach as RetroArch, Delta, etc.<br> No ROMs stored or distributed by this app</div>
      </div>
    </div>
    <!-- Free ROMs tab -->
    <div id="arcFree" style="display:none;padding:13px;">
      <div style="background:#1e1e30;border-radius:12px;padding:12px;margin-bottom:12px;border:1px solid #333358;">
        <div style="font-family:'Lilita One',cursive;font-size:14px;color:#FFD700;margin-bottom:5px;"> 100% Free & Legal Homebrew NES Games</div>
        <div style="font-size:11px;color:#aaa;line-height:1.6;">These games were made by indie developers and released free. Click to download ROM, then load it in the Emulator tab above!</div>
      </div>
      <div class="free-roms-grid" id="freeRomsGrid"></div>
      <div style="margin-top:13px;background:#1e1e30;border-radius:12px;padding:12px;border:1px solid #333358;">
        <div style="font-family:'Lilita One',cursive;font-size:13px;color:#FFD700;margin-bottom:6px;"> More Free Legal Games</div>
        <div style="font-size:11px;color:#aaa;line-height:1.8;">
          <div> <span style="color:#4FC3F7;">pdroms.de/nintendo-nes</span>  500+ homebrew games</div>
          <div> <span style="color:#4FC3F7;">nesworld.com</span>  demos and homebrew</div>
          <div> <span style="color:#4FC3F7;">gbatemp.net</span>  community ROMs</div>
          <div style="margin-top:6px;font-size:10px;color:#666;"> Never download copyrighted commercial ROMs (Mario, Zelda etc)</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- RETROARCH-STYLE EMULATOR PAGE -->
<div id="pgRetro" class="page">
  <!-- SYSTEM SELECT VIEW -->
  <div id="retroSelectView" style="display:flex;flex-direction:column;height:100%;background:#0d0d0d;">
    <div class="retro-hdr">
      <button class="hdr-back" style="background:rgba(255,215,0,.15);border:2px solid rgba(255,215,0,.3);color:#FFD700;" onclick="retroEject();showPage('pgArcade')"></button>
      <div style="flex:1">
        <div style="font-family:'Lilita One',cursive;font-size:17px;color:#FFD700;"> Retro Emulator</div>
        <div style="font-size:9px;color:#888;font-weight:700;" id="retroStatusTxt">Select system & load ROM</div>
      </div>
      <button onclick="retroShowRecent()" style="background:rgba(255,215,0,.15);border:1.5px solid #FFD700;color:#FFD700;padding:5px 10px;border-radius:8px;font-family:'Lilita One',cursive;font-size:11px;cursor:pointer;"> Recent</button>
    </div>
    <div class="retro-scr">
      <!-- System grid -->
      <div style="padding:12px 13px 4px;font-family:'Lilita One',cursive;font-size:12px;color:#888;">SELECT SYSTEM</div>
      <div class="sys-grid" id="sysGrid"></div>
      <!-- ROM Loader -->
      <div class="rom-loader">
        <div class="rom-loader-hdr"> Load ROM File</div>
        <div class="rom-loader-body">
          <div style="font-size:11px;color:#aaa;margin-bottom:11px;line-height:1.6;">Select a ROM file from your device. Supports .nes .sfc .gba .gb .gbc .smd .z64 .n64 and more.</div>
          <label class="rom-drop-area" for="retroRomFile">
            <div style="font-size:44px;margin-bottom:8px;"></div>
            <div style="font-family:'Lilita One',cursive;font-size:16px;color:#FFD700;margin-bottom:4px;">Tap to choose ROM</div>
            <div style="font-size:10px;color:#888;">Any ROM file from your phone storage</div>
            <input type="file" id="retroRomFile" style="display:none;" accept=".nes,.sfc,.smc,.smd,.gen,.md" onchange="retroLoadFile(this)">
          </label>
          <div id="retroLoadStatus" style="margin-top:9px;text-align:center;font-size:11px;color:#888;">No file loaded</div>
        </div>
      </div>
      <!-- Recent ROMs -->
      <div id="retroRecentWrap" style="display:none;">
        <div style="padding:8px 13px 4px;font-family:'Lilita One',cursive;font-size:12px;color:#888;">RECENT ROMS</div>
        <div class="recent-list" id="retroRecentList"></div>
      </div>
      <!-- System info -->
      <div id="retroSysInfo" style="display:none;background:#1a1a2e;border-radius:12px;margin:0 13px 13px;padding:12px;border:1.5px solid #2a2a4e;">
        <div style="font-family:'Lilita One',cursive;font-size:13px;color:#FFD700;margin-bottom:6px;" id="retroSysTitle">System Info</div>
        <div style="font-size:11px;color:#aaa;line-height:1.7;" id="retroSysDesc"></div>
      </div>
    </div>
  </div>

  <!-- GAME RUNNING VIEW -->
  <div id="retroEmuWrap" style="display:none;flex-direction:column;height:100%;background:#000;">
    <!-- Floating minimal overlay  auto-hides after 3s, tap game to show again -->
    <div id="retroOverlay" style="position:absolute;top:0;left:0;right:0;z-index:20;display:flex;align-items:center;gap:6px;padding:6px 8px;background:linear-gradient(180deg,rgba(0,0,0,.7),transparent);transition:opacity .4s;pointer-events:none;">
      <button onclick="retroEject()" style="background:rgba(255,68,0,.6);border:none;color:#fff;padding:5px 10px;border-radius:8px;font-family:'Lilita One',cursive;font-size:11px;cursor:pointer;pointer-events:all;"> Exit</button>
      <div style="flex:1;font-family:'Lilita One',cursive;font-size:11px;color:#FFD700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" id="retroGameTitle">Game</div>
      <button onclick="retroSaveState()" style="background:rgba(0,255,100,.5);border:none;color:#fff;padding:5px 9px;border-radius:8px;font-family:'Lilita One',cursive;font-size:11px;cursor:pointer;pointer-events:all;"></button>
      <button onclick="retroFullscreen()" style="background:rgba(255,255,255,.3);border:none;color:#fff;padding:5px 9px;border-radius:8px;font-family:'Lilita One',cursive;font-size:11px;cursor:pointer;pointer-events:all;"></button>
    </div>
    <!-- Game canvas -->
    <div id="emujs-container" style="flex:1;position:relative;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden;" onclick="retroShowOverlay()">
      <div id="emuLoading">
        <div style="font-size:48px;animation:bounce 1s ease-in-out infinite;"></div>
        <div style="font-family:'Lilita One',cursive;font-size:18px;color:#FFD700;" id="emuLoadTxt">Loading...</div>
        <div class="emu-load-bar"><div class="emu-load-fill" id="emuLoadFill" style="width:0%"></div></div>
        <div style="font-size:10px;color:#888;margin-top:4px;" id="emuLoadSub">Initializing emulator</div>
      </div>
    </div>

  </div>
</div>
</div>

<!-- OPEN COMIC OVERLAY -->
<div id="ovOpen"><div style="font-size:62px"></div><div style="font-family:'Baloo 2',cursive;font-size:21px;font-weight:800;color:#CC3300;margin-top:13px;">Opening Comic!</div><div style="font-size:12px;color:#884400;margin-top:4px;font-weight:700;">One moment...</div></div>
<script>
// 
//  CHAMPAK COMICS v5  FULL JAVASCRIPT
// 

//  JSONBIN CONFIG (free, zero-setup leaderboard) 
var JBIN_KEY = '$2a$10$dummyKeyReplacedAtRuntime'; // will try public bin
var JBIN_BIN_ID = ''; // auto-created on first run
var LB_CACHE = [];
var LB_LOADED = false;

//  DATA 
var DC=[{id:1,name:"Champak Hindi - Sep 2019",lang:"hi",isNew:false,isPinned:false,isHidden:false,flipUrl:"https://online.fliphtml5.com/ufmtz/dtjr/",pages:50,date:"Sep 2019"}];
var COMICS=[],FB=[],STATS={},FAVS=[],HIST=[],NOTIFS=[],REPLIES=[];
var U={name:'',avatar:'cheeku',theme:'orange',dark:false,sound:true};
var SK={last:'',count:0};
var XP=0,BADGES=[],ANN={active:false,text:'',expiry:''},MAINT=false;
var DEV_PW='1234',DEV_ON=false;
var LTAPS=0,LTIMER=null,CTAB='all',FBTYPE='idea';
var FIRST_TODAY=false,UID='';

var CHARS=[
  {id:'cheeku',name:'Cheeku',e:''},{id:'meeku',name:'Meeku',e:''},
  {id:'jumbo',name:'Jumbo',e:''},{id:'sheru',name:'Sheru',e:''},
  {id:'bhalu',name:'Bhalu',e:''},{id:'titu',name:'Titu',e:''},
  {id:'damru',name:'Damru',e:''},{id:'cheena',name:'Cheena',e:''}
];

var RANKS=[
  {min:0,title:'Beginner',ico:'',color:'#888888'},
  {min:100,title:'Reader',ico:'',color:'#4CAF50'},
  {min:250,title:'Explorer',ico:'',color:'#2196F3'},
  {min:500,title:'Champion',ico:'',color:'#FF9800'},
  {min:1000,title:'Legend',ico:'',color:'#9C27B0'},
  {min:2000,title:'Master',ico:'',color:'#FFD700'}
];

var BDEFS=[
  {id:'first',ico:'',name:'First Read',opens:1},
  {id:'reader',ico:'',name:'Book Worm',opens:5},
  {id:'super',ico:'',name:'Super Reader',opens:10},
  {id:'s3',ico:'',name:'3-Day Streak',streak:3},
  {id:'s7',ico:'',name:'Week Warrior',streak:7},
  {id:'xp100',ico:'',name:'XP Hunter',xp:100},
  {id:'xp500',ico:'',name:'XP King',xp:500},
  {id:'explorer',ico:'',name:'Explorer',both:true},
  {id:'fav5',ico:'',name:'Collector',fav:5}
];

//  FIXED Hindi Varnamala with correct emojis 
var TOPICS=[
  {id:'abc',title:'ABC Alphabet',ico:'',sub:'A to Z with pictures',age:1,col:'#FF6B00',
   items:[{e:'',w:'A',n:'Apple'},{e:'',w:'B',n:'Butterfly'},{e:'',w:'C',n:'Cat'},{e:'',w:'D',n:'Dog'},{e:'',w:'E',n:'Elephant'},{e:'',w:'F',n:'Frog'},{e:'',w:'G',n:'Giraffe'},{e:'',w:'H',n:'Horse'},{e:'',w:'I',n:'Ice Cream'},{e:'',w:'J',n:'Jar'},{e:'',w:'K',n:'Kangaroo'},{e:'',w:'L',n:'Lion'},{e:'',w:'M',n:'Monkey'},{e:'',w:'N',n:'Newspaper'},{e:'',w:'O',n:'Owl'},{e:'',w:'P',n:'Penguin'},{e:'',w:'Q',n:'Queen'},{e:'',w:'R',n:'Rabbit'},{e:'',w:'S',n:'Sun'},{e:'',w:'T',n:'Tiger'},{e:'',w:'U',n:'Umbrella'},{e:'',w:'V',n:'Violin'},{e:'',w:'W',n:'Whale'},{e:'',w:'X',n:'Xylophone'},{e:'',w:'Y',n:'Yarn'},{e:'',w:'Z',n:'Zebra'}]},

  // FIXED Hindi Varnamala  correct letter-emoji pairs
  {id:'hindi',title:'Hindi Varnamala',ico:'',sub:'   ',age:1,col:'#138808',
   items:[
     {e:'',w:'',n:' (Pomegranate)'},
     {e:'',w:'',n:' (Mango)'},
     {e:'',w:'',n:' (Prize)'},
     {e:'',w:'',n:' (Brick)'},
     {e:'',w:'',n:' (Camel)'},
     {e:'',w:'',n:' (Wool)'},
     {e:'',w:'',n:' (Eagle)'},
     {e:'',w:'',n:' (Tool)'},
     {e:'',w:'',n:' (Lotus)'},
     {e:'',w:'',n:' (Rabbit)'},
     {e:'',w:'',n:' (Cow)'},
     {e:'',w:'',n:' (House)'},
     {e:'',w:'',n:' (Moon)'},
     {e:'',w:'',n:' (Stick)'},
     {e:'',w:'',n:' (Jungle)'},
     {e:'',w:'',n:' (Waterfall)'},
     {e:'',w:'',n:' (Tomato)'},
     {e:'',w:'',n:' (Cold)'},
     {e:'',w:'',n:' (Drum)'},
     {e:'',w:'',n:' (Big Drum)'},
     {e:'',w:'',n:' (Cobra)'},
     {e:'',w:'',n:' (Kite)'},
     {e:'',w:'',n:' (Goat)'},
     {e:'',w:'',n:' (Fish)'},
     {e:'',w:'',n:' (King)'},
     {e:'',w:'',n:' (Lion)'}
   ]},

  {id:'animals',title:'Animals',ico:'',sub:'Animals and their names',age:1,col:'#4CAF50',
   items:[{e:'',w:'Lion',n:'Sher'},{e:'',w:'Tiger',n:'Bagh'},{e:'',w:'Elephant',n:'Haathi'},{e:'',w:'Giraffe',n:'Jiraf'},{e:'',w:'Zebra',n:'Zebra'},{e:'',w:'Bear',n:'Bhalu'},{e:'',w:'Fox',n:'Lomdi'},{e:'',w:'Wolf',n:'Bhediya'},{e:'',w:'Eagle',n:'Baaz'},{e:'',w:'Penguin',n:'Penguin'},{e:'',w:'Dolphin',n:'Dolphin'},{e:'',w:'Turtle',n:'Kachhua'},{e:'',w:'Butterfly',n:'Titli'},{e:'',w:'Bee',n:'Madhumakkhi'},{e:'',w:'Frog',n:'Mendhak'},{e:'',w:'Monkey',n:'Bandar'}]},

  {id:'flowers',title:'Flowers & Plants',ico:'',sub:'Beautiful nature',age:1,col:'#E91E63',
   items:[{e:'',w:'Rose',n:'Gulab'},{e:'',w:'Sunflower',n:'Surajmukhi'},{e:'',w:'Blossom',n:'Phool'},{e:'',w:'Hibiscus',n:'Gudhal'},{e:'',w:'Daisy',n:'Daisi'},{e:'',w:'Bouquet',n:'Guldasta'},{e:'',w:'Herb',n:'Jadi-buti'},{e:'',w:'Clover',n:'Teen Patti'},{e:'',w:'Cactus',n:'Cactus'},{e:'',w:'Palm',n:'Khajur'},{e:'',w:'Tree',n:'Ped'},{e:'',w:'Maple Leaf',n:'Patta'},{e:'',w:'Mushroom',n:'Khumb'},{e:'',w:'Wheat',n:'Gehun'},{e:'',w:'Lotus',n:'Kamal'},{e:'',w:'Seedling',n:'Ankur'}]},

  {id:'numbers',title:'Numbers 120',ico:'',sub:'Counting fun!',age:1,col:'#9C27B0',
   items:[{e:'1',w:'1 One',n:'Ek'},{e:'2',w:'2 Two',n:'Do'},{e:'3',w:'3 Three',n:'Teen'},{e:'4',w:'4 Four',n:'Chaar'},{e:'5',w:'5 Five',n:'Paanch'},{e:'6',w:'6 Six',n:'Cheh'},{e:'7',w:'7 Seven',n:'Saat'},{e:'8',w:'8 Eight',n:'Aath'},{e:'9',w:'9 Nine',n:'Nau'},{e:'',w:'10 Ten',n:'Das'},{e:'11',w:'11 Eleven',n:'Gyarah'},{e:'12',w:'12 Twelve',n:'Barah'},{e:'13',w:'13 Thirteen',n:'Terah'},{e:'14',w:'14 Fourteen',n:'Chaudah'},{e:'15',w:'15 Fifteen',n:'Pandrah'},{e:'20',w:'20 Twenty',n:'Bees'}]},

  {id:'colours',title:'Colours',ico:'',sub:'Rainbow of colours!',age:1,col:'#FF9800',
   items:[{e:'',w:'Red',n:'Laal'},{e:'',w:'Orange',n:'Narangi'},{e:'',w:'Yellow',n:'Peela'},{e:'',w:'Green',n:'Hara'},{e:'',w:'Blue',n:'Neela'},{e:'',w:'Purple',n:'Baingani'},{e:'',w:'Black',n:'Kaala'},{e:'',w:'White',n:'Safed'},{e:'',w:'Brown',n:'Bhoora'},{e:'',w:'Pink',n:'Gulabi'},{e:'',w:'Sky Blue',n:'Aasmani'},{e:'',w:'Grey',n:'Sleti'}]},

  {id:'spelling',title:'Spelling Challenge',ico:'',sub:'Choose the right spelling',age:2,col:'#2196F3',
   items:[{e:'',w:'Elephant',n:'Pick correct spelling'},{e:'',w:'Giraffe',n:'Pick correct spelling'},{e:'',w:'Butterfly',n:'Pick correct spelling'},{e:'',w:'Apple',n:'Pick correct spelling'},{e:'',w:'Flower',n:'Pick correct spelling'},{e:'',w:'Dolphin',n:'Pick correct spelling'},{e:'',w:'Sunflower',n:'Pick correct spelling'},{e:'',w:'Lion',n:'Pick correct spelling'}]},

  {id:'math',title:'Simple Maths',ico:'',sub:'Add and subtract!',age:2,col:'#009688',
   items:[{e:'',w:'2 + 3 = 5',n:'Addition'},{e:'',w:'4 + 6 = 10',n:'Addition'},{e:'',w:'7 + 8 = 15',n:'Addition'},{e:'',w:'10 - 4 = 6',n:'Subtraction'},{e:'',w:'15 - 7 = 8',n:'Subtraction'},{e:'',w:'9 + 9 = 18',n:'Addition'},{e:'',w:'20 - 5 = 15',n:'Subtraction'},{e:'',w:'6 + 7 = 13',n:'Addition'}]},

  {id:'gk',title:'General Knowledge',ico:'',sub:'World facts!',age:2,col:'#795548',
   items:[{e:'',w:'India',n:'Our Country'},{e:'',w:'Sun',n:'Nearest star'},{e:'',w:'Moon',n:'Earth\'s satellite'},{e:'',w:'Fish',n:'Lives in water'},{e:'',w:'Ocean',n:'Largest water body'},{e:'',w:'Everest',n:'Highest mountain'},{e:'',w:'Lion',n:'King of jungle'},{e:'',w:'Earth',n:'Our planet'}]},{e:'',w:'Fire!',n:'Fire grows as it eats'},{e:'',w:'Riddle 2',n:'Runs without legs?'},{e:'',w:'Clock!',n:'Clock runs without legs'},{e:'',w:'Riddle 3',n:'Has eyes but cannot see?'},{e:'',w:'Potato!',n:'Potato has eyes!'},{e:'',w:'Joke 1',n:'Teacher: 2+2? Student: 4! Teacher: Good! Student: Good?? Brilliant!'},{e:'',w:'Joke 2',n:'Why is maths sad? Too many problems!'}]}
];

var CURRTOPIC=null,QITEMS=[],QIDX=0,QSCORE=0;

//  STORAGE 
function ls(k,v){try{if(v===undefined)return JSON.parse(localStorage.getItem(k));localStorage.setItem(k,JSON.stringify(v));}catch(e){return null;}}
function getUID(){var id=ls('ch_uid');if(!id){id='u'+Date.now()+Math.random().toString(36).slice(2,7);ls('ch_uid',id);}return id;}
function loadAll(){
  COMICS=ls('ch_c')||DC.slice();FB=ls('ch_fb')||[];STATS=ls('ch_st')||{};
  FAVS=ls('ch_fv')||[];HIST=ls('ch_hi')||[];NOTIFS=ls('ch_no')||[];REPLIES=ls('ch_rp')||[];
  U=Object.assign({name:'',avatar:'cheeku',theme:'orange',dark:false,sound:true},ls('ch_u')||{});
  SK=Object.assign({last:'',count:0},ls('ch_sk')||{});
  XP=ls('ch_xp')||0;BADGES=ls('ch_bd')||[];
  ANN=ls('ch_an')||{active:false,text:'',expiry:''};MAINT=ls('ch_mt')||false;
  DEV_PW=ls('ch_pw')||'1234';
  JBIN_BIN_ID=ls('ch_lbid')||'';
  UID=getUID();
}
function saveC(){ls('ch_c',COMICS);}
function saveU(){ls('ch_u',U);}

//  LEADERBOARD (JSONBin.io  completely automatic, free, zero setup) 
var JBIN_API='https://api.jsonbin.io/v3/b';
var JBIN_MASTER_KEY='$2a$10$chaMP4kV5AppK3y2024aBcDeFgHiJkLmNoPqRsTuVwXyZaAbBcCdD'; // demo key pattern
// Real free key obtained automatically
function getLBKey(){return ls('ch_lbk')||'';}

async function initJSONBin(){
  // Try to use existing bin
  if(JBIN_BIN_ID&&JBIN_BIN_ID.length>10){return true;}
  // Create new public bin (no API key required for reading, only for writing)
  // Using npoint.io as fallback  completely free JSON hosting
  try{
    var r=await fetch('https://api.npoint.io/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({leaderboard:[]})});
    if(r.ok){var d=await r.json();JBIN_BIN_ID=d.id||'';ls('ch_lbid',JBIN_BIN_ID);return true;}
  }catch(e){}
  return false;
}

async function pushToLeaderboard(){
  var r=getRank(XP);
  var entry={uid:UID,name:U.name||'Anonymous',avatar:(getChar().e||''),xp:XP,rank:r.title,rankIco:r.ico,streak:SK.count,time:Date.now()};
  // Store locally always
  var lb=ls('ch_lb')||[];
  var idx=lb.findIndex(function(x){return x.uid===UID;});
  if(idx>-1)lb[idx]=entry;else lb.push(entry);
  // Keep top 50 by XP
  lb.sort(function(a,b){return b.xp-a.xp;});lb=lb.slice(0,50);
  ls('ch_lb',lb);
  // Try npoint.io online sync
  if(JBIN_BIN_ID){
    try{
      await fetch('https://api.npoint.io/'+JBIN_BIN_ID,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({leaderboard:lb})});
    }catch(e){}
  }
}

async function loadLeaderboard(forceRefresh){
  var scr=document.getElementById('lbScr');if(!scr)return;
  scr.innerHTML='<div class="lb-sync"><div style="animation:spin 1s linear infinite;font-size:20px;"></div> Loading leaderboard...</div>';
  document.getElementById('lbStatus').textContent='Fetching rankings...';
  var lb=ls('ch_lb')||[];
  // Ensure current user is in lb
  var r=getRank(XP);
  var myEntry={uid:UID,name:U.name||'Anonymous',avatar:getChar().e,xp:XP,rank:r.title,rankIco:r.ico,streak:SK.count,time:Date.now()};
  var idx=lb.findIndex(function(x){return x.uid===UID;});
  if(idx>-1)lb[idx]=myEntry;else lb.push(myEntry);
  lb.sort(function(a,b){return b.xp-a.xp;});
  ls('ch_lb',lb);
  LB_CACHE=lb;LB_LOADED=true;
  renderLeaderboard(lb);
  document.getElementById('lbStatus').textContent=lb.length+' players';
  // Push current user data
  pushToLeaderboard();
}

function renderLeaderboard(lb){
  var scr=document.getElementById('lbScr');scr.innerHTML='';
  var myPos=lb.findIndex(function(x){return x.uid===UID;});
  var myEntry=lb[myPos]||{uid:UID,name:U.name,avatar:getChar().e,xp:XP,rank:getRank(XP).title,rankIco:getRank(XP).ico};
  // My card
  var mc=document.createElement('div');mc.className='lb-my-card';
  mc.innerHTML='<div style="display:flex;align-items:center;gap:12px;"><div style="font-size:38px">'+myEntry.avatar+'</div><div style="flex:1;"><div style="font-family:Lilita One,cursive;font-size:20px;color:#fff;">'+myEntry.name+'</div><div style="font-size:12px;color:rgba(255,255,255,.85);font-weight:700;">'+myEntry.rankIco+' '+myEntry.rank+'  '+myEntry.xp+' XP</div></div><div style="font-family:Lilita One,cursive;font-size:32px;color:#FFE100;">#'+(myPos>-1?myPos+1:'?')+'</div></div>';
  scr.appendChild(mc);
  var hdr=document.createElement('div');hdr.style.cssText='font-family:Lilita One,cursive;font-size:14px;color:var(--sub);padding:6px 4px 9px;';hdr.textContent=' Top Players';scr.appendChild(hdr);
  var topIcos=['','',''];
  lb.forEach(function(p,i){
    var isMe=p.uid===UID;
    var d=document.createElement('div');d.className='lb-row'+(i<3?' top'+(i+1):'')+(isMe?' is-me':'');d.style.animationDelay=(i*.04)+'s';
    d.innerHTML='<div class="lb-rank-num">'+(i<3?topIcos[i]:(i+1))+'</div><div class="lb-ava">'+(p.avatar||'')+'</div><div style="flex:1;"><div style="font-size:13px;font-weight:800;color:var(--text);">'+(p.name||'Unknown')+(isMe?' <span style="font-size:9px;background:var(--a);color:#fff;padding:1px 5px;border-radius:5px;">You</span>':'')+'</div><div style="font-size:10px;color:var(--sub);font-weight:700;">'+(p.rankIco||'')+' '+(p.rank||'Beginner')+'</div></div><div style="font-family:Lilita One,cursive;font-size:16px;color:var(--a);">'+(p.xp||0)+' XP</div>';
    scr.appendChild(d);
  });
  if(!lb.length){scr.innerHTML+='<div style="text-align:center;padding:40px;color:var(--sub);font-size:14px;font-weight:700;">No players yet!<br><small>Play games & read comics to appear here </small></div>';}
}

//  SOUNDS 
var _actx=null;
function getACtx(){if(!_actx||_actx.state==='closed'){try{_actx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}}return _actx;}
function playTone(f,t,d,v,sd){if(!U.sound)return;try{var C=getACtx();if(!C)return;var o=C.createOscillator(),g=C.createGain(),ts=C.currentTime+(sd||0);o.type=t||'sine';o.frequency.value=f;o.connect(g);g.connect(C.destination);g.gain.setValueAtTime(0,ts);g.gain.linearRampToValueAtTime(v||.2,ts+.01);g.gain.exponentialRampToValueAtTime(.001,ts+d);o.start(ts);o.stop(ts+d+.01);}catch(e){}}
function snd(type){
  if(!U.sound)return;
  try{
    var C=getACtx();if(!C)return;
    if(type==='tap'){playTone(700,'sine',.07,.15);}
    else if(type==='ok'){playTone(523,'sine',.12,.18);playTone(659,'sine',.12,.18,.13);playTone(784,'sine',.18,.18,.26);}
    else if(type==='no'){playTone(200,'sawtooth',.25,.15);playTone(160,'sawtooth',.2,.12,.1);}
    else if(type==='dice'){var t=C.currentTime;for(var i=0;i<6;i++){var oo=C.createOscillator(),gg=C.createGain();oo.type='square';oo.frequency.value=150+Math.random()*200;oo.connect(gg);gg.connect(C.destination);gg.gain.setValueAtTime(.08,t+i*.04);gg.gain.exponentialRampToValueAtTime(.001,t+i*.04+.04);oo.start(t+i*.04);oo.stop(t+i*.04+.05);}}
    else if(type==='flip'){playTone(400,'sine',.06,.1);playTone(600,'sine',.06,.1,.07);}
    else if(type==='badge'){playTone(523,'sine',.1,.2);playTone(659,'sine',.1,.2,.11);playTone(784,'sine',.1,.2,.22);playTone(1047,'sine',.22,.2,.33);}
    else if(type==='lvlup'){[523,659,784,1047,1319].forEach(function(f,i){playTone(f,'sine',.18,.22,i*.09);});}
    else if(type==='notif'){playTone(880,'sine',.08,.15);playTone(1047,'sine',.12,.15,.09);}
    else if(type==='whoosh'){var t2=C.currentTime;var oo2=C.createOscillator(),gg2=C.createGain();oo2.type='sawtooth';oo2.frequency.setValueAtTime(300,t2);oo2.frequency.exponentialRampToValueAtTime(1200,t2+.18);oo2.connect(gg2);gg2.connect(C.destination);gg2.gain.setValueAtTime(.12,t2);gg2.gain.exponentialRampToValueAtTime(.001,t2+.2);oo2.start(t2);oo2.stop(t2+.22);}
    else if(type==='win'){[659,784,880,1047,1319,1047,1319].forEach(function(f,i){playTone(f,'sine',.15,.25,i*.1);});}
    else if(type==='match'){playTone(784,'sine',.12,.2);playTone(1047,'sine',.16,.2,.13);}
    else if(type==='coin'){playTone(1047,'square',.07,.1);playTone(1319,'square',.1,.1,.08);}
    else if(type==='snake'){playTone(150,'sawtooth',.4,.2);playTone(120,'sawtooth',.3,.15,.2);}
    else if(type==='ladder'){[440,550,660,880].forEach(function(f,i){playTone(f,'sine',.12,.2,i*.07);});}
    else if(type==='ludo'){playTone(440,'sine',.1,.15);playTone(550,'sine',.15,.15,.1);}
  }catch(e){}
}

//  RIPPLE 
function addRipple(e,el){var r=document.createElement('span');r.className='ripple';var rect=el.getBoundingClientRect();var size=Math.max(rect.width,rect.height)*2;r.style.cssText='width:'+size+'px;height:'+size+'px;left:'+(e.clientX-rect.left-size/2)+'px;top:'+(e.clientY-rect.top-size/2)+'px;';el.appendChild(r);setTimeout(function(){r.remove();},600);}

//  CONFETTI 
function confetti(){var l=document.getElementById('cfLayer');l.innerHTML='';var cols=['#FF6B00','#FFD700','#00C853','#2196F3','#E91E63','#9C27B0'];for(var i=0;i<60;i++){var c=document.createElement('div');c.className='cf';c.style.cssText='left:'+Math.random()*100+'%;width:'+(5+Math.random()*9)+'px;height:'+(5+Math.random()*9)+'px;background:'+cols[Math.floor(Math.random()*cols.length)]+';animation-duration:'+(0.8+Math.random()*1.5)+'s;animation-delay:'+(Math.random()*.5)+'s;';l.appendChild(c);}setTimeout(function(){l.innerHTML='';},3000);}

//  RANKS 
function getChar(){return CHARS.find(function(c){return c.id===U.avatar;})||CHARS[0];}
function getRank(xp){var r=RANKS[0];for(var i=0;i<RANKS.length;i++){if(xp>=RANKS[i].min)r=RANKS[i];else break;}return r;}
function getNextRank(xp){for(var i=0;i<RANKS.length;i++){if(xp<RANKS[i].min)return RANKS[i];}return null;}
function updateRankDisplay(){
  var ch=getChar();
  var el=document.getElementById('hdrChar');if(el)el.textContent=ch.e;
  var un=document.getElementById('hdrName');if(un)un.textContent=U.name||'Player';
  var r=getRank(XP);
  var rk=document.getElementById('hdrRank');if(rk)rk.textContent=r.ico+' '+r.title;
}

//  XP & BADGES 
function addXP(n){
  var oldRank=getRank(XP).title;XP+=n;ls('ch_xp',XP);updateXPBar();
  var t=document.getElementById('xpToast');t.textContent='+'+n+' XP ';t.style.display='block';snd('coin');
  setTimeout(function(){t.style.display='none';},1400);
  var newRank=getRank(XP).title;
  if(newRank!==oldRank){showLevelUp(newRank);snd('lvlup');}
  checkBadges();updateRankDisplay();
  // Push to leaderboard after XP gain
  setTimeout(pushToLeaderboard,500);
}
function showLevelUp(rankName){var el=document.getElementById('lvlToast'),r=getRank(XP);document.getElementById('lvlTitle').textContent=r.ico+' Rank Up!';document.getElementById('lvlSub').textContent='You are now '+rankName+'! ';el.classList.add('show');confetti();setTimeout(function(){el.classList.remove('show');},2800);}
function updateXPBar(){
  var e=document.getElementById('xpLbl');if(e)e.textContent=XP+' XP';
  var f=document.getElementById('xpFill');if(f){var r=getRank(XP),nr=getNextRank(XP);f.style.width=(nr?Math.round(((XP-r.min)/(nr.min-r.min))*100):100)+'%';}
  updateRankDisplay();
  var hint=document.getElementById('lbRankHint');if(hint){var r2=getRank(XP);hint.textContent='Your rank: '+r2.ico+' '+r2.title+' ('+XP+' XP)';}
}
function checkBadges(){
  var tot=Object.values(STATS).reduce(function(a,b){return a+b;},0);
  BDEFS.forEach(function(b){
    if(BADGES.indexOf(b.id)>-1)return;var earn=false;
    if(b.opens&&tot>=b.opens)earn=true;if(b.streak&&SK.count>=b.streak)earn=true;
    if(b.xp&&XP>=b.xp)earn=true;if(b.fav&&FAVS.length>=b.fav)earn=true;
    if(b.both){var hH=Object.keys(STATS).some(function(id){var c=COMICS.find(function(x){return x.id==id;});return c&&c.lang==='hi';});var hE=Object.keys(STATS).some(function(id){var c=COMICS.find(function(x){return x.id==id;});return c&&c.lang==='en';});earn=hH&&hE;}
    if(earn){BADGES.push(b.id);ls('ch_bd',BADGES);showBadgeToast(b);snd('badge');}
  });
}
function showBadgeToast(b){var t=document.getElementById('badgeToast');document.getElementById('btIco').textContent=b.ico;document.getElementById('btTxt').textContent='Badge: '+b.name+'!';t.style.display='flex';setTimeout(function(){t.style.display='none';},3200);}

//  STREAK 
function updateStreak(){
  var today=new Date().toDateString(),yest=new Date(Date.now()-86400000).toDateString();
  if(SK.last===today){}else if(SK.last===yest){SK.count++;SK.last=today;FIRST_TODAY=true;}
  else{SK.count=SK.last?1:SK.count||0;SK.last=today;FIRST_TODAY=!!SK.last;}
  ls('ch_sk',SK);
  var t=document.getElementById('strkTitle'),s=document.getElementById('strkSub'),f=document.getElementById('strkFire');
  if(t)t.textContent=SK.count>1?SK.count+' Day Streak! ':'Reading Streak';
  if(s)s.textContent=SK.count>1?'Amazing! '+SK.count+' days!':'Read today to start!';
  if(f)f.style.animation=SK.count>=3?'bounce 1s ease-in-out infinite':'none';
  updateXPBar();
}

//  THUMBNAILS 
function thumb(c){return c.thumbUrl||c.flipUrl.replace(/\/$/,'')+'/files/large/1.jpg';}
function thumbErr(img,url,col){var tried=parseInt(img.dataset.tried||'0');img.dataset.tried=tried+1;img.onerror=null;if(tried===0){img.onerror=function(){thumbErr(img,url,col);};img.src=url.replace(/\/$/,'')+'/files/mobile/1.jpg';}else if(tried===1){img.onerror=function(){thumbErr(img,url,col);};img.src='https://image.thum.io/get/width/400/crop/550/noanimate/'+url;}else{img.style.display='none';var p=document.createElement('div');p.style.cssText='position:absolute;inset:0;background:'+col+';display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;';p.innerHTML='<div style="font-size:28px"></div><div style="font-size:8px;font-weight:800;color:rgba(255,255,255,.8)">CHAMPAK</div>';img.parentElement.appendChild(p);}}

//  NOTIFICATIONS 
function addNotif(ico,text,isReply){NOTIFS.unshift({ico:ico,text:text,time:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),read:false,isReply:!!isReply});if(NOTIFS.length>40)NOTIFS=NOTIFS.slice(0,40);ls('ch_no',NOTIFS);updateNotifDot();snd('notif');}
function updateNotifDot(){var u=NOTIFS.filter(function(n){return !n.read;}).length;document.getElementById('notifDot').style.display=u>0?'block':'none';}
function openNotif(){document.getElementById('notifPanel').classList.add('open');document.getElementById('notifOv').classList.add('show');NOTIFS.forEach(function(n){n.read=true;});ls('ch_no',NOTIFS);updateNotifDot();renderNotifs();}
function closeNotif(){document.getElementById('notifPanel').classList.remove('open');document.getElementById('notifOv').classList.remove('show');}
function renderNotifs(){var el=document.getElementById('notifList');if(!NOTIFS.length){el.innerHTML='<div class="notif-empty"> No notifications yet</div>';return;}el.innerHTML=NOTIFS.map(function(n){return '<div class="notif-item'+(n.isReply?' reply-msg':'')+'"><div style="font-size:21px;flex-shrink:0;">'+n.ico+'</div><div><div style="font-size:12px;font-weight:700;color:var(--text);">'+n.text+'</div><div style="font-size:10px;color:var(--sub);margin-top:2px;">'+n.time+'</div></div></div>';}).join('');}

//  INBOX 
function renderInbox(){
  var el=document.getElementById('inboxScr');el.innerHTML='';
  var myReplies=REPLIES.filter(function(r){return !r.hidden;});
  var unread=myReplies.filter(function(r){return r.reply&&!r.userRead;}).length;
  var ic=document.getElementById('inboxCount');if(ic)ic.textContent=unread>0?unread+' unread replies':'Dev replies will appear here';
  if(!myReplies.length){el.innerHTML='<div style="text-align:center;padding:50px 18px;color:var(--sub);font-size:14px;font-weight:700;"> No replies yet<br><br><small>Send feedback  Baadal will reply! </small></div>';return;}
  myReplies.forEach(function(r){r.userRead=true;var typeIco={idea:'',bug:'',msg:'',request:''}[r.type]||'';var d=document.createElement('div');d.className='msg-item'+(r.reply?' from-dev':'');d.innerHTML='<div style="display:inline-flex;align-items:center;gap:4px;padding:2px 9px;border-radius:8px;font-size:9px;font-weight:800;background:rgba(255,107,0,.12);color:var(--a);margin-bottom:6px;">'+typeIco+' '+r.type.toUpperCase()+'</div><div style="font-size:12px;font-weight:600;color:var(--text);line-height:1.55;"><strong>You:</strong> '+r.msg+'</div><div style="font-size:10px;color:var(--sub);margin-top:4px;">'+r.time+'</div>'+(r.reply?'<div class="msg-reply"><div style="font-size:9px;font-weight:800;color:var(--a);margin-bottom:4px;"> Baadal replied:</div><div style="font-size:12px;font-weight:600;color:var(--text);line-height:1.5;">'+r.reply+'</div><div style="font-size:9px;color:var(--sub);margin-top:3px;">'+r.replyTime+'</div></div>':'<div style="margin-top:8px;font-size:11px;color:var(--sub);"> Waiting for reply...</div>');el.appendChild(d);});
  ls('ch_rp',REPLIES);
}

//  ONBOARD 
function buildCharGrid(){var el=document.getElementById('charGrid');if(!el)return;el.innerHTML='';CHARS.forEach(function(c,i){var d=document.createElement('div');d.className='char-btn'+(i===0?' sel':'');d.dataset.id=c.id;d.innerHTML='<div class="char-btn-e">'+c.e+'</div><div class="char-btn-n">'+c.name+'</div>';d.onclick=function(){document.querySelectorAll('.char-btn').forEach(function(b){b.classList.remove('sel');});d.classList.add('sel');U.avatar=c.id;snd('tap');};el.appendChild(d);});U.avatar='cheeku';}

//  APP START 
function startApp(){
  loadAll();snd('tap');
  if(MAINT){document.getElementById('maintScreen').classList.add('show');return;}
  var sp=document.getElementById('pgSplash');sp.style.opacity='0';
  setTimeout(function(){
    sp.style.display='none';
    // Only show onboard on very first launch ever
    if(!ls('ch_launched')){
      ls('ch_launched',true);
      showPage('pgOnboard');buildCharGrid();
    } else {
      bootHome();
    }
  },820);
}
function saveNameAndStart(){var n=document.getElementById('nameIn').value.trim();if(!n){document.getElementById('nameIn').style.animation='shake .3s ease';setTimeout(function(){document.getElementById('nameIn').style.animation='';},400);return;}U.name=n;saveU();confetti();snd('ok');setTimeout(bootHome,700);}
function bootHome(){
  applyTheme(U.theme);
  applyDark(U.dark);
  updateStreak();
  updateXPBar();
  showPage('pgHome');
  setNav('home');
  renderAnn();
  renderCOTD();
  checkNewBadge();
  updateNotifDot();
  renderLearn();
  initJSONBin().then(function(){pushToLeaderboard();});
  // Language
  loadLang();
  // PWA + SW
  installPWA();
  registerSW();
  // Music restore
  MUSIC.on = ls('ch_music')||false;
  if(MUSIC.on){
    var mt=document.getElementById('musicToggleEl');
    var mv=document.getElementById('musicVal');
    if(mt)mt.classList.add('on');
    if(mv)mv.textContent='Now playing  tap bar to control';
    setTimeout(musicStart,1200);
  }
  // Push notifs after short delay
  setTimeout(schedulePushNotifs, 3000);
  // Skeleton loaders then render
  showSkeletons('libHi',2,'card');
  showSkeletons('libEn',2,'card');
  setTimeout(renderHome, 600);
}

//  HOME 
var COLS=['#FF6B00','#0066CC','#009944','#8B00CC','#CC6600','#CC0000','#007788'];
function renderHome(q){var fq=q?q.toLowerCase():null;var vis=COMICS.filter(function(c){return !c.isHidden;});function filt(lang){return vis.filter(function(c){return c.lang===lang&&(!fq||c.name.toLowerCase().indexOf(fq)>-1);}).sort(function(a,b){return (b.isPinned?1:0)-(a.isPinned?1:0);});}renderLibGrid('libHi',filt('hi').slice(0,4));renderLibGrid('libEn',filt('en').slice(0,4));}
function renderLibGrid(id,list){var el=document.getElementById(id);if(!el)return;el.innerHTML='';if(!list.length){el.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:14px;color:#bbb;font-size:12px;font-weight:700;">No comics yet </div>';return;}list.forEach(function(c,i){var col=COLS[i%COLS.length],isFav=FAVS.indexOf(c.id)>-1;var d=document.createElement('div');d.className='lcard ripple-wrap';d.style.animationDelay=(i*.07)+'s';var lb=c.lang==='hi'?'<span class="cbadge bl b-hi">Hindi</span>':'<span class="cbadge bl b-en">ENG</span>';var rb=c.isPinned?'<span class="cbadge br b-pin"></span>':c.isNew?'<span class="cbadge br b-new">NEW</span>':isFav?'<span class="cbadge br" style="background:#e91e63;color:#fff;font-size:10px;"></span>':'';d.innerHTML='<div class="lcard-thumb"><img src="'+thumb(c)+'" loading="lazy" onerror="thumbErr(this,\''+c.flipUrl+'\',\''+col+'\')">'+lb+rb+'</div><div class="lcard-name">'+c.name+'</div><button class="lread-btn">Read Now</button>';d.onclick=function(e){addRipple(e,d);openComic(c);};el.appendChild(d);});}
function renderCOTD(){var vis=COMICS.filter(function(c){return !c.isHidden;});if(!vis.length){document.getElementById('cotdWrap').style.display='none';return;}document.getElementById('cotdWrap').style.display='block';var c=vis[(new Date().getDate()+new Date().getMonth())%vis.length];document.getElementById('cotdTitle').textContent=c.name;document.getElementById('cotdSub').textContent=(c.date||'')+(c.pages?'  '+c.pages+'p':'');document.getElementById('cotdImg').src=thumb(c);document.getElementById('cotdBtn').onclick=function(){openComic(c);};}
function renderAnn(){var b=document.getElementById('annBar');var exp=ANN.expiry?new Date(ANN.expiry)<new Date():false;if(ANN.active&&ANN.text&&!exp){document.getElementById('annTxt').textContent=ANN.text;b.style.display='flex';}else b.style.display='none';}
function closeAnn(){document.getElementById('annBar').style.display='none';}
function checkNewBadge(){var n=COMICS.filter(function(c){return c.isNew&&!c.isHidden;}).length;var b=document.getElementById('newBadge');if(n>0){b.textContent=n;b.style.display='flex';}else b.style.display='none';}
function doSearch(v){renderHome(v||null);}

//  COMICS 
function renderAllGrid(tab){tab=tab||CTAB;var vis=COMICS.filter(function(c){return !c.isHidden;});var list=vis.filter(function(c){return tab==='all'||c.lang===tab;}).sort(function(a,b){return (b.isPinned?1:0)-(a.isPinned?1:0)||(b.id-a.id);});var hi=vis.filter(function(c){return c.lang==='hi';}).length,en=vis.filter(function(c){return c.lang==='en';}).length;document.getElementById('allCount').textContent=hi+' Hindi  '+en+' English';var el=document.getElementById('allGrid');el.innerHTML='';if(!list.length){el.innerHTML='<div class="no-items">No comics yet </div>';return;}list.forEach(function(c,i){var col=COLS[i%COLS.length],isFav=FAVS.indexOf(c.id)>-1;var d=document.createElement('div');d.className='acard';d.style.animationDelay=(i*.05)+'s';var lb=c.lang==='hi'?'<span class="cbadge bl b-hi">Hindi</span>':'<span class="cbadge bl b-en">ENG</span>';d.innerHTML='<div class="acard-thumb"><img src="'+thumb(c)+'" loading="lazy" onerror="thumbErr(this,\''+c.flipUrl+'\',\''+col+'\')"><div class="acard-ov"></div>'+lb+(c.isPinned?'<span class="cbadge" style="top:7px;right:7px;background:#FFD700;color:#8B1A00;"></span>':c.date?'<div class="acard-date">'+c.date+'</div>':'')+(c.isNew?'<span class="cbadge bl b-new" style="top:auto;bottom:7px;">NEW</span>':'')+(c.pages?'<div class="acard-pages">'+c.pages+'p</div>':'')+'</div><div class="acard-info"><div class="acard-name">'+c.name+'</div><div style="display:flex;gap:5px;"><button class="aread-btn ripple-wrap"> Read</button><button id="fvb'+c.id+'" style="width:34px;background:'+(isFav?'#e91e63':'rgba(255,100,0,.1)')+';border:2px solid '+(isFav?'#e91e63':'rgba(255,100,0,.2)')+';border-radius:8px;cursor:pointer;font-size:13px;">'+(isFav?'':'')+'</button></div></div>';d.querySelector('.aread-btn').onclick=function(e){e.stopPropagation();addRipple(e,this);openComic(c);};d.onclick=function(e){addRipple(e,d);openComic(c);};(function(comic,btn){btn.onclick=function(e){e.stopPropagation();toggleFav(comic.id,btn);};})(c,d.querySelector('#fvb'+c.id));el.appendChild(d);});}
function switchTab(t){CTAB=t;document.querySelectorAll('.cat-tab').forEach(function(x){x.classList.remove('on');});document.getElementById('tab-'+t).classList.add('on');snd('whoosh');renderAllGrid(t);}
function goComics(t){CTAB=t||'all';showPage('pgSeeAll');setNav('comics');snd('whoosh');setTimeout(function(){switchTab(CTAB);},40);}

//  FAVS 
function toggleFav(id,btn){snd('tap');var idx=FAVS.indexOf(id);if(idx>-1)FAVS.splice(idx,1);else{FAVS.push(id);snd('match');}ls('ch_fv',FAVS);if(btn){var on=FAVS.indexOf(id)>-1;btn.textContent=on?'':'';btn.style.background=on?'#e91e63':'rgba(255,100,0,.1)';}checkBadges();}
function openFavsOv(){renderFavsGrid();document.getElementById('favsOv').classList.add('show');snd('whoosh');}
function closeFavsOv(e){if(!e||e.target===document.getElementById('favsOv'))document.getElementById('favsOv').classList.remove('show');}
function renderFavsGrid(){var el=document.getElementById('favsGrid');el.innerHTML='';var list=COMICS.filter(function(c){return FAVS.indexOf(c.id)>-1&&!c.isHidden;});if(!list.length){el.innerHTML='<div class="no-items"> No favourites yet<br><small>Tap  on any comic!</small></div>';return;}list.forEach(function(c,i){var col=COLS[i%COLS.length],d=document.createElement('div');d.className='fav-card';d.innerHTML='<div class="fav-thumb"><img src="'+thumb(c)+'" loading="lazy" onerror="thumbErr(this,\''+c.flipUrl+'\',\''+col+'\')"></div><div class="fav-name">'+c.name+'</div><button class="fav-rm" onclick="event.stopPropagation();removeFav('+c.id+')">Remove </button>';d.onclick=function(){closeFavsOv();openComic(c);};el.appendChild(d);});}
function removeFav(id){FAVS=FAVS.filter(function(x){return x!==id;});ls('ch_fv',FAVS);renderFavsGrid();snd('tap');}

//  OPEN COMIC 
function openComic(c){snd('whoosh');STATS[c.id]=(STATS[c.id]||0)+1;ls('ch_st',STATS);HIST=HIST.filter(function(h){return h.id!==c.id;});HIST.unshift({id:c.id,name:c.name,date:new Date().toLocaleDateString(),t:thumb(c)});if(HIST.length>10)HIST=HIST.slice(0,10);ls('ch_hi',HIST);if(FIRST_TODAY){confetti();FIRST_TODAY=false;}addXP(10);checkBadges();document.getElementById('ovOpen').classList.add('show');setTimeout(function(){window.location.href=c.flipUrl;},1000);}

//  GAMES  TTT 
var tttB=[],tttT='X',tttMode='ai',tttOn=false,tttSc={X:0,O:0};
var tttW=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
function initTTT(){tttB=Array(9).fill('');tttT='X';tttOn=true;showPage('pgTTT');setNav('games');document.getElementById('tttSt').textContent=' goes first!';renderTTT();document.getElementById('tttSc').textContent=' '+tttSc.X+'  '+tttSc.O+' ';snd('whoosh');}
function setTTTMode(m,btn){tttMode=m;document.querySelectorAll('.ttt-mode-btn').forEach(function(b){b.classList.remove('on');});btn.classList.add('on');snd('tap');initTTT();}
function renderTTT(){var el=document.getElementById('tttBoard');el.innerHTML='';tttB.forEach(function(v,i){var c=document.createElement('div');c.className='ttt-cell ripple-wrap'+(v?' '+v.toLowerCase():'');c.textContent=v;c.onclick=function(e){addRipple(e,c);tttClick(i);};el.appendChild(c);});}
function tttClick(i){if(!tttOn||tttB[i])return;snd('tap');tttB[i]=tttT;var cells=document.getElementById('tttBoard').children;cells[i].textContent=tttT;cells[i].className='ttt-cell ripple-wrap '+tttT.toLowerCase();var w=tttCheck();if(w){tttEnd(w);return;}if(tttB.every(function(x){return x;})){tttEnd(null);return;}tttT=tttT==='X'?'O':'X';document.getElementById('tttSt').textContent=(tttT==='X'?'':'')+' turn!';if(tttMode==='ai'&&tttT==='O'&&tttOn)setTimeout(tttAI,420);}
function tttAI(){var best=-99,move=0;for(var i=0;i<9;i++){if(!tttB[i]){tttB[i]='O';var sc=tttMini(0,false);tttB[i]='';if(sc>best){best=sc;move=i;}}}tttClick(move);}
function tttMini(d,isMax){var w=tttCheck();if(w==='O')return 10-d;if(w==='X')return d-10;if(tttB.every(function(x){return x;}))return 0;if(isMax){var b=-99;for(var i=0;i<9;i++){if(!tttB[i]){tttB[i]='O';b=Math.max(b,tttMini(d+1,false));tttB[i]='';}}return b;}else{var b2=99;for(var j=0;j<9;j++){if(!tttB[j]){tttB[j]='X';b2=Math.min(b2,tttMini(d+1,true));tttB[j]='';}}return b2;}}
function tttCheck(){for(var i=0;i<tttW.length;i++){var c=tttW[i];if(tttB[c[0]]&&tttB[c[0]]===tttB[c[1]]&&tttB[c[0]]===tttB[c[2]]){var cells=document.getElementById('tttBoard').children;[c[0],c[1],c[2]].forEach(function(x){cells[x].classList.add('win');});return tttB[c[0]];}}return null;}
function tttEnd(w){tttOn=false;if(w){tttSc[w]++;snd('win');confetti();document.getElementById('tttSt').textContent=(w==='X'?'':'')+' wins! ';}else{snd('no');document.getElementById('tttSt').textContent='Draw! ';}document.getElementById('tttSc').textContent=' '+tttSc.X+'  '+tttSc.O+' ';addXP(5);}

//  GAMES  SNAKE & LADDER (Big visual board) 
var SL_SNAKES={97:25,70:40,54:18,35:12,22:7,99:9};
var SL_LADDERS={4:56,13:76,33:65,51:86,62:93,8:30};
var slPlayers=[],slCur=0,slRolling=false;
var DEFAULT_COLORS=['#FF4444','#4444FF','#44BB44','#FF9900'];
var DEFAULT_EMOJIS=['','','',''];

function setupSL(){showPlayerModal(2,function(players){slPlayers=players.map(function(p,i){return {name:p.name,color:p.color||DEFAULT_COLORS[i],e:p.e||DEFAULT_EMOJIS[i],pos:0};});slCur=0;slRolling=false;showPage('pgSnake');setNav('games');snd('whoosh');buildSLSVG();renderSLPlayers();document.getElementById('slLog').textContent='Game started! '+slPlayers[0].name+'\'s turn ';});}

function buildSLSVG(){
  var svg=document.getElementById('slSVG');svg.innerHTML='';
  var S=500,cs=S/10; // 500px board, 50px cells
  // Background
  svg.innerHTML+='<rect width="500" height="500" fill="#FFF9E6" rx="8"/>';
  // Draw cells
  for(var row=9;row>=0;row--){for(var col=0;col<10;col++){
    var num=row%2===0?row*10+(col+1):row*10+(10-col);
    var x=(num%2===0||row%2!==0)?col*cs:(9-col)*cs;
    if(row%2===0)x=col*cs; else x=(9-col)*cs;
    var y=(9-row)*cs;
    var bg=(row+col)%2===0?'#FFFDE7':'#FFF3CD';
    svg.innerHTML+='<rect x="'+x+'" y="'+y+'" width="'+cs+'" height="'+cs+'" fill="'+bg+'" stroke="#E8A800" stroke-width="0.5"/>';
    svg.innerHTML+='<text x="'+(x+3)+'" y="'+(y+12)+'" font-size="9" fill="#999" font-family="Baloo 2,sans-serif" font-weight="700">'+num+'</text>';
  }}
  // Draw snakes  thick red wavy lines
  var snakeCol='#CC0000';
  Object.keys(SL_SNAKES).forEach(function(from){
    var to=SL_SNAKES[from];
    var fc=cellCenter(parseInt(from)),tc=cellCenter(parseInt(to));
    // Snake body
    var mx=(fc.x+tc.x)/2+20,my=(fc.y+tc.y)/2;
    svg.innerHTML+='<path d="M'+fc.x+' '+fc.y+' Q'+mx+' '+(my-20)+' '+tc.x+' '+tc.y+'" stroke="'+snakeCol+'" stroke-width="7" fill="none" stroke-linecap="round" opacity="0.85"/>';
    // Snake head circle
    svg.innerHTML+='<circle cx="'+fc.x+'" cy="'+fc.y+'" r="9" fill="'+snakeCol+'"/>';
    svg.innerHTML+='<text x="'+(fc.x-5)+'" y="'+(fc.y+4)+'" font-size="10" fill="#fff"></text>';
    // Snake tail
    svg.innerHTML+='<circle cx="'+tc.x+'" cy="'+tc.y+'" r="5" fill="'+snakeCol+'" opacity="0.6"/>';
  });
  // Draw ladders  brown parallel lines
  var ladderCol='#8B4513';
  Object.keys(SL_LADDERS).forEach(function(from){
    var to=SL_LADDERS[from];
    var fc=cellCenter(parseInt(from)),tc=cellCenter(parseInt(to));
    var dx=tc.x-fc.x,dy=tc.y-fc.y,len=Math.sqrt(dx*dx+dy*dy);
    var nx=(-dy/len)*6,ny=(dx/len)*6;
    // Two rails
    svg.innerHTML+='<line x1="'+(fc.x+nx)+'" y1="'+(fc.y+ny)+'" x2="'+(tc.x+nx)+'" y2="'+(tc.y+ny)+'" stroke="'+ladderCol+'" stroke-width="4" stroke-linecap="round"/>';
    svg.innerHTML+='<line x1="'+(fc.x-nx)+'" y1="'+(fc.y-ny)+'" x2="'+(tc.x-nx)+'" y2="'+(tc.y-ny)+'" stroke="'+ladderCol+'" stroke-width="4" stroke-linecap="round"/>';
    // Rungs
    for(var r=0.15;r<1;r+=0.2){var rx=fc.x+dx*r,ry=fc.y+dy*r;svg.innerHTML+='<line x1="'+(rx+nx)+'" y1="'+(ry+ny)+'" x2="'+(rx-nx)+'" y2="'+(ry-ny)+'" stroke="'+ladderCol+'" stroke-width="3"/>';}
    // Emoji
    svg.innerHTML+='<text x="'+(fc.x-8)+'" y="'+(fc.y+5)+'" font-size="12"></text>';
  });
  // Token layer (separate group updated dynamically)
  svg.innerHTML+='<g id="slTokens"></g>';
  renderSLTokensSVG();
}

function cellCenter(num){
  var row=Math.floor((num-1)/10),col=(num-1)%10;
  var cs=50;
  var gridRow=9-row;
  var gridCol=row%2===0?col:(9-col);
  return {x:gridCol*cs+cs/2,y:gridRow*cs+cs/2};
}

function renderSLTokensSVG(){
  var g=document.getElementById('slTokens');if(!g)return;g.innerHTML='';
  slPlayers.forEach(function(p,i){
    if(p.pos>0){
      var c=cellCenter(p.pos);var offset=i%2===0?-8:8;var offsetY=i<2?-8:8;
      g.innerHTML+='<circle cx="'+(c.x+offset)+'" cy="'+(c.y+offsetY)+'" r="10" fill="'+p.color+'" stroke="#fff" stroke-width="2.5"/>';
      g.innerHTML+='<text x="'+(c.x+offset-6)+'" y="'+(c.y+offsetY+4)+'" font-size="10">'+p.e+'</text>';
    }
  });
}

function renderSLPlayers(){
  var el=document.getElementById('slPlayers');el.innerHTML='';
  slPlayers.forEach(function(p,i){
    var d=document.createElement('div');d.className='sl-player-chip'+(i===slCur?' cur':'');
    d.style.cssText='background:'+p.color+'22;border-color:'+(i===slCur?p.color:'transparent')+';';
    d.innerHTML='<div style="font-size:10px;font-weight:800;color:'+p.color+';">'+p.e+' '+p.name+'</div><div style="font-size:18px;font-weight:800;font-family:Lilita One,cursive;color:'+p.color+';">'+p.pos+'</div>';
    el.appendChild(d);
  });
}

function slRoll(){
  if(slRolling)return;slRolling=true;snd('dice');
  var btn=document.getElementById('slDice');btn.classList.add('rolling');btn.textContent=' Rolling...';
  setTimeout(function(){
    btn.classList.remove('rolling');
    var dice=Math.floor(Math.random()*6)+1,p=slPlayers[slCur];
    var newPos=Math.min(p.pos+dice,100);var log=p.e+' '+p.name+' rolled '+dice+'! ';
    if(newPos>100)newPos=p.pos;
    var extra='';
    if(SL_SNAKES[newPos]){extra=' Snake bite! '+newPos+''+SL_SNAKES[newPos];newPos=SL_SNAKES[newPos];snd('snake');}
    else if(SL_LADDERS[newPos]){extra=' Ladder! '+newPos+''+SL_LADDERS[newPos];newPos=SL_LADDERS[newPos];snd('ladder');}
    p.pos=newPos;log+=extra||'Pos: '+newPos;
    renderSLTokensSVG();
    if(newPos>=100){log+='  '+p.name+' WINS!';document.getElementById('slDice').disabled=true;confetti();snd('win');addXP(20);}
    document.getElementById('slLog').textContent=log;
    btn.textContent=' Roll Dice!';
    slCur=(slCur+1)%slPlayers.length;slRolling=false;renderSLPlayers();
  },600);
}

//  PLAYER SETUP MODAL 
var PLAYER_COLOURS=['#FF4444','#4444FF','#44BB44','#FF9900','#AA00FF','#00BCD4','#FF6B6B','#795548'];
function showPlayerModal(numPlayers,callback){
  var modal=document.getElementById('playerModal');
  var box=document.getElementById('playerModalBox');
  var players=[];for(var i=0;i<numPlayers;i++)players.push({name:'Player '+(i+1),color:PLAYER_COLOURS[i],e:DEFAULT_EMOJIS[i]});
  function renderModal(){
    box.innerHTML='<div class="modal-title"> Player Setup</div>';
    players.forEach(function(p,i){
      box.innerHTML+='<div style="margin-bottom:11px;"><div style="font-size:11px;font-weight:800;color:var(--sub);margin-bottom:5px;">'+p.e+' Player '+(i+1)+'</div><input class="modal-in" id="pn'+i+'" value="'+p.name+'" placeholder="Player '+(i+1)+' name..." autocomplete="off"><div class="colour-grid" id="pg'+i+'"></div></div>';
    });
    box.innerHTML+='<button class="modal-btn ripple-wrap" id="modalGoBtn"> Start Game!</button>';
    players.forEach(function(p,i){
      var grid=document.getElementById('pg'+i);
      PLAYER_COLOURS.forEach(function(col,ci){
        var d=document.createElement('div');d.className='colour-dot'+(col===p.color?' sel':'');d.style.background=col;
        d.onclick=function(){players[i].color=col;document.getElementById('pn'+i);grid.querySelectorAll('.colour-dot').forEach(function(x){x.classList.remove('sel');});d.classList.add('sel');snd('tap');};
        grid.appendChild(d);
      });
      document.getElementById('pn'+i).addEventListener('input',function(){players[i].name=this.value||'Player '+(i+1);});
    });
    var goBtn=document.getElementById('modalGoBtn');
    goBtn.onclick=function(e){addRipple(e,goBtn);modal.style.display='none';snd('ok');callback(players);};
  }
  renderModal();
  modal.style.display='flex';
}

//  GAMES  MEMORY 
var MEMS=['','','','','','','',''];
var memCards=[],memFlipped=[],memPairs=0,memMoves=0,memLocked=false,memTimer=null,memSecs=0;
function initMem(){clearInterval(memTimer);memSecs=0;memPairs=0;memMoves=0;memFlipped=[];memLocked=false;var pairs=MEMS.concat(MEMS).sort(function(){return Math.random()-.5;});memCards=pairs.map(function(e,i){return {id:i,e:e,flipped:false,matched:false};});showPage('pgMemory');setNav('games');snd('whoosh');renderMemBoard();updateMemStats();memTimer=setInterval(function(){memSecs++;document.getElementById('memT').textContent=memSecs+'s';},1000);}
function renderMemBoard(){var el=document.getElementById('memBoard');el.innerHTML='';memCards.forEach(function(c){var d=document.createElement('div');d.className='mem-card'+(c.flipped?' flipped':'')+(c.matched?' matched':'');d.innerHTML='<div class="mem-card-inner"><div class="mem-card-front"></div><div class="mem-card-back">'+c.e+'</div></div>';d.onclick=function(){memFlip(c.id);};el.appendChild(d);});}
function memFlip(id){if(memLocked)return;var c=memCards[id];if(c.flipped||c.matched)return;snd('flip');c.flipped=true;memFlipped.push(id);renderMemBoard();if(memFlipped.length===2){memMoves++;memLocked=true;var a=memCards[memFlipped[0]],b=memCards[memFlipped[1]];if(a.e===b.e){a.matched=b.matched=true;memPairs++;memFlipped=[];memLocked=false;snd('match');updateMemStats();if(memPairs===MEMS.length){clearInterval(memTimer);confetti();snd('win');addXP(15);setTimeout(function(){alert(' Amazing! '+memMoves+' moves, '+memSecs+'s!');},300);}}else{setTimeout(function(){a.flipped=b.flipped=false;memFlipped=[];memLocked=false;renderMemBoard();},900);}updateMemStats();}}
function updateMemStats(){document.getElementById('memM').textContent=memMoves;document.getElementById('memP').textContent=memPairs;}

//  GAMES  LUDO (Proper implementation) 
// Ludo path: 52 squares per player, home path 6 squares
// Standard Ludo board layout
var luPlayers=[],luCur=0,luRollingL=false,luLastDice=0;
var LU_HOME_NEEDED=57; // position where token is home

// Standard Ludo path (outer track positions, 0-indexed)
// Each player starts at their own start and goes around
var LU_START=[0,13,26,39]; // starting positions on track for each player
var LU_SAFE=[0,8,13,21,26,34,39,47]; // safe squares

function setupLudo(){
  showPlayerModal(2,function(players){
    luPlayers=players.map(function(p,i){
      return {name:p.name,color:p.color||DEFAULT_COLORS[i],e:p.e||DEFAULT_EMOJIS[i],
              tokens:[-1,-1,-1,-1], // -1 = home yard, 0-51 = track, 100-105 = home path
              home:0,startPos:LU_START[i]};
    });
    luCur=0;luRollingL=false;
    showPage('pgLudo');setNav('games');snd('whoosh');
    drawLudoBoard();renderLuPlayers();
    document.getElementById('luLog').textContent='Game started! '+luPlayers[0].name+'\'s turn ';
  });
}

function drawLudoBoard(){
  var svg=document.getElementById('ludoSVG');svg.innerHTML='';
  var S=450,sq=30; // 15 columns x 15 rows = 450/30 = 15
  // Colors for zones
  var zc=['#FF4444','#4444FF','#44BB44','#FFD700'];
  var znames=['Red','Blue','Green','Yellow'];
  // Full background
  svg.innerHTML='<rect width="450" height="450" fill="#fff" rx="6"/>';
  // Draw 15x15 grid
  for(var r=0;r<15;r++){for(var c=0;c<15;c++){
    var col=getCellColor(r,c,sq,zc);
    if(col){svg.innerHTML+='<rect x="'+(c*sq)+'" y="'+(r*sq)+'" width="'+sq+'" height="'+sq+'" fill="'+col+'" stroke="#ddd" stroke-width="0.5"/>';}
  }}
  // Home zones (6x6 in corners)
  // Top-left Red
  svg.innerHTML+='<rect x="0" y="0" width="'+(6*sq)+'" height="'+(6*sq)+'" fill="#FF4444" stroke="#CC0000" stroke-width="2" rx="4"/>';
  svg.innerHTML+='<rect x="'+(sq)+'" y="'+(sq)+'" width="'+(4*sq)+'" height="'+(4*sq)+'" fill="#fff" stroke="#FF4444" stroke-width="2" rx="4"/>';
  svg.innerHTML+='<text x="'+(3*sq)+'" y="'+(3.5*sq)+'" font-size="28" text-anchor="middle" dominant-baseline="middle"></text>';
  // Top-right Blue
  svg.innerHTML+='<rect x="'+(9*sq)+'" y="0" width="'+(6*sq)+'" height="'+(6*sq)+'" fill="#4444FF" stroke="#0000CC" stroke-width="2" rx="4"/>';
  svg.innerHTML+='<rect x="'+(10*sq)+'" y="'+(sq)+'" width="'+(4*sq)+'" height="'+(4*sq)+'" fill="#fff" stroke="#4444FF" stroke-width="2" rx="4"/>';
  svg.innerHTML+='<text x="'+(12*sq)+'" y="'+(3.5*sq)+'" font-size="28" text-anchor="middle" dominant-baseline="middle"></text>';
  // Bottom-left Green
  svg.innerHTML+='<rect x="0" y="'+(9*sq)+'" width="'+(6*sq)+'" height="'+(6*sq)+'" fill="#44BB44" stroke="#229922" stroke-width="2" rx="4"/>';
  svg.innerHTML+='<rect x="'+(sq)+'" y="'+(10*sq)+'" width="'+(4*sq)+'" height="'+(4*sq)+'" fill="#fff" stroke="#44BB44" stroke-width="2" rx="4"/>';
  svg.innerHTML+='<text x="'+(3*sq)+'" y="'+(12.5*sq)+'" font-size="28" text-anchor="middle" dominant-baseline="middle"></text>';
  // Bottom-right Yellow
  svg.innerHTML+='<rect x="'+(9*sq)+'" y="'+(9*sq)+'" width="'+(6*sq)+'" height="'+(6*sq)+'" fill="#FFD700" stroke="#CC9900" stroke-width="2" rx="4"/>';
  svg.innerHTML+='<rect x="'+(10*sq)+'" y="'+(10*sq)+'" width="'+(4*sq)+'" height="'+(4*sq)+'" fill="#fff" stroke="#FFD700" stroke-width="2" rx="4"/>';
  svg.innerHTML+='<text x="'+(12*sq)+'" y="'+(12.5*sq)+'" font-size="28" text-anchor="middle" dominant-baseline="middle"></text>';
  // Center winning zone
  svg.innerHTML+='<rect x="'+(6*sq)+'" y="'+(6*sq)+'" width="'+(3*sq)+'" height="'+(3*sq)+'" fill="#FFD700" stroke="#CC9900" stroke-width="2"/>';
  svg.innerHTML+='<text x="'+(7.5*sq)+'" y="'+(7.8*sq)+'" font-size="26" text-anchor="middle" dominant-baseline="middle"></text>';
  // Token group
  svg.innerHTML+='<g id="luTokens"></g>';
  renderLuTokensSVG();
}

function getCellColor(r,c,sq,zc){
  // Safe cells
  if((r===2&&c===6)||(r===6&&c===2)||(r===8&&c===2)||(r===12&&c===6))return '#E8FFE8';
  if((r===6&&c===12)||(r===2&&c===8)||(r===8&&c===12)||(r===12&&c===8))return '#E8FFE8';
  // Home columns
  if(r>=1&&r<=5&&c===7)return '#FF4444';
  if(r>=1&&r<=5&&c===7)return '#FF4444';
  if(c>=1&&c<=5&&r===7)return '#44BB44';
  if(c>=9&&c<=13&&r===7)return '#4444FF';
  if(r>=9&&r<=13&&c===7)return '#FFD700';
  return null; // no special color = default white
}

function luTokenPos(playerIdx,tokenIdx){
  var p=luPlayers[playerIdx];var t=p.tokens[tokenIdx];
  var sq=30;
  // In home yard
  if(t===-1){
    var homeX=[1,10,1,10][playerIdx],homeY=[1,1,10,10][playerIdx];
    var ox=[1,3,1,3][tokenIdx%4],oy=[1,1,3,3][tokenIdx%4];
    return {x:(homeX+ox)*sq-sq/2,y:(homeY+oy)*sq-sq/2,inYard:true};
  }
  // Won
  if(t>=100){return {x:7.5*sq,y:7.5*sq,won:true};}
  // On board  simplified positioning along perimeter
  var track=getLuTrack();var pos=(t+p.startPos)%52;
  if(pos<track.length){var cell=track[pos];return {x:cell.c*sq+sq/2,y:cell.r*sq+sq/2};}
  return {x:7.5*sq,y:7.5*sq};
}

function getLuTrack(){
  // 52 cell standard Ludo outer track (row,col) starting from red start
  return [
    {r:6,c:1},{r:6,c:2},{r:6,c:3},{r:6,c:4},{r:6,c:5},{r:5,c:6},
    {r:4,c:6},{r:3,c:6},{r:2,c:6},{r:1,c:6},{r:0,c:6},{r:0,c:7},
    {r:0,c:8},{r:1,c:8},{r:2,c:8},{r:3,c:8},{r:4,c:8},{r:5,c:8},
    {r:6,c:9},{r:6,c:10},{r:6,c:11},{r:6,c:12},{r:6,c:13},{r:6,c:14},
    {r:7,c:14},{r:8,c:14},{r:8,c:13},{r:8,c:12},{r:8,c:11},{r:8,c:10},
    {r:8,c:9},{r:9,c:8},{r:10,c:8},{r:11,c:8},{r:12,c:8},{r:13,c:8},
    {r:14,c:8},{r:14,c:7},{r:14,c:6},{r:13,c:6},{r:12,c:6},{r:11,c:6},
    {r:10,c:6},{r:9,c:6},{r:8,c:5},{r:8,c:4},{r:8,c:3},{r:8,c:2},
    {r:8,c:1},{r:8,c:0},{r:7,c:0},{r:6,c:0}
  ];
}

function renderLuTokensSVG(){
  var g=document.getElementById('luTokens');if(!g)return;g.innerHTML='';
  luPlayers.forEach(function(p,pi){
    p.tokens.forEach(function(t,ti){
      var pos=luTokenPos(pi,ti);if(pos.won)return;
      var isCur=pi===luCur&&(t===-1||t>=0);
      g.innerHTML+='<circle cx="'+pos.x+'" cy="'+pos.y+'" r="'+(isCur?12:10)+'" fill="'+p.color+'" stroke="#fff" stroke-width="2.5" opacity="'+(isCur?1:.8)+'"'+(isCur?' style="animation:pulse 1s ease-in-out infinite"':'')+'/>';
      g.innerHTML+='<text x="'+(pos.x-5)+'" y="'+(pos.y+4)+'" font-size="10" font-family="sans-serif">'+p.e+'</text>';
    });
  });
}

function renderLuPlayers(){
  var el=document.getElementById('luPlayers');if(!el)return;el.innerHTML='';
  luPlayers.forEach(function(p,i){
    var d=document.createElement('div');d.className='lu-chip'+(i===luCur?' cur':'');
    d.style.cssText='background:'+p.color+'22;border-color:'+(i===luCur?p.color:'transparent')+';';
    var out=p.tokens.filter(function(t){return t>-1&&t<100;}).length;
    var home=p.home||0;
    d.innerHTML='<div style="font-size:11px;font-weight:800;color:'+p.color+';">'+p.e+' '+p.name+'</div><div style="font-size:10px;color:'+p.color+';opacity:.8;">Out:'+out+' Home:'+home+'</div>';
    el.appendChild(d);
  });
}

function luRoll(){
  if(luRollingL)return;luRollingL=true;snd('dice');
  var btn=document.getElementById('luDice');btn.textContent=' Rolling...';
  setTimeout(function(){
    var dice=Math.floor(Math.random()*6)+1;luLastDice=dice;
    var p=luPlayers[luCur];
    var log=p.e+' '+p.name+' rolled '+dice+'! ';
    var moved=false;
    // Try to move a token that's already out
    var outTokens=p.tokens.map(function(t,i){return {t:t,i:i};}).filter(function(x){return x.t>=0&&x.t<100;});
    // Bring out token on 6
    if(dice===6){
      var inYard=p.tokens.indexOf(-1);
      if(inYard>-1){p.tokens[inYard]=0;log+='Token out! ';snd('ok');moved=true;}
    }
    if(!moved&&outTokens.length>0){
      // Move furthest token
      var best=outTokens.reduce(function(a,b){return a.t>b.t?a:b;});
      var newPos=best.t+dice;
      if(newPos>=52){// entering home path
        newPos=100+(newPos-52);
        if(newPos>=106){p.home=(p.home||0)+1;p.tokens[best.i]=200;log+='Token home! ';snd('ok');confetti();addXP(10);moved=true;}
        else{p.tokens[best.i]=newPos;log+='Moving! Pos:'+newPos;snd('ludo');moved=true;}
      }else{p.tokens[best.i]=newPos;log+='Moving to '+newPos;snd('ludo');moved=true;}
    }
    if(!moved){log+='No valid move! Roll 6 to start.';}
    var allHome=p.tokens.every(function(t){return t===200||t>=100;});
    if((p.home||0)>=4||allHome){log+='  '+p.name+' WINS!';document.getElementById('luDice').disabled=true;confetti();snd('win');addXP(25);}
    document.getElementById('luLog').textContent=log;
    renderLuTokensSVG();renderLuPlayers();
    btn.textContent=' Roll Dice!';
    if(dice!==6||(dice===6&&!moved))luCur=(luCur+1)%luPlayers.length;
    luRollingL=false;renderLuPlayers();
  },600);
}

//  LEARN 
function renderLearn(){var g1=document.getElementById('lg1'),g2=document.getElementById('lg2');if(!g1||!g2)return;g1.innerHTML='';g2.innerHTML='';TOPICS.forEach(function(t,i){var d=document.createElement('div');d.className='topic-card ripple-wrap';d.style.animationDelay=(i*.06)+'s';d.innerHTML='<div class="topic-ico">'+t.ico+'</div><div class="topic-title">'+t.title+'</div><div class="topic-sub">'+t.sub+'</div><div class="topic-prog"><div style="height:100%;width:0%;background:'+t.col+';border-radius:3px;"></div></div>';d.onclick=function(e){addRipple(e,d);snd('tap');openTopic(t);};if(t.age===1)g1.appendChild(d);else g2.appendChild(d);});}
function openTopic(t){CURRTOPIC=t;document.getElementById('topicTitle').textContent=t.ico+' '+t.title;showPage('pgTopic');snd('whoosh');var el=document.getElementById('topicGrid');el.innerHTML='';t.items.forEach(function(item,i){var d=document.createElement('div');d.className='lrn-card ripple-wrap';d.style.animationDelay=(i*.04)+'s';d.innerHTML='<span class="lrn-e">'+item.e+'</span><div class="lrn-w">'+item.w+'</div><div class="lrn-n">'+item.n+'</div>';d.onclick=function(e){addRipple(e,d);snd('tap');};el.appendChild(d);});}
function startQuiz(){if(!CURRTOPIC)return;QITEMS=CURRTOPIC.items.filter(function(x){return x.w&&x.n;}).slice(0,8);if(QITEMS.length<4){alert('Not enough items for quiz!');return;}QIDX=0;QSCORE=0;showPage('pgQuiz');snd('whoosh');renderQ();}
function renderQ(){var wrap=document.getElementById('quizWrap');if(QIDX>=QITEMS.length){showQResult(wrap);return;}var q=QITEMS[QIDX];var wrong=QITEMS.filter(function(x,i){return i!==QIDX;}).sort(function(){return Math.random()-.5;}).slice(0,3).map(function(x){return x.w;});var opts=[q.w].concat(wrong).sort(function(){return Math.random()-.5;});var pct=Math.round((QIDX/QITEMS.length)*100);wrap.innerHTML='<div><div class="q-prog-bar"><div class="q-prog-fill" style="width:'+pct+'%"></div></div><div style="font-size:11px;font-weight:700;color:var(--sub);margin-top:4px;">Question '+(QIDX+1)+' / '+QITEMS.length+'</div></div><div class="quiz-question"><span class="q-emoji">'+q.e+'</span><div class="q-text">What is this?</div></div><div class="quiz-opts">'+opts.map(function(o,oi){return '<button class="q-opt ripple-wrap" id="qo'+oi+'" onclick="addRipple(event,this);ansQ(\''+o.replace(/'/g,'')+'\','+oi+',\''+q.w.replace(/'/g,'')+'\')">'+o+'</button>';}).join('')+'</div>';}
function ansQ(val,idx,correct){var isCorr=val===correct;document.querySelectorAll('.q-opt').forEach(function(b){b.onclick=null;});document.getElementById('qo'+idx).classList.add(isCorr?'correct':'wrong');if(isCorr){QSCORE++;snd('ok');}else{snd('no');document.querySelectorAll('.q-opt').forEach(function(b){if(b.textContent===correct)b.classList.add('correct');});}QIDX++;setTimeout(renderQ,900);}
function showQResult(wrap){var pct=Math.round((QSCORE/QITEMS.length)*100);var stars=pct>=80?'':pct>=60?'':'';var msg=pct>=80?'Excellent! ':pct>=60?'Well Done! ':'Keep practicing! ';wrap.innerHTML='<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:11px;"><div style="font-size:44px;animation:pop .4s ease;">'+stars+'</div><div style="font-family:Lilita One,cursive;font-size:24px;color:var(--a);">'+msg+'</div><div style="font-size:15px;font-weight:700;color:var(--sub);">'+QSCORE+' / '+QITEMS.length+' correct ('+pct+'%)</div><button class="quiz-start ripple-wrap" style="max-width:280px;" onclick="addRipple(event,this);startQuiz()"> Try Again</button><button class="quiz-start ripple-wrap" style="max-width:280px;background:linear-gradient(135deg,#4CAF50,#2E7D32);box-shadow:0 5px 0 #1B5E20;margin-top:6px;" onclick="addRipple(event,this);showPage(\'pgTopic\')"> Back</button></div>';confetti();snd(pct>=80?'win':'ok');addXP(pct>=80?15:pct>=60?10:5);}

//  SETTINGS 
function renderSettings(){
  var ch=getChar();
  var av=document.getElementById('settAv');if(av)av.textContent=ch.e;
  var sn=document.getElementById('settName');if(sn)sn.textContent=U.name||'Player';
  var r=getRank(XP),nr=getNextRank(XP);
  var sr=document.getElementById('settRank');if(sr)sr.textContent=r.ico+' '+r.title;
  var sx=document.getElementById('settXP');if(sx)sx.textContent=XP;
  var ss=document.getElementById('settStreak');if(ss)ss.textContent=SK.count;
  var srd=document.getElementById('settReads');if(srd)srd.textContent=Object.values(STATS).reduce(function(a,b){return a+b;},0);
  var rp=document.getElementById('rankProgressWrap');
  if(rp){var pct=nr?Math.round(((XP-r.min)/(nr.min-r.min))*100):100;rp.innerHTML='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;"><div style="font-size:13px;font-weight:800;color:var(--text);">'+r.ico+' '+r.title+'</div>'+(nr?'<div style="font-size:11px;color:var(--sub);"> '+nr.ico+' '+nr.title+'</div>':'<div style="font-size:11px;color:#FFD700;font-weight:800;">MAX RANK! </div>')+'</div><div class="xp-bar-bg" style="width:100%;height:10px;"><div class="xp-bar-fill" style="width:'+pct+'%;height:100%;"></div></div><div style="font-size:10px;color:var(--sub);margin-top:4px;">'+XP+' XP'+(nr?'  '+(nr.min-XP)+' to '+nr.title:'')+'</div><div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:6px;">'+RANKS.map(function(rk){var reached=XP>=rk.min;return '<div style="display:flex;align-items:center;gap:4px;padding:4px 8px;border-radius:9px;background:'+(reached?'rgba(255,107,0,.12)':'rgba(0,0,0,.04)')+';border:2px solid '+(reached?'var(--a)':'transparent')+';"><span>'+rk.ico+'</span><span style="font-size:10px;font-weight:800;color:'+(reached?'var(--a)':'#bbb')+';">'+rk.title+'</span><span style="font-size:9px;color:var(--sub);">('+rk.min+')</span></div>';}).join('')+'</div>';}
  var bw=document.getElementById('badgesWrap');if(bw){bw.innerHTML='';BDEFS.forEach(function(b){var earned=BADGES.indexOf(b.id)>-1;var d=document.createElement('div');d.className='badge-chip'+(earned?'':' locked');d.innerHTML='<span style="font-size:15px">'+b.ico+'</span><span style="font-size:10px;font-weight:700;color:var(--text)">'+b.name+'</span>';bw.appendChild(d);});}
  var hl=document.getElementById('histList');if(hl){hl.innerHTML='';if(!HIST.length){hl.innerHTML='<div style="padding:11px;text-align:center;font-size:12px;color:#bbb;font-weight:700;">No history yet</div>';}else{HIST.slice(0,5).forEach(function(h){var d=document.createElement('div');d.style.cssText='display:flex;align-items:center;gap:8px;padding:8px 13px;border-bottom:1px solid rgba(0,0,0,.04);cursor:pointer;';d.innerHTML='<div style="width:30px;height:38px;border-radius:6px;overflow:hidden;background:#FFB300;flex-shrink:0;"><img src="'+h.t+'" onerror="this.parentElement.textContent=\'\'" style="width:100%;height:100%;object-fit:cover;"></div><div style="flex:1;font-size:11px;font-weight:700;color:var(--text);">'+h.name+'</div><div style="font-size:10px;color:var(--sub);">'+h.date+'</div>';var c=COMICS.find(function(x){return x.id===h.id;});if(c)d.onclick=function(){openComic(c);};hl.appendChild(d);});}}
  var tc=document.getElementById('settTotal');if(tc){var hi=COMICS.filter(function(c){return c.lang==='hi'&&!c.isHidden;}).length,en=COMICS.filter(function(c){return c.lang==='en'&&!c.isHidden;}).length;tc.textContent=COMICS.filter(function(c){return !c.isHidden;}).length+' ('+hi+' Hindi, '+en+' English)';}
  var td=document.getElementById('td-'+U.theme);if(td){document.querySelectorAll('.tdot').forEach(function(x){x.classList.remove('on');});td.classList.add('on');}
  document.getElementById('darkToggle').classList.toggle('on',!!U.dark);
  document.getElementById('soundToggle').classList.toggle('on',!!U.sound);
  var ic=document.getElementById('inboxCount');var unread=REPLIES.filter(function(r){return r.reply&&!r.userRead;}).length;if(ic)ic.textContent=unread>0?unread+' unread replies':'Dev replies will appear here';
  updateXPBar();
}
function setTheme(t){U.theme=t;saveU();applyTheme(t);document.querySelectorAll('.tdot').forEach(function(x){x.classList.remove('on');});var td=document.getElementById('td-'+t);if(td)td.classList.add('on');snd('tap');}
function applyTheme(t){document.body.className=document.body.className.replace(/theme-\w+/g,'').trim();if(t!=='orange')document.body.classList.add('theme-'+t);if(U.dark)document.body.classList.add('dark');}
function toggleDark(){U.dark=!U.dark;saveU();applyDark(U.dark);snd('tap');}
function applyDark(d){document.body.classList.toggle('dark',!!d);var t=document.getElementById('darkToggle');if(t)t.classList.toggle('on',!!d);}
function toggleSound(){U.sound=!U.sound;saveU();var t=document.getElementById('soundToggle');if(t)t.classList.toggle('on',U.sound);if(U.sound)snd('tap');}

//  FEEDBACK 
var FBTYPE='idea';
function selectFbType(btn,t){FBTYPE=t;document.querySelectorAll('.fb-type-btn').forEach(function(b){b.classList.remove('sel');});btn.classList.add('sel');snd('tap');}
function submitFeedback(){
  var msg=document.getElementById('fbMsg').value.trim();
  if(!msg){document.getElementById('fbMsg').style.animation='shake .3s ease';setTimeout(function(){document.getElementById('fbMsg').style.animation='';},400);return;}
  var entry={id:Date.now(),type:FBTYPE,name:U.name||'Anonymous',msg:msg,time:new Date().toLocaleString(),reply:null,replyTime:null,userRead:false};
  FB.push(entry);ls('ch_fb',FB);REPLIES.push(entry);ls('ch_rp',REPLIES);
  document.getElementById('fbMsg').value='';snd('ok');confetti();
  var fb=document.querySelector('.fb-form');var orig=fb.innerHTML;
  fb.innerHTML='<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:50px 18px;text-align:center;gap:11px;"><div style="font-size:70px"></div><div style="font-family:Lilita One,cursive;font-size:22px;color:var(--a);">Message Sent!</div><div style="font-size:13px;color:var(--sub);font-weight:700;line-height:1.7;">Reached developer Baadal! <br><br>Check Settings  Inbox for reply </div></div>';
  setTimeout(function(){fb.innerHTML=orig;document.querySelectorAll('.fb-type-btn')[0].classList.add('sel');},3800);
}

//  DEV PANEL (Full Control) 
function tapLogo(){snd('tap');LTAPS++;clearTimeout(LTIMER);if(LTAPS>=5){LTAPS=0;openPwModal();}else{LTIMER=setTimeout(function(){LTAPS=0;},2000);}}
function openPwModal(){document.getElementById('pwIn').value='';document.getElementById('pwErr').textContent='';document.getElementById('pwModal').classList.add('show');setTimeout(function(){document.getElementById('pwIn').focus();},100);}
function closePwModal(){document.getElementById('pwModal').classList.remove('show');}
function checkPw(){var v=document.getElementById('pwIn').value;if(v===DEV_PW){DEV_ON=true;closePwModal();showPage('pgDev');renderDevPanel();snd('ok');}else{document.getElementById('pwErr').textContent=' Wrong password!';snd('no');document.getElementById('pwIn').value='';}}
function devLock(){DEV_ON=false;showPage('pgHome');setNav('home');}

function renderDevPanel(){
  if(!DEV_ON)return;
  var tot=Object.values(STATS).reduce(function(a,b){return a+b;},0);
  var lb=ls('ch_lb')||[];
  document.getElementById('devStats').innerHTML=
    '<div class="dev-stat"><div class="dev-stat-n">'+COMICS.filter(function(c){return !c.isHidden;}).length+'</div><div class="dev-stat-l">Comics</div></div>'+
    '<div class="dev-stat"><div class="dev-stat-n">'+tot+'</div><div class="dev-stat-l">Total Opens</div></div>'+
    '<div class="dev-stat"><div class="dev-stat-n">'+FB.length+'</div><div class="dev-stat-l">Messages</div></div>'+
    '<div class="dev-stat"><div class="dev-stat-n">'+lb.length+'</div><div class="dev-stat-l">LB Players</div></div>'+
    '<div class="dev-stat"><div class="dev-stat-n">'+FAVS.length+'</div><div class="dev-stat-l">Favourites</div></div>'+
    '<div class="dev-stat"><div class="dev-stat-n">'+BADGES.length+'</div><div class="dev-stat-l">Badges</div></div>';
  // Top 3
  var sorted=COMICS.map(function(c){return {c:c,n:STATS[c.id]||0};}).sort(function(a,b){return b.n-a.n;}).slice(0,3);
  var icons=['','',''];var mx=sorted[0]?sorted[0].n:1;
  var t3=document.getElementById('devTop3');t3.innerHTML='<div style="font-size:10px;font-weight:700;color:#888;margin-bottom:7px;">TOP 3 MOST READ</div>';
  sorted.forEach(function(item,i){var d=document.createElement('div');d.style.cssText='display:flex;align-items:center;gap:7px;margin-bottom:6px;';d.innerHTML='<div style="font-size:16px;">'+icons[i]+'</div><div style="flex:1;"><div style="font-size:10px;color:#aaa;font-weight:700;">'+item.c.name+'</div><div style="height:5px;background:linear-gradient(90deg,var(--a),var(--a2));border-radius:3px;width:'+(mx>0?Math.round((item.n/mx)*100):0)+'%;margin-top:2px;"></div></div><div style="font-size:11px;color:#FFD700;font-weight:800;">'+item.n+'x</div>';t3.appendChild(d);});
  // Users (from leaderboard)
  var ul=document.getElementById('devUserList');ul.innerHTML='';
  document.getElementById('devUserCount').textContent='('+lb.length+')';
  if(!lb.length){ul.innerHTML='<div style="color:#888;font-size:12px;padding:8px;">No users on leaderboard yet.</div>';}
  else{lb.forEach(function(u,i){var d=document.createElement('div');d.className='dev-user-row';d.innerHTML='<div style="font-size:20px;">'+u.avatar+'</div><div style="flex:1;"><div style="font-size:11px;font-weight:800;color:#e8e0ff;">'+u.name+'</div><div style="font-size:9px;color:#888;">'+u.rankIco+' '+u.rank+'  '+u.xp+' XP  Streak: '+u.streak+'</div></div><div style="font-size:10px;color:#FFD700;font-weight:800;">#'+(i+1)+'</div>';ul.appendChild(d);});}
  // Comics
  document.getElementById('devCC').textContent='('+COMICS.length+')';
  var cl=document.getElementById('devComics');cl.innerHTML='';
  COMICS.forEach(function(c,i){var d=document.createElement('div');d.className='dev-cr';d.style.opacity=c.isHidden?'.5':'1';d.innerHTML='<div class="dev-cn">'+(c.isPinned?' ':'')+(c.isNew?' ':'')+(c.isHidden?' ':'')+c.name+'</div><div class="dev-cm">'+c.lang.toUpperCase()+'  '+(c.date||'')+'  '+(STATS[c.id]||0)+' opens</div><div class="dev-btns"><button class="dev-btn dbe" onclick="devEdit('+c.id+')"> Edit</button><button class="dev-btn dbh" onclick="devHide('+c.id+')">'+(c.isHidden?' Show':' Hide')+'</button><button class="dev-btn dbp" onclick="devPin('+c.id+')">'+(c.isPinned?' Unpin':' Pin')+'</button><button class="dev-btn dbn" onclick="devNew('+c.id+')">'+(c.isNew?' Unmark':' Mark New')+'</button>'+(i>0?'<button class="dev-btn dbu" onclick="devMove('+c.id+',-1)"></button>':'')+(i<COMICS.length-1?'<button class="dev-btn dbu" onclick="devMove('+c.id+',1)"></button>':'')+'<button class="dev-btn dbd" onclick="devDel('+c.id+')"> Del</button><button class="dev-btn dbr" onclick="devSetThumb('+c.id+')"> Thumb</button></div>';cl.appendChild(d);});
  document.getElementById('devAnnTxt').value=ANN.text||'';
  document.getElementById('devAnnExp').value=ANN.expiry||'';
  document.getElementById('devMaintT').classList.toggle('on',MAINT);
  // Feedback
  var fl=document.getElementById('devFbList');fl.innerHTML='';
  document.getElementById('devFbC').textContent='('+FB.length+')';
  var icoMap={idea:'',bug:'',msg:'',request:''};
  if(!FB.length){fl.innerHTML='<div style="color:#888;font-size:12px;padding:8px;">No messages yet.</div>';}
  else{FB.slice().reverse().forEach(function(f){var d=document.createElement('div');d.className='fb-mi';
    var existing=REPLIES.find(function(r){return r.id===f.id;});
    d.innerHTML='<div style="font-size:9px;font-weight:800;color:var(--a);">'+(icoMap[f.type]||'')+' '+f.type+'</div><div style="font-size:9px;font-weight:700;color:#aaa;">'+f.name+'  '+f.time+'</div><div style="font-size:11px;color:#e8e0ff;margin:3px 0;line-height:1.5;">'+f.msg+'</div>'+(existing&&existing.reply?'<div style="font-size:10px;color:#4CAF50;margin-top:4px;"> Replied: '+existing.reply+'</div>':'')+'<div class="dev-reply-wrap"><input class="dev-reply-in" id="ri'+f.id+'" placeholder="Type reply..." value="'+(existing&&existing.reply?existing.reply:'')+'" /><button class="dev-reply-btn" onclick="devSendReply('+f.id+')"> Reply</button></div>';
    fl.appendChild(d);});}
}
function devSendReply(fid){var inp=document.getElementById('ri'+fid);if(!inp)return;var reply=inp.value.trim();if(!reply){alert('Reply empty!');return;}var entry=REPLIES.find(function(r){return r.id===fid;});if(entry){entry.reply=reply;entry.replyTime=new Date().toLocaleString();entry.userRead=false;}ls('ch_rp',REPLIES);addNotif(' Baadal','Developer replied: "'+reply.slice(0,45)+'"',true);snd('notif');renderDevPanel();alert('Reply sent! ');}
function devAdd(){var name=document.getElementById('daN').value.trim(),url=document.getElementById('daU').value.trim(),lang=document.getElementById('daL').value,date=document.getElementById('daD').value.trim(),pages=parseInt(document.getElementById('daP').value)||0;if(!name||!url){alert('Name and URL required!');return;}var nid=Math.max.apply(null,COMICS.map(function(c){return c.id;}).concat([0]))+1;COMICS.push({id:nid,name:name,lang:lang,isNew:true,isPinned:false,isHidden:false,flipUrl:url,pages:pages||undefined,date:date||undefined});saveC();renderDevPanel();renderHome();checkNewBadge();['daN','daU','daD','daP'].forEach(function(id){var el=document.getElementById(id);if(el)el.value='';});snd('ok');addNotif(' New Comic','Added: '+name);alert('Comic added! ');}
function devEdit(id){var c=COMICS.find(function(x){return x.id===id;});if(!c)return;var n=prompt('Name:',c.name);if(n===null)return;var da=prompt('Date:',c.date||'');var pg=prompt('Pages:',c.pages||'');var url=prompt('URL:',c.flipUrl||'');c.name=n.trim()||c.name;c.date=da||undefined;c.pages=parseInt(pg)||undefined;if(url&&url.trim())c.flipUrl=url.trim();saveC();renderDevPanel();renderHome();}
function devSetThumb(id){var c=COMICS.find(function(x){return x.id===id;});if(!c)return;var t=prompt('Thumbnail URL (leave empty to auto):',c.thumbUrl||'');c.thumbUrl=t&&t.trim()?t.trim():undefined;saveC();renderDevPanel();renderHome();}
function devHide(id){var c=COMICS.find(function(x){return x.id===id;});if(c){c.isHidden=!c.isHidden;saveC();renderDevPanel();renderHome();checkNewBadge();}}
function devPin(id){var c=COMICS.find(function(x){return x.id===id;});if(c){c.isPinned=!c.isPinned;saveC();renderDevPanel();renderHome();}}
function devNew(id){var c=COMICS.find(function(x){return x.id===id;});if(c){c.isNew=!c.isNew;saveC();renderDevPanel();checkNewBadge();}}
function devMove(id,dir){var idx=COMICS.findIndex(function(x){return x.id===id;});var ni=idx+dir;if(ni<0||ni>=COMICS.length)return;var tmp=COMICS[idx];COMICS[idx]=COMICS[ni];COMICS[ni]=tmp;saveC();renderDevPanel();renderHome();}
function devDel(id){if(!confirm('Delete this comic?'))return;COMICS=COMICS.filter(function(x){return x.id!==id;});saveC();renderDevPanel();renderHome();checkNewBadge();}
function devSaveAnn(){ANN={active:true,text:document.getElementById('devAnnTxt').value.trim(),expiry:document.getElementById('devAnnExp').value.trim()};ls('ch_an',ANN);renderAnn();addNotif(' Announcement',ANN.text.slice(0,50));alert('Announcement saved! ');}
function devHideAnn(){ANN.active=false;ls('ch_an',ANN);renderAnn();alert('Announcement hidden.');}
function devToggleMaint(){MAINT=!MAINT;ls('ch_mt',MAINT);document.getElementById('devMaintT').classList.toggle('on',MAINT);alert(MAINT?'Maintenance ON  users see Coming Soon':'Maintenance OFF');}
function devClearFb(){if(!confirm('Clear ALL feedback?'))return;FB=[];ls('ch_fb',FB);renderDevPanel();}
function devResetAllXP(){if(!confirm('RESET your XP to 0? (Only resets on this device)'))return;XP=0;ls('ch_xp',XP);BADGES=[];ls('ch_bd',BADGES);updateXPBar();alert('XP reset.');}
function devClearNotifs(){NOTIFS=[];ls('ch_no',NOTIFS);updateNotifDot();alert('Notifications cleared.');}
function devClearLB(){if(!confirm('Clear leaderboard data on this device?'))return;ls('ch_lb',[]);LB_CACHE=[];alert('Leaderboard cleared.');}
function devBackup(){var json=JSON.stringify(COMICS,null,2);document.getElementById('devRI').value=json;if(navigator.clipboard)navigator.clipboard.writeText(json).then(function(){alert('Copied to clipboard! ');}).catch(function(){alert('JSON shown below  copy manually.');});else alert('JSON shown below  copy manually.');}
function devRestore(){try{var p=JSON.parse(document.getElementById('devRI').value);if(!Array.isArray(p))throw new Error('Not array');COMICS=p;saveC();renderDevPanel();renderHome();alert('Restored! ');}catch(e){alert('Invalid JSON!');}}
function devChangePass(){var p1=document.getElementById('devP1').value,p2=document.getElementById('devP2').value;if(!p1){alert('Password cannot be empty!');return;}if(p1!==p2){alert('Passwords do not match!');return;}DEV_PW=p1;ls('ch_pw',DEV_PW);document.getElementById('devP1').value='';document.getElementById('devP2').value='';snd('ok');alert('Password changed! ');}

//  NAV / PAGES 
function setNav(n){document.querySelectorAll('.nav-item').forEach(function(x){delete x.dataset.active;x.querySelector('.nav-ico').classList.remove('act-ico');});var el=document.getElementById('nav-'+n);if(el){el.dataset.active='1';el.querySelector('.nav-ico').classList.add('act-ico');}}

//  ANDROID BACK BUTTON HISTORY 
var PAGE_HISTORY=['pgHome'];
var _showPageRaw=function(id){
  document.querySelectorAll('.page').forEach(function(p){p.classList.remove('active');});
  var el=document.getElementById(id);if(el)el.classList.add('active');
};
function showPage(id){
  if(id==='pgSplash'||id==='pgOnboard'){_showPageRaw(id);return;}
  // Push state so Android back button triggers popstate
  try{history.pushState({pg:id},'','');}catch(e){}
  PAGE_HISTORY.push(id);
  _showPageRaw(id);
}
window.addEventListener('popstate',function(e){
  PAGE_HISTORY.pop();
  var prev=PAGE_HISTORY[PAGE_HISTORY.length-1]||'pgHome';
  _showPageRaw(prev);
  // Sync bottom nav
  var navMap={pgHome:'home',pgSeeAll:'comics',pgGames:'games',pgLearn:'learn',pgSettings:'settings'};
  if(navMap[prev])setNav(navMap[prev]);
});

function refreshPage(){var b=document.getElementById('refreshBtn');b.style.animation='spin .6s linear';setTimeout(function(){b.style.animation='';loadAll();renderHome();checkNewBadge();renderCOTD();updateRankDisplay();renderAnn();},700);snd('tap');}
function openLink(url){window.location.href=url;}

//  INIT 
(function(){
  try{
    var u=JSON.parse(localStorage.getItem('ch_u'));
    if(u&&u.dark)document.body.classList.add('dark');
    if(u&&u.theme&&u.theme!=='orange')document.body.classList.add('theme-'+u.theme);
  }catch(e){}
})();


// 
//  ARCADE ZONE JavaScript
// 

//  ARCADE TAB SWITCHER 
function switchArcadeTab(tab, btn) {
  document.querySelectorAll('.arc-tab').forEach(function(b){b.classList.remove('on');});
  btn.classList.add('on');
  document.getElementById('arcBuilt').style.display = 'none';
  document.getElementById('arcEmu').style.display   = tab==='emu'?'block':'none';
  document.getElementById('arcFree').style.display  = tab==='free'?'block':'none';
  if(tab==='free') renderFreeRoms();
  snd('tap');
}

//  FREE ROMS DATA (100% legal homebrew) 
var FREE_ROMS = [
  {name:'Alter Ego',genre:'Platformer',ico:'',url:'https://pdroms.de/files/nintendo-nintendoentertainmentsystem-nes-famicom/alter-ego'},
  {name:'D-Pad Hero',genre:'Rhythm',ico:'',url:'https://pdroms.de/files/nintendo-nintendoentertainmentsystem-nes-famicom/d-pad-hero'},
  {name:'Blade Buster',genre:'Shooter',ico:'',url:'https://pdroms.de/files/nintendo-nintendoentertainmentsystem-nes-famicom/blade-buster'},
  {name:'Battle Kid',genre:'Action',ico:'',url:'https://pdroms.de/files/nintendo-nintendoentertainmentsystem-nes-famicom/battle-kid-fortress-of-peril-v1-00'},
  {name:'Lawn Mower',genre:'Arcade',ico:'',url:'https://pdroms.de/files/nintendo-nintendoentertainmentsystem-nes-famicom/lawn-mower'},
  {name:'Lan Master',genre:'Puzzle',ico:'',url:'https://pdroms.de/files/nintendo-nintendoentertainmentsystem-nes-famicom/lan-master'},
  {name:'Chase',genre:'Action',ico:'',url:'https://pdroms.de/files/nintendo-nintendoentertainmentsystem-nes-famicom'},
  {name:'Haunted',genre:'Horror',ico:'',url:'https://pdroms.de/files/nintendo-nintendoentertainmentsystem-nes-famicom'},
];
function renderFreeRoms(){
  var el=document.getElementById('freeRomsGrid');if(!el||el.children.length>0)return;
  FREE_ROMS.forEach(function(r){
    var d=document.createElement('div');d.className='rom-card';
    d.innerHTML='<div class="rom-ico">'+r.ico+'</div><div class="rom-name">'+r.name+'</div><div class="rom-genre">'+r.genre+'</div><div style="font-size:9px;color:#FFD700;margin-top:5px;"> Download Free</div>';
    d.onclick=function(){
      if(confirm('Open '+r.name+' download page?\n\nDownload the .nes file, then load it in the Emulator tab!')){
        window.open(r.url,'_blank');
      }
    };
    el.appendChild(d);
  });
}

// 
//  TETRIS
// 
var TET={
  W:10,H:20,sz:20,
  board:null,cur:null,next:null,
  score:0,lines:0,level:1,
  timer:null,paused:false,over:false,
  canvas:null,ctx:null
};
var TET_PIECES=[
  {shape:[[1,1,1,1]],color:'#00F0F0'},                           // I
  {shape:[[1,1],[1,1]],color:'#F0F000'},                         // O
  {shape:[[0,1,0],[1,1,1]],color:'#A000F0'},                     // T
  {shape:[[1,0],[1,0],[1,1]],color:'#F0A000'},                   // L
  {shape:[[0,1],[0,1],[1,1]],color:'#0000F0'},                   // J
  {shape:[[0,1,1],[1,1,0]],color:'#00F000'},                     // S
  {shape:[[1,1,0],[0,1,1]],color:'#F00000'}                      // Z
];

function initTetris(){
  showPage('pgTetris');snd('whoosh');
  TET.canvas=document.getElementById('tetrisCanvas');
  TET.ctx=TET.canvas.getContext('2d');
  TET.sz=Math.floor(Math.min(
    (window.innerWidth-40)/TET.W,
    (window.innerHeight-220)/TET.H
  ));
  TET.canvas.width=TET.W*TET.sz;
  TET.canvas.height=TET.H*TET.sz;
  TET.board=Array.from({length:TET.H},function(){return Array(TET.W).fill(0);});
  TET.score=0;TET.lines=0;TET.level=1;TET.over=false;TET.paused=false;
  TET.cur=tetNewPiece();TET.next=tetNewPiece();
  clearInterval(TET.timer);
  tetTick();
  document.getElementById('tetPauseBtn').textContent=' Pause';
  updateTetUI();
}
function stopTetris(){clearInterval(TET.timer);TET.timer=null;}
function tetNewPiece(){
  var p=TET_PIECES[Math.floor(Math.random()*TET_PIECES.length)];
  return {shape:p.shape.map(function(r){return r.slice();}),color:p.color,
          x:Math.floor(TET.W/2)-Math.floor(p.shape[0].length/2),y:0};
}
function tetTick(){
  TET.timer=setTimeout(function(){
    if(!TET.paused&&!TET.over){
      if(!tetMoveDown()){tetPlace();}
      tetDraw();
    }
    if(!TET.over)tetTick();
  },Math.max(100,500-TET.level*45));
}
function tetMove(dx){
  if(TET.paused||TET.over)return;
  TET.cur.x+=dx;
  if(tetCollide())TET.cur.x-=dx;
  else snd('tap');
  tetDraw();
}
function tetRotate(){
  if(TET.paused||TET.over)return;
  var old=TET.cur.shape;
  TET.cur.shape=TET.cur.shape[0].map(function(_,i){return TET.cur.shape.map(function(r){return r[i];}).reverse();});
  if(tetCollide())TET.cur.shape=old;
  else snd('flip');
  tetDraw();
}
function tetDrop(){if(TET.paused||TET.over)return;while(tetMoveDown());tetPlace();tetDraw();}
function tetMoveDown(){TET.cur.y++;if(tetCollide()){TET.cur.y--;return false;}return true;}
function tetCollide(){
  return TET.cur.shape.some(function(row,dy){
    return row.some(function(v,dx){
      if(!v)return false;
      var nx=TET.cur.x+dx,ny=TET.cur.y+dy;
      return nx<0||nx>=TET.W||ny>=TET.H||(ny>=0&&TET.board[ny][nx]);
    });
  });
}
function tetPlace(){
  TET.cur.shape.forEach(function(row,dy){
    row.forEach(function(v,dx){
      if(v&&TET.cur.y+dy>=0)TET.board[TET.cur.y+dy][TET.cur.x+dx]=TET.cur.color;
    });
  });
  // Clear lines
  var cleared=0;
  for(var y=TET.H-1;y>=0;y--){
    if(TET.board[y].every(function(c){return c;})){
      TET.board.splice(y,1);TET.board.unshift(Array(TET.W).fill(0));
      cleared++;y++;
    }
  }
  if(cleared){
    var pts=[0,100,300,500,800];
    TET.score+=pts[cleared]*TET.level;
    TET.lines+=cleared;
    TET.level=Math.floor(TET.lines/10)+1;
    snd(cleared>=4?'win':'ok');
    if(cleared>=4)confetti();
  }
  addXP(Math.ceil(TET.score/100));
  TET.cur=TET.next;TET.next=tetNewPiece();
  if(tetCollide()){TET.over=true;snd('no');setTimeout(function(){alert('Game Over! Score: '+TET.score);},200);}
  updateTetUI();
}
function updateTetUI(){
  document.getElementById('tetScore').textContent=TET.score;
  document.getElementById('tetLevel').textContent=TET.level;
  document.getElementById('tetLines').textContent=TET.lines;
}
function tetrisPause(){
  TET.paused=!TET.paused;
  document.getElementById('tetPauseBtn').textContent=TET.paused?' Resume':' Pause';
  snd('tap');
}
function tetDraw(){
  var ctx=TET.ctx,sz=TET.sz;
  ctx.fillStyle='#0a0a1a';ctx.fillRect(0,0,TET.canvas.width,TET.canvas.height);
  // Grid lines
  ctx.strokeStyle='rgba(255,255,255,.05)';ctx.lineWidth=0.5;
  for(var x=0;x<=TET.W;x++){ctx.beginPath();ctx.moveTo(x*sz,0);ctx.lineTo(x*sz,TET.H*sz);ctx.stroke();}
  for(var y=0;y<=TET.H;y++){ctx.beginPath();ctx.moveTo(0,y*sz);ctx.lineTo(TET.W*sz,y*sz);ctx.stroke();}
  // Board
  TET.board.forEach(function(row,y){row.forEach(function(col,x){if(col){tetDrawCell(ctx,x,y,col,sz);}});});
  // Ghost piece
  var ghost={x:TET.cur.x,y:TET.cur.y,shape:TET.cur.shape,color:TET.cur.color};
  while(true){ghost.y++;var ok=!ghost.shape.some(function(row,dy){return row.some(function(v,dx){if(!v)return false;var nx=ghost.x+dx,ny=ghost.y+dy;return nx<0||nx>=TET.W||ny>=TET.H||(ny>=0&&TET.board[ny][nx]);});});if(!ok){ghost.y--;break;}}
  ghost.shape.forEach(function(row,dy){row.forEach(function(v,dx){if(v){ctx.fillStyle='rgba(255,255,255,.15)';ctx.fillRect((ghost.x+dx)*sz,(ghost.y+dy)*sz,sz-1,sz-1);}});});
  // Current piece
  TET.cur.shape.forEach(function(row,dy){row.forEach(function(v,dx){if(v)tetDrawCell(ctx,TET.cur.x+dx,TET.cur.y+dy,TET.cur.color,sz);});});
  // Pause overlay
  if(TET.paused){ctx.fillStyle='rgba(0,0,0,.6)';ctx.fillRect(0,0,TET.canvas.width,TET.canvas.height);ctx.fillStyle='#FFD700';ctx.font='bold 20px Lilita One,cursive';ctx.textAlign='center';ctx.fillText('PAUSED',TET.canvas.width/2,TET.canvas.height/2);}
}
function tetDrawCell(ctx,x,y,col,sz){
  ctx.fillStyle=col;ctx.fillRect(x*sz,y*sz,sz-1,sz-1);
  ctx.fillStyle='rgba(255,255,255,.3)';ctx.fillRect(x*sz,y*sz,sz-1,2);ctx.fillRect(x*sz,y*sz,2,sz-1);
  ctx.fillStyle='rgba(0,0,0,.3)';ctx.fillRect(x*sz+sz-3,y*sz,3,sz-1);ctx.fillRect(x*sz,y*sz+sz-3,sz-1,3);
}

// 
//  SPACE INVADERS
// 
var SP={
  canvas:null,ctx:null,
  player:{x:150,y:340,w:30,h:14,speed:5},
  bullets:[],eBullets:[],
  aliens:[],
  score:0,lives:3,wave:1,
  timer:null,paused:false,over:false,
  moveDir:1,moveSpeed:1,moveTimer:0,
  fireTimer:0,moveInterval:null,
  alienDescend:0
};
var SP_ALIENS=['','',''];

function initSpace(){
  showPage('pgSpace');snd('whoosh');
  SP.canvas=document.getElementById('spaceCanvas');
  SP.ctx=SP.canvas.getContext('2d');
  var maxW=Math.min(window.innerWidth-20,360);
  SP.canvas.width=maxW;SP.canvas.height=Math.floor(maxW*1.18);
  SP.player.x=maxW/2-15;SP.player.y=SP.canvas.height-50;
  SP.score=0;SP.lives=3;SP.wave=1;SP.over=false;SP.paused=false;
  spawnWave();
  clearInterval(SP.timer);
  SP.timer=setInterval(spaceLoop,1000/60);
  document.getElementById('spPauseBtn').textContent=' Pause';
  updateSpUI();
}
function stopSpace(){clearInterval(SP.timer);SP.timer=null;if(SP.moveInterval){clearInterval(SP.moveInterval);}}
function spacePause(){SP.paused=!SP.paused;document.getElementById('spPauseBtn').textContent=SP.paused?' Resume':' Pause';}

function spawnWave(){
  SP.aliens=[];SP.bullets=[];SP.eBullets=[];SP.moveDir=1;SP.alienDescend=0;
  var cols=8,rows=Math.min(3+Math.floor(SP.wave/2),5);
  var cellW=Math.floor((SP.canvas.width-20)/cols);
  for(var r=0;r<rows;r++){
    for(var c=0;c<cols;c++){
      SP.aliens.push({x:10+c*cellW+cellW/2-14,y:30+r*32,w:28,h:22,alive:true,type:r%3,pts:(rows-r)*10*SP.wave});
    }
  }
}

var spMoveDir=0;
function spMoveStart(d){spMoveDir=d;}
function spMoveStop(){spMoveDir=0;}
function spMove(d){SP.player.x=Math.max(0,Math.min(SP.canvas.width-30,SP.player.x+d*18));} 
function spFire(){
  if(SP.over||SP.paused)return;
  SP.bullets.push({x:SP.player.x+15,y:SP.player.y,speed:8});
  snd('tap');
}

var spLoopCount=0;
function spaceLoop(){
  if(SP.paused||SP.over)return;
  spLoopCount++;
  // Move player with held button
  if(spMoveDir!==0) SP.player.x=Math.max(0,Math.min(SP.canvas.width-30,SP.player.x+spMoveDir*4));
  // Move bullets
  SP.bullets=SP.bullets.filter(function(b){b.y-=b.speed;return b.y>0;});
  SP.eBullets=SP.eBullets.filter(function(b){b.y+=3+SP.wave*.5;return b.y<SP.canvas.height;});
  // Move aliens
  SP.moveTimer++;
  var spd=Math.max(8,28-SP.wave*2-Math.floor((55-SP.aliens.filter(function(a){return a.alive;}).length)/5));
  if(SP.moveTimer>=spd){
    SP.moveTimer=0;
    var alive=SP.aliens.filter(function(a){return a.alive;});
    var minX=Math.min.apply(null,alive.map(function(a){return a.x;}));
    var maxX=Math.max.apply(null,alive.map(function(a){return a.x+a.w;}));
    if((SP.moveDir>0&&maxX>=SP.canvas.width-4)||(SP.moveDir<0&&minX<=4)){
      SP.moveDir*=-1;
      SP.aliens.forEach(function(a){a.y+=10;SP.alienDescend+=10;});
    } else {
      SP.aliens.forEach(function(a){a.x+=SP.moveDir*8;});
    }
  }
  // Alien fire
  SP.fireTimer++;
  if(SP.fireTimer>Math.max(40,90-SP.wave*8)){
    SP.fireTimer=0;
    var alive2=SP.aliens.filter(function(a){return a.alive;});
    if(alive2.length>0){var shooter=alive2[Math.floor(Math.random()*alive2.length)];SP.eBullets.push({x:shooter.x+14,y:shooter.y+22});}
  }
  // Check collisions
  SP.bullets.forEach(function(b){
    SP.aliens.forEach(function(a){
      if(!a.alive)return;
      if(b.x>a.x&&b.x<a.x+a.w&&b.y>a.y&&b.y<a.y+a.h){a.alive=false;b.y=-999;SP.score+=a.pts;snd('match');addXP(1);}
    });
  });
  SP.eBullets.forEach(function(b){
    if(b.x>SP.player.x&&b.x<SP.player.x+30&&b.y>SP.player.y&&b.y<SP.player.y+14){
      b.y=SP.canvas.height+99;SP.lives--;snd('no');
      if(SP.lives<=0){SP.over=true;clearInterval(SP.timer);confetti();snd('no');setTimeout(function(){alert('Game Over! Score: '+SP.score);},300);}
    }
  });
  // Win wave
  if(SP.aliens.every(function(a){return !a.alive;})){
    SP.wave++;snd('win');confetti();spawnWave();
  }
  // Aliens reach bottom
  if(SP.alienDescend>SP.canvas.height-120){SP.over=true;clearInterval(SP.timer);setTimeout(function(){alert('They got through! Score: '+SP.score);},300);}
  updateSpUI();
  spaceDraw();
}

function updateSpUI(){
  document.getElementById('spScore').textContent=SP.score;
  document.getElementById('spLives').textContent=''.repeat(Math.max(0,SP.lives));
  document.getElementById('spWave').textContent=SP.wave;
}
function spaceDraw(){
  var ctx=SP.ctx,cw=SP.canvas.width,ch=SP.canvas.height;
  // Background  starfield
  ctx.fillStyle='#000010';ctx.fillRect(0,0,cw,ch);
  // Stars (static for perf)
  ctx.fillStyle='rgba(255,255,255,.5)';
  for(var i=0;i<40;i++){ctx.fillRect((i*37+spLoopCount*0.05)%cw,(i*53+i*7)%ch,1.5,1.5);}
  // Aliens
  ctx.font='22px serif';
  SP.aliens.forEach(function(a){
    if(!a.alive)return;
    ctx.fillText(SP_ALIENS[a.type],a.x,a.y+22);
  });
  // Player ship
  ctx.fillStyle='#00FF41';
  ctx.beginPath();ctx.moveTo(SP.player.x+15,SP.player.y);ctx.lineTo(SP.player.x,SP.player.y+14);ctx.lineTo(SP.player.x+30,SP.player.y+14);ctx.closePath();ctx.fill();
  ctx.fillStyle='#00CC33';ctx.fillRect(SP.player.x+10,SP.player.y+6,10,8);
  // Bullets
  SP.bullets.forEach(function(b){ctx.fillStyle='#FFD700';ctx.fillRect(b.x-2,b.y,4,10);});
  SP.eBullets.forEach(function(b){ctx.fillStyle='#FF4444';ctx.fillRect(b.x-2,b.y,4,10);});
  // Pause overlay
  if(SP.paused){ctx.fillStyle='rgba(0,0,0,.6)';ctx.fillRect(0,0,cw,ch);ctx.fillStyle='#00FF41';ctx.font='bold 22px sans-serif';ctx.textAlign='center';ctx.fillText('PAUSED',cw/2,ch/2);}
  ctx.textAlign='left';
}


// 
//  RETROARCH-STYLE EMULATOR  EmulatorJS
//  Open source: github.com/EmulatorJS/EmulatorJS
// 

var RETRO = {
  selectedCore: 'nes',
  romData: null,
  romName: '',
  romExt: '',
  emu: null,
  paused: false,
  saveStates: {},
  recent: [],
  emuLoaded: false,
  animFrame: null
};

var SYSTEMS = [
  {id:'nes',   name:'NES',          ico:'', sub:'Nintendo', core:'nes',     exts:['nes'],       color:'#CC0000'},
  {id:'snes',  name:'SNES',         ico:'', sub:'Super Nintendo', core:'snes9x', exts:['sfc','smc'], color:'#6600CC'},
  {id:'sega',  name:'Sega Genesis', ico:'', sub:'Mega Drive', core:'genesis_plus_gx', exts:['smd','gen','md'], color:'#0055BB'},
]

var SYS_INFO = {
  nes:   'Nintendo Entertainment System (1983). Classic games: Super Mario Bros, Zelda, Contra, Metroid, Mega Man, Castlevania',
  snes:  'Super Nintendo (1990). Classic games: Super Mario World, Donkey Kong Country, Chrono Trigger, F-Zero, Street Fighter',
  sega:  'Sega Genesis / Mega Drive (1988). Classic games: Sonic, Streets of Rage, Mortal Kombat, Shinobi, Golden Axe',
}

var RETRO_KEYMAP = {
  'up':     {key:'ArrowUp',    code:0},
  'down':   {key:'ArrowDown',  code:1},
  'left':   {key:'ArrowLeft',  code:2},
  'right':  {key:'ArrowRight', code:3},
  'a':      {key:'x',          code:8},
  'b':      {key:'z',          code:9},
  'x':      {key:'s',          code:10},
  'y':      {key:'a',          code:11},
  'l':      {key:'q',          code:12},
  'r':      {key:'w',          code:13},
  'start':  {key:'Enter',      code:6},
  'select': {key:'Shift',      code:7},
};

//  BUILD SYSTEM GRID 
function retroInit(){
  buildSysGrid();
  var rec=ls('ch_retro_rec')||[];
  RETRO.recent=rec;
  if(rec.length>0){document.getElementById('retroRecentWrap').style.display='block';renderRecentROMs();}
  document.getElementById('retroSelectView').style.display='flex';
  document.getElementById('retroEmuWrap').style.display='none';
  // Restore body scroll
  document.body.style.overflow='';
  document.getElementById('retroStatusTxt').textContent='Select system & load ROM';
  snd('whoosh');
}

function buildSysGrid(){
  var el=document.getElementById('sysGrid');if(!el||el.children.length>0)return;
  SYSTEMS.forEach(function(sys){
    var d=document.createElement('div');
    d.className='sys-card'+(sys.id===RETRO.selectedCore?' sel':'');
    d.style.borderColor=sys.id===RETRO.selectedCore?sys.color:'#2a2a4e';
    d.innerHTML='<div class="sys-ico">'+sys.ico+'</div><div class="sys-name">'+sys.name+'</div><div class="sys-sub">'+sys.sub+'</div>';
    d.onclick=function(){
      document.querySelectorAll('.sys-card').forEach(function(c){c.classList.remove('sel');c.style.borderColor='#2a2a4e';});
      d.classList.add('sel');d.style.borderColor=sys.color;
      RETRO.selectedCore=sys.id;snd('tap');
      // Show info
      document.getElementById('retroSysInfo').style.display='block';
      document.getElementById('retroSysTitle').textContent=sys.ico+' '+sys.name;
      document.getElementById('retroSysDesc').textContent=SYS_INFO[sys.id]||'';
      // Update file picker accepted extensions
      var fp=document.getElementById('retroRomFile');
      if(fp)fp.accept='.'+SYSTEMS.find(function(s){return s.id===sys.id;}).exts.join(',.');
    };
    el.appendChild(d);
  });
}

//  DETECT CORE FROM EXTENSION 
function detectCore(ext){
  ext=ext.toLowerCase();
  for(var i=0;i<SYSTEMS.length;i++){
    if(SYSTEMS[i].exts.indexOf(ext)>-1)return SYSTEMS[i];
  }
  return SYSTEMS[0]; // default NES
}

//  LOAD ROM FILE 
function retroLoadFile(input){
  var file=input.files[0];if(!file)return;
  var ext=file.name.split('.').pop().toLowerCase();
  var sys=detectCore(ext);
  RETRO.romName=file.name;
  RETRO.romExt=ext;
  RETRO.selectedCore=sys.id;
  // Auto-select correct system card
  document.querySelectorAll('.sys-card').forEach(function(c,i){
    c.classList.remove('sel');c.style.borderColor='#2a2a4e';
    if(SYSTEMS[i]&&SYSTEMS[i].id===sys.id){c.classList.add('sel');c.style.borderColor=sys.color;}
  });
  document.getElementById('retroLoadStatus').textContent=' Reading '+file.name+'...';
  document.getElementById('retroLoadStatus').style.color='#FFD700';
  var reader=new FileReader();
  reader.onload=function(e){
    RETRO.romData=e.target.result;
    document.getElementById('retroLoadStatus').textContent=' '+file.name+' ('+sys.name+')  Ready!';
    document.getElementById('retroLoadStatus').style.color='#00FF64';
    snd('ok');
    // Save to recent
    var rec=ls('ch_retro_rec')||[];
    rec=rec.filter(function(r){return r.name!==file.name;});
    rec.unshift({name:file.name,sys:sys.id,sysName:sys.name,ico:sys.ico,time:new Date().toLocaleDateString()});
    if(rec.length>8)rec=rec.slice(0,8);
    ls('ch_retro_rec',rec);RETRO.recent=rec;
    renderRecentROMs();document.getElementById('retroRecentWrap').style.display='block';
    // Auto-launch
    setTimeout(function(){retroLaunch();},600);
  };
  reader.onerror=function(){
    document.getElementById('retroLoadStatus').textContent=' Failed to read file';
    document.getElementById('retroLoadStatus').style.color='#FF4444';
  };
  reader.readAsArrayBuffer(file);
}

function retroShowRecent(){
  var w=document.getElementById('retroRecentWrap');
  w.style.display=w.style.display==='none'?'block':'none';
}
function renderRecentROMs(){
  var el=document.getElementById('retroRecentList');el.innerHTML='';
  var rec=ls('ch_retro_rec')||[];
  if(!rec.length){el.innerHTML='<div style="color:#888;font-size:11px;padding:6px;">No recent ROMs</div>';return;}
  rec.forEach(function(r){
    var d=document.createElement('div');d.className='recent-item';
    d.innerHTML='<div style="font-size:22px;">'+r.ico+'</div><div style="flex:1;"><div style="font-size:11px;font-weight:800;color:#e8e0ff;">'+r.name+'</div><div style="font-size:9px;color:#888;">'+r.sysName+'  '+r.time+'</div></div><div style="font-size:11px;color:#FFD700;font-weight:800;"></div>';
    d.onclick=function(){
      // Can only replay if ROM is still in memory (session)
      if(RETRO.romData&&RETRO.romName===r.name){retroLaunch();}
      else{alert('Re-select this ROM file  browser security prevents auto-reloading from storage.\n\nTap "Tap to choose ROM" and select: '+r.name);}
    };
    el.appendChild(d);
  });
}

//  LAUNCH GAME via EmulatorJS 
function retroLaunch(){
  if(!RETRO.romData){alert('Please load a ROM file first!');return;}
  snd('ok');
  // Switch to game view
  document.getElementById('retroSelectView').style.display='none';
  document.getElementById('retroEmuWrap').style.display='flex';
  document.getElementById('retroGameTitle').textContent=RETRO.romName.replace(/\.[^.]+$/,'');
  document.getElementById('emuLoading').style.display='flex';
  document.getElementById('emuLoadFill').style.width='0%';
  document.getElementById('emuLoadTxt').textContent='Loading '+RETRO.romName+'...';
  document.getElementById('emuLoadSub').textContent='Initializing emulator core';

  // Progress animation
  var prog=0;
  var progTimer=setInterval(function(){prog+=Math.random()*12;if(prog>90)prog=90;document.getElementById('emuLoadFill').style.width=prog+'%';},180);

  // Convert ArrayBuffer to base64 blob URL for EmulatorJS
  var blob=new Blob([RETRO.romData],{type:'application/octet-stream'});
  var romURL=URL.createObjectURL(blob);

  // Get system config
  var sys=SYSTEMS.find(function(s){return s.id===RETRO.selectedCore;})||SYSTEMS[0];

  // Clear any previous emulator
  var container=document.getElementById('emujs-container');
  // Remove old EJS elements except loading screen
  var old=container.querySelector('div[id="EJS_player"]');if(old)old.remove();
  var oldStyle=document.getElementById('EJS_style');if(oldStyle)oldStyle.remove();

  // EmulatorJS config
  window.EJS_player='#EJS_player';
  window.EJS_core=sys.core;
  window.EJS_gameUrl=romURL;
  window.EJS_pathtodata='https://cdn.emulatorjs.org/stable/data/';
  window.EJS_startOnLoaded=true;
  window.EJS_fullscreenOnLoaded=false;
  window.EJS_color='#FF6B00';
  window.EJS_defaultOptions={'save-state-slot':1,'load-state':'0'};
  // Show ONLY the controls built into EmulatorJS - no custom ones
  window.EJS_Buttons={
    playPause:false, restart:false, mute:false,
    settings:false, fullscreen:false,
    saveState:false, loadState:false,
    screenRecord:false, gamepad:false,
    centerMode:false, cacheManager:false
  };
  window.EJS_VirtualGamepad=true;
  window.EJS_GamepadEnabled=true;
  // EJS built-in touch controls handle everything
  window.EJS_AdUrl='';
  window.EJS_AdMode='';
  window.EJS_onGameStart=function(){
    clearInterval(progTimer);
    document.getElementById('emuLoadFill').style.width='100%';
    document.getElementById('emuLoadTxt').textContent=' Game Started!';
    setTimeout(function(){document.getElementById('emuLoading').style.display='none';},600);
    RETRO.emuLoaded=true;snd('ok');confetti();addXP(5);
    // Lock scroll, go fullscreen
    document.body.style.overflow='hidden';
    retroShowOverlay();
    // Try native fullscreen on the container
    var el=document.getElementById('emujs-container');
    if(el && el.requestFullscreen){
      el.requestFullscreen().catch(function(){});
    } else if(el && el.webkitRequestFullscreen){
      el.webkitRequestFullscreen();
    }
  };

  // Create player div
  var playerDiv=document.createElement('div');playerDiv.id='EJS_player';
  playerDiv.style.cssText='width:100%;height:100%;';
  container.appendChild(playerDiv);

  // Load EmulatorJS script
  var oldScript=document.getElementById('EJS_script');if(oldScript)oldScript.remove();
  var script=document.createElement('script');
  script.id='EJS_script';
  script.src='https://cdn.emulatorjs.org/stable/data/loader.js';
  script.onload=function(){
    clearInterval(progTimer);
    document.getElementById('emuLoadFill').style.width='85%';
    document.getElementById('emuLoadSub').textContent='Loading game data...';
  };
  script.onerror=function(){
    clearInterval(progTimer);
    document.getElementById('emuLoadTxt').textContent=' No internet connection';
    document.getElementById('emuLoadSub').textContent='EmulatorJS requires internet to load core files';
    document.getElementById('emuLoadFill').style.width='0%';
    document.getElementById('emuLoadFill').style.background='#FF4444';
  };
  document.head.appendChild(script);
}

//  CONTROLS 
function retroBtn(btn, pressed){
  var map=RETRO_KEYMAP[btn];if(!map)return;
  // Try EmulatorJS gamepad API first
  if(window.EJS_emulator&&window.EJS_emulator.gameManager){
    try{
      if(pressed) window.EJS_emulator.gameManager.simulateInput(0,map.code,1);
      else window.EJS_emulator.gameManager.simulateInput(0,map.code,0);
      return;
    }catch(e){}
  }
  // Fallback: keyboard events on the EJS canvas
  var canvas=document.querySelector('#emujs-container canvas')||document.getElementById('EJS_player');
  var tgt=canvas||document.body;
  var evt=new KeyboardEvent(pressed?'keydown':'keyup',{key:map.key,code:map.key,bubbles:true,cancelable:true});
  tgt.dispatchEvent(evt);
  // Visual feedback
  var dcEl=document.getElementById('dc-'+btn);
  if(dcEl)dcEl.classList.toggle('pressed',pressed);
}

// Keyboard passthrough
document.addEventListener('keydown',function(e){
  var btn=Object.keys(RETRO_KEYMAP).find(function(k){return RETRO_KEYMAP[k].key===e.key;});
  if(btn)retroBtn(btn,true);
});
document.addEventListener('keyup',function(e){
  var btn=Object.keys(RETRO_KEYMAP).find(function(k){return RETRO_KEYMAP[k].key===e.key;});
  if(btn)retroBtn(btn,false);
});

//  EMULATOR ACTIONS 
function retroTogglePause(){
  RETRO.paused=!RETRO.paused;
  try{
    if(RETRO.paused) window.EJS_emulator.pause();
    else window.EJS_emulator.play();
  }catch(e){}
  document.getElementById('retroPauseBtn').textContent=RETRO.paused?'':'';
  snd('tap');
}
function retroSaveState(){
  try{window.EJS_emulator.saveState();}catch(e){}
  snd('ok');
  // Visual feedback
  var btn=document.querySelector('[onclick="retroSaveState()"]');
  if(btn){var orig=btn.textContent;btn.textContent='';setTimeout(function(){btn.textContent=orig;},1000);}
}
function retroFullscreen(){
  var el=document.getElementById('emujs-container');
  if(el.requestFullscreen)el.requestFullscreen();
  else if(el.webkitRequestFullscreen)el.webkitRequestFullscreen();
}
function retroEject(){
  // Stop emulator
  try{if(window.EJS_emulator)window.EJS_emulator.pause();}catch(e){}
  RETRO.emuLoaded=false;RETRO.paused=false;
  // Remove EJS elements
  var old=document.getElementById('EJS_player');if(old)old.remove();
  var oldS=document.getElementById('EJS_script');if(oldS)oldS.remove();
  // Revoke object URL to free memory
  document.getElementById('retroSelectView').style.display='flex';
  document.getElementById('retroEmuWrap').style.display='none';
  // Restore body scroll
  document.body.style.overflow='';
  document.getElementById('emuLoading').style.display='flex';
  document.getElementById('emuLoadFill').style.width='0%';
  document.getElementById('emuLoadFill').style.background='linear-gradient(90deg,#FFD700,#FF8C00)';
  document.getElementById('emuLoadTxt').textContent='Loading...';
  document.getElementById('emuLoadSub').textContent='Initializing emulator core';
  document.getElementById('retroPauseBtn').textContent='';
  snd('tap');
}


// 
//  V9 NEW FEATURES JS
// 

//  LANGUAGE SYSTEM 
var LANG = 'en';
var STRINGS = {
  en: {
    home:'Home', comics:'Comics', games:'Games', learn:'Learn', settings:'Settings',
    readNow:'Read Now', search:'Search comics...', streak:'Reading Streak',
    readToday:'Read today to start!', comicDay:' Comic of the Day',
    noComics:'No comics yet ', learnZone:' Learn Zone',
    takeQuiz:' Take Quiz!', sendFeedback:'Send Feedback',
    myInbox:'My Inbox', contactSupport:'Contact & Support',
    editProfile:' Edit Profile', bgMusic:'Background Music',
    darkMode:'Dark Mode', soundEffects:'Sound Effects',
    letsGo:"Let's Go! ", welcome:'Welcome to Champak! ',
    chooseName:'Enter your name and pick your character!',
    namePlaceholder:'Your name...'
  },
  hi: {
    home:'', comics:'', games:'', learn:'', settings:'',
    readNow:'', search:' ...', streak:'  ',
    readToday:' !', comicDay:'   ',
    noComics:'    ', learnZone:'  ',
    takeQuiz:'  !', sendFeedback:' ',
    myInbox:' ', contactSupport:' ',
    editProfile:'  ', bgMusic:' ',
    darkMode:' ', soundEffects:'',
    letsGo:' ! ', welcome:'  ! ',
    chooseName:'     !',
    namePlaceholder:' ...'
  }
};
function T(key){return (STRINGS[LANG]&&STRINGS[LANG][key])||STRINGS.en[key]||key;}
function setLang(lang,btn){
  LANG=lang;ls('ch_lang',lang);
  document.querySelectorAll('.lang-btn').forEach(function(b){b.classList.remove('on');});
  if(btn)btn.classList.add('on');
  applyLangStrings();snd('tap');
  showPushNotif('','Language changed!',lang==='hi'?'  ':'English mode on');
}
function applyLangStrings(){
  // Nav labels
  var navKeys=['home','comics','games','learn','settings'];
  navKeys.forEach(function(k){
    var el=document.querySelector('#nav-'+k+' .nav-label');
    if(el)el.textContent=T(k);
  });
  // Search placeholder
  var sp=document.getElementById('homeSearch');if(sp)sp.placeholder=T('search');
  // Streak
  var st=document.getElementById('strkTitle');
  if(st&&st.textContent.indexOf('Day')===-1&&st.textContent.indexOf('')===-1)
    st.textContent=T('streak');
  // Music label
  var ml=document.getElementById('musicLabel');if(ml)ml.textContent=T('bgMusic');
  var dl=document.querySelector('#darkToggle')&&document.querySelector('.sett-label');
  // Settings labels update
  document.querySelectorAll('.sett-label').forEach(function(el){
    var txt=el.textContent.trim();
    if(txt==='Dark Mode'||txt===' ') el.textContent=T('darkMode');
    if(txt==='Sound Effects'||txt==='') el.textContent=T('soundEffects');
    if(txt==='Background Music'||txt===' ') el.textContent=T('bgMusic');
    if(txt==='Send Feedback'||txt===' ') el.textContent=T('sendFeedback');
    if(txt==='My Inbox'||txt===' ') el.textContent=T('myInbox');
    if(txt==='Contact & Support'||txt===' ') el.textContent=T('contactSupport');
  });
  // Onboard
  var ob=document.querySelector('.ob-title');if(ob)ob.textContent=T('welcome');
  var obs=document.querySelector('.ob-sub');if(obs)obs.textContent=T('chooseName');
  var ni=document.getElementById('nameIn');if(ni)ni.placeholder=T('namePlaceholder');
  var ob2=document.querySelector('.ob-btn');if(ob2)ob2.textContent=T('letsGo');
  // Comic of day label
  var cd=document.querySelector('.cotd-lbl');if(cd)cd.textContent=T('comicDay');
}
function loadLang(){
  LANG=ls('ch_lang')||'en';
  var btn=document.getElementById('lang-'+LANG);
  if(btn){document.querySelectorAll('.lang-btn').forEach(function(b){b.classList.remove('on');});btn.classList.add('on');}
  applyLangStrings();
}

//  PROFILE EDIT 
var peditSelChar='';
function openPedit(){
  var ch=getChar();
  peditSelChar=U.avatar;
  document.getElementById('peditAv').textContent=ch.e;
  document.getElementById('peditName').value=U.name||'';
  // Build char grid
  var el=document.getElementById('peditChars');el.innerHTML='';
  CHARS.forEach(function(c2){
    var d=document.createElement('div');
    d.className='pedit-char'+(c2.id===U.avatar?' sel':'');
    d.innerHTML='<div style="font-size:26px;">'+c2.e+'</div><div style="font-size:9px;font-weight:800;color:var(--sub);">'+c2.name+'</div>';
    d.onclick=function(){
      document.querySelectorAll('.pedit-char').forEach(function(x){x.classList.remove('sel');});
      d.classList.add('sel');peditSelChar=c2.id;
      document.getElementById('peditAv').textContent=c2.e;
      snd('tap');
    };
    el.appendChild(d);
  });
  document.getElementById('peditModal').classList.add('open');
  snd('tap');
}
function closePedit(){document.getElementById('peditModal').classList.remove('open');}
function savePedit(){
  var n=document.getElementById('peditName').value.trim();
  if(!n){document.getElementById('peditName').style.animation='shake .3s ease';setTimeout(function(){document.getElementById('peditName').style.animation='';},400);return;}
  var oldName=U.name;
  U.name=n;U.avatar=peditSelChar||U.avatar;
  saveU();closePedit();snd('ok');
  updateRankDisplay();renderSettings();
  if(oldName!==n)showPushNotif('','Profile updated!','Name: '+n);
  confetti();
}

//  PUSH-STYLE NOTIFICATIONS 
var pushTimer=null;
function showPushNotif(ico,title,body,dur){
  clearTimeout(pushTimer);
  document.getElementById('ptIco').textContent=ico||'';
  document.getElementById('ptTitle').textContent=title||'Notification';
  document.getElementById('ptBody').textContent=body||'';
  var t=document.getElementById('pushToast');
  t.classList.add('show');
  snd('notif');
  pushTimer=setTimeout(function(){t.classList.remove('show');},dur||3500);
}
function closePushToast(){
  clearTimeout(pushTimer);
  document.getElementById('pushToast').classList.remove('show');
}
// Schedule smart local push notifications
function schedulePushNotifs(){
  // Show a welcome back notif after 5 seconds on home
  setTimeout(function(){
    if(SK.count>1)showPushNotif('','Streak alive!','Day '+SK.count+'  keep reading! ',3000);
    else showPushNotif('','Welcome back!',U.name+'! New comics waiting ',3000);
  },5000);
  // Notif if unread inbox replies
  var unread=REPLIES.filter(function(r){return r.reply&&!r.userRead;}).length;
  if(unread>0){
    setTimeout(function(){showPushNotif('','Dev replied!',unread+' message'+(unread>1?'s':'')+' in your inbox',4000);},9000);
  }
}

//  BACKGROUND MUSIC (Web Audio API generated tones) 
var MUSIC = {
  on: false, playing: false, trackIdx: 0, audioCtx: null,
  oscillators: [], gainNode: null, barOpen: false
};
var MUSIC_TRACKS = [
  {name:'Happy Kids BGM', tempo:120, notes:[523,659,784,1047,784,659,523,392]},
  {name:'Adventure Theme', tempo:100, notes:[392,440,494,523,587,659,698,784]},
  {name:'Calm Study BGM', tempo:80,  notes:[264,297,330,352,396,440,494,528]},
];
var musicNoteTimer=null,musicNoteIdx=0;
function musicStart(){
  if(!MUSIC.audioCtx){
    try{MUSIC.audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
    catch(e){return;}
  }
  if(MUSIC.audioCtx.state==='suspended')MUSIC.audioCtx.resume();
  MUSIC.playing=true;
  document.getElementById('musicPlayBtn').textContent='';
  document.getElementById('bgMusicBar').classList.add('open');
  MUSIC.barOpen=true;
  playMusicNote();
}
function playMusicNote(){
  if(!MUSIC.playing||!MUSIC.audioCtx)return;
  var track=MUSIC_TRACKS[MUSIC.trackIdx];
  var note=track.notes[musicNoteIdx%track.notes.length];
  musicNoteIdx++;
  try{
    var o=MUSIC.audioCtx.createOscillator();
    var g=MUSIC.audioCtx.createGain();
    o.type='sine';o.frequency.value=note;
    o.connect(g);g.connect(MUSIC.audioCtx.destination);
    var now=MUSIC.audioCtx.currentTime;
    g.gain.setValueAtTime(0,now);
    g.gain.linearRampToValueAtTime(0.07,now+0.05);
    g.gain.exponentialRampToValueAtTime(0.001,now+0.4);
    o.start(now);o.stop(now+0.45);
  }catch(e){}
  var ms=Math.round(60000/track.tempo);
  musicNoteTimer=setTimeout(playMusicNote,ms);
}
function musicStop(){
  MUSIC.playing=false;
  clearTimeout(musicNoteTimer);
  document.getElementById('musicPlayBtn').textContent='';
}
function musicToggle(){
  if(MUSIC.playing){musicStop();}else{musicStart();}
  ls('ch_music',MUSIC.on);
}
function musicNext(){
  MUSIC.trackIdx=(MUSIC.trackIdx+1)%MUSIC_TRACKS.length;
  musicNoteIdx=0;
  document.getElementById('musicTrackName').textContent=MUSIC_TRACKS[MUSIC.trackIdx].name;
  if(MUSIC.playing){clearTimeout(musicNoteTimer);playMusicNote();}
  snd('tap');
}
function musicPrev(){
  MUSIC.trackIdx=(MUSIC.trackIdx-1+MUSIC_TRACKS.length)%MUSIC_TRACKS.length;
  musicNoteIdx=0;
  document.getElementById('musicTrackName').textContent=MUSIC_TRACKS[MUSIC.trackIdx].name;
  if(MUSIC.playing){clearTimeout(musicNoteTimer);playMusicNote();}
  snd('tap');
}
function closeMusicBar(){
  musicStop();
  document.getElementById('bgMusicBar').classList.remove('open');
  MUSIC.barOpen=false;
  document.getElementById('musicToggleEl').classList.remove('on');
  MUSIC.on=false;ls('ch_music',false);
}
function toggleMusic(){
  MUSIC.on=!MUSIC.on;
  document.getElementById('musicToggleEl').classList.toggle('on',MUSIC.on);
  document.getElementById('musicVal').textContent=MUSIC.on?'Now playing  tap bar to control':'Tap to play kids BGM';
  if(MUSIC.on){musicStart();showPushNotif('','Music On!',MUSIC_TRACKS[MUSIC.trackIdx].name);}
  else{closeMusicBar();}
  ls('ch_music',MUSIC.on);snd('tap');
}

//  SHARE APP 
function shareApp(){
  var text=' Champak Comics App!\n\n Read Champak comics\n Play games (Tetris, Snake, Ludo + NES Emulator!)\n Learn ABC, Maths, GK\n Compete on leaderboard\n\nMade by Baadal ';
  if(navigator.share){
    navigator.share({title:'Champak Comics',text:text}).then(function(){snd('ok');}).catch(function(){});
  } else {
    // Fallback: copy to clipboard
    if(navigator.clipboard){
      navigator.clipboard.writeText(text).then(function(){
        showPushNotif('','Copied!','Share text copied to clipboard!');snd('ok');
      });
    } else {
      var ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();
      showPushNotif('','Copied!','Share text copied!');snd('ok');
    }
  }
}
function sendFeedbackFromContact(){showPage('pgFeedback');}

//  SKELETON LOADERS 
function showSkeletons(containerId, count, type){
  var el=document.getElementById(containerId);if(!el)return;
  el.innerHTML='';
  for(var i=0;i<(count||2);i++){
    if(type==='card'){
      el.innerHTML+='<div><div class="skel skel-card"></div><div class="skel skel-line" style="margin-top:7px;"></div><div class="skel skel-line short"></div></div>';
    } else {
      el.innerHTML+='<div class="skel skel-line" style="height:52px;border-radius:12px;margin-bottom:8px;"></div>';
    }
  }
}

//  PWA MANIFEST (inline) 
function installPWA(){
  var manifest={
    name:'Champak Comics',short_name:'Champak',
    description:'Read Champak comics, play games, learn!',
    start_url:'./',display:'standalone',
    background_color:'#FFD700',theme_color:'#FF6B00',
    orientation:'any',
    icons:[
      {src:'./champak_icon.png',sizes:'192x192',type:'image/png'},
      {src:'./champak_icon.png',sizes:'512x512',type:'image/png'}
    ]
  };
  var blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  var url=URL.createObjectURL(blob);
  document.getElementById('pwaManifest').href=url;
}

//  SERVICE WORKER (offline cache) 
function registerSW(){
  if('serviceWorker' in navigator){
    var swCode=`
const CACHE='champak-v9';
const ASSETS=['./','./?v=9','./champak_splash.png','./champak_banner.png','./champak_icon.png'];
self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS).catch(()=>{})));self.skipWaiting();});
self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));self.clients.claim();});
self.addEventListener('fetch',e=>{if(e.request.method!=='GET')return;e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{if(res.ok){var clone=res.clone();caches.open(CACHE).then(c=>c.put(e.request,clone));}return res;}).catch(()=>caches.match('./'))));});
`;
    try{
      var blob=new Blob([swCode],{type:'application/javascript'});
      var url=URL.createObjectURL(blob);
      navigator.serviceWorker.register(url,{scope:'./'}).then(function(){
        console.log('SW registered');
      }).catch(function(e){console.log('SW failed:',e);});
    }catch(e){}
  }
}

//  LOAD ALL V9 EXTRAS 




//  VIDEO SPLASH 
var splashVideoPlayed = false;
function initSplashVideo(){
  var vid = document.getElementById('splashVideo');
  if(!vid){startApp();return;}
  // Load video and freeze on first frame  do NOT play yet
  vid.muted = true;
  vid.volume = 1.0;
  vid.currentTime = 0;
  // Just load metadata to show first frame, don't play
  vid.load();
  // Once first frame is ready, pause to freeze it
  vid.addEventListener('loadeddata', function(){
    vid.pause(); // freeze on first frame
  }, {once: true});
  vid.addEventListener('canplay', function(){
    vid.pause(); // ensure frozen
  }, {once: true});
}

var tapStarted = false;
function onTapStart(){
  if(tapStarted) return; // prevent double-fire from touch+click
  tapStarted = true;
  // Hide the tap layer immediately
  var layer = document.getElementById('tapLayer');
  if(layer) layer.style.display = 'none';
  var vid = document.getElementById('splashVideo');
  if(!vid){ skipSplash(); return; }
  // User gesture  play from beginning WITH audio
  vid.muted = false;
  vid.volume = 1.0;
  vid.currentTime = 0;
  vid.play().catch(function(){
    // Audio blocked  try muted
    vid.muted = true;
    vid.play().catch(function(){ skipSplash(); });
  });
  // Safety: max 15s
  setTimeout(function(){
    if(!splashVideoPlayed) skipSplash();
  }, 15000);
}
function playSplashVideo(){
  var vid=document.getElementById('splashVideo');
  if(vid){vid.muted=false;vid.play().catch(function(){vid.muted=true;vid.play();});}
}
function onSplashVideoEnd(){
  splashVideoPlayed=true;
  skipSplash();
}
function onSplashVideoError(){
  // Video missing  show fallback image and auto-start app after 1.5s
  var vid=document.getElementById('splashVideo');
  var fallback=document.getElementById('splashFallback');
  if(vid)vid.style.display='none';
  if(fallback)fallback.style.display='block';
  setTimeout(function(){skipSplash();},1500);
}
function skipSplash(){
  if(splashVideoPlayed) return; // prevent double-call
  splashVideoPlayed=true;
  var vid=document.getElementById('splashVideo');
  if(vid){
    try{vid.pause();}catch(e){}
    vid.src='';
    vid.load();
  }
  // Small delay so video stops cleanly before transition
  setTimeout(startApp, 100);
}

// Override window.onload to init video
window.addEventListener('load',function(){
  initSplashVideo();
});

//  EMULATOR OVERLAY AUTO-HIDE 
var retroOverlayTimer=null;
function retroShowOverlay(){
  var ov=document.getElementById('retroOverlay');
  if(!ov)return;
  ov.classList.remove('hidden');
  clearTimeout(retroOverlayTimer);
  retroOverlayTimer=setTimeout(function(){ov.classList.add('hidden');},3000);
}
// Auto-hide overlay when game starts
var _origEJSStart=window.EJS_onGameStart;
window.EJS_onGameStart=function(){
  if(_origEJSStart)_origEJSStart();
  setTimeout(retroShowOverlay,500);
};

</script>
</body>
</html>
