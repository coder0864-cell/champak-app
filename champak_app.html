<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Champak Comics</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
:root { --orange:#FF6B00; --yellow:#FFD700; --deep:#E64A00; --bg:#FFF8E7; --dark:#1a0a00; }
body { font-family:'Baloo 2',cursive; background:var(--bg); overflow-x:hidden; min-height:100vh; width:100vw; }

/* â•â•â•â•â•â•â•â•â•â• SPLASH â•â•â•â•â•â•â•â•â•â• */
#splash {
  position:fixed; inset:0;
  background:linear-gradient(160deg,#FF8C00,#FF5500 40%,#E63200);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  z-index:999; transition:opacity .8s ease, transform .8s ease;
}
#splash.hide { opacity:0; transform:scale(1.05); pointer-events:none; }
.stars { position:absolute; inset:0; overflow:hidden; pointer-events:none; }
.star { position:absolute; background:#FFD700; border-radius:50%; animation:twinkle linear infinite; }
@keyframes twinkle { 0%,100%{opacity:0;transform:scale(.5)} 50%{opacity:1;transform:scale(1)} }
.deer-wrap { animation:deerBounce 1.2s ease-in-out infinite; margin-bottom:10px; position:relative; z-index:2; }
@keyframes deerBounce { 0%,100%{transform:translateY(0) rotate(-2deg)} 50%{transform:translateY(-18px) rotate(2deg)} }
.splash-title { font-weight:800; font-size:52px; color:#FFD700; text-shadow:4px 4px 0 #8B2500,-2px -2px 0 #8B2500; letter-spacing:2px; animation:titlePop .6s cubic-bezier(.34,1.56,.64,1) .3s both; z-index:2; position:relative; }
@keyframes titlePop { from{transform:scale(.3) rotate(-5deg);opacity:0} to{transform:scale(1);opacity:1} }
.splash-sub { font-size:15px; color:rgba(255,255,220,.9); letter-spacing:4px; text-transform:uppercase; margin-top:4px; animation:fadeUp .5s ease .7s both; z-index:2; position:relative; }
@keyframes fadeUp { from{opacity:0;transform:translateY(15px)} to{opacity:1;transform:translateY(0)} }
.dots { display:flex; gap:8px; margin-top:40px; z-index:2; }
.dot { width:12px; height:12px; background:#FFD700; border-radius:50%; animation:dotB .8s ease-in-out infinite; }
.dot:nth-child(2){animation-delay:.15s} .dot:nth-child(3){animation-delay:.3s}
@keyframes dotB { 0%,100%{transform:translateY(0);opacity:.5} 50%{transform:translateY(-10px);opacity:1} }
.leaf-bg { position:absolute; bottom:0; left:0; right:0; height:180px; overflow:hidden; pointer-events:none; }

/* â•â•â•â•â•â•â•â•â•â• HOME â•â•â•â•â•â•â•â•â•â• */
#home { display:none; flex-direction:column; min-height:100vh; }
#home.active { display:flex; }

.app-header {
  background:linear-gradient(135deg,#FF6B00,#E64A00);
  padding:14px 16px 18px;
  display:flex; align-items:center; gap:10px;
  box-shadow:0 4px 20px rgba(230,74,0,.4);
  position:sticky; top:0; z-index:50; overflow:hidden;
}
.app-header::before { content:''; position:absolute; top:-20px; right:-20px; width:120px; height:120px; background:rgba(255,255,255,.08); border-radius:50%; pointer-events:none; }
.header-deer { animation:deerBounce 2s ease-in-out infinite; flex-shrink:0; }
.header-texts { flex:1; }
.app-header h1 { color:#FFD700; font-size:24px; font-weight:800; text-shadow:2px 2px 0 #8B2500; line-height:1.1; }
.app-header p { color:rgba(255,240,200,.8); font-size:10px; letter-spacing:1.5px; }
.refresh-btn { background:rgba(255,255,255,.2); border:none; color:white; width:38px; height:38px; border-radius:10px; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.refresh-btn.spinning { animation:spin .7s linear; }
@keyframes spin { to{transform:rotate(360deg)} }

/* Status bars */
.status-bar { background:linear-gradient(135deg,#155215,#0a3a0a); padding:7px 16px; display:flex; align-items:center; gap:8px; flex-shrink:0; }
.status-dot { width:8px; height:8px; background:#7FFF7F; border-radius:50%; box-shadow:0 0 6px #7FFF7F; animation:adPulse 1.5s ease-in-out infinite; }
@keyframes adPulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(1.4)} }
.status-text { color:#7FFF7F; font-size:12px; font-weight:700; }
.status-count { margin-left:auto; color:rgba(180,255,180,.7); font-size:11px; }

/* AdGuard DNS bar */
.dns-bar {
  background:linear-gradient(135deg,#1a1a6e,#0d0d4a);
  padding:7px 16px; display:flex; align-items:center; gap:8px;
}
.dns-dot { width:8px; height:8px; background:#00BFFF; border-radius:50%; box-shadow:0 0 6px #00BFFF; animation:adPulse 2s ease-in-out infinite; }
.dns-text { color:#00BFFF; font-size:12px; font-weight:700; }
.dns-count { margin-left:auto; color:rgba(150,200,255,.7); font-size:11px; }

.home-body { flex:1; padding:16px; overflow-y:auto; }
.home-body::-webkit-scrollbar { width:0; }

/* Back hint */
.back-hint { background:linear-gradient(135deg,#1a1a5e,#000080); border-radius:12px; padding:10px 14px; display:flex; align-items:center; gap:10px; margin-bottom:14px; }
.back-hint p { color:#AAF; font-size:12px; line-height:1.4; }
.back-hint strong { color:#FFD700; display:block; font-size:13px; }

.sec-title { color:var(--deep); font-size:15px; font-weight:800; margin-bottom:12px; display:flex; align-items:center; gap:6px; }

/* Comic grid */
#comicGrid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.comic-card { background:white; border-radius:16px; overflow:hidden; box-shadow:0 4px 16px rgba(255,107,0,.15); border:2px solid rgba(255,107,0,.1); cursor:pointer; transition:transform .15s; animation:cardIn .4s ease both; }
.comic-card:active { transform:scale(.95); }
@keyframes cardIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
.comic-cover { height:120px; display:flex; align-items:center; justify-content:center; font-size:44px; position:relative; overflow:hidden; }
.comic-cover::after { content:''; position:absolute; inset:0; background:linear-gradient(to bottom,transparent 60%,rgba(0,0,0,.15)); }
.comic-badge { position:absolute; top:8px; right:8px; z-index:2; background:#FFD700; color:#8B2500; font-size:9px; font-weight:800; padding:2px 7px; border-radius:8px; }
.new-badge { position:absolute; top:8px; left:8px; z-index:2; background:#FF3366; color:white; font-size:9px; font-weight:800; padding:2px 7px; border-radius:8px; animation:newBadge 1s ease-in-out infinite; }
@keyframes newBadge { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
.comic-info { padding:10px 12px 12px; }
.comic-name { color:var(--dark); font-size:13px; font-weight:700; line-height:1.3; }
.comic-meta { color:#aaa; font-size:11px; margin-top:3px; display:flex; justify-content:space-between; }
.open-btn { margin-top:9px; width:100%; padding:8px; background:linear-gradient(135deg,#FF6B00,#E64A00); color:white; border:none; border-radius:9px; font-family:'Baloo 2',cursive; font-size:13px; font-weight:700; display:flex; align-items:center; justify-content:center; gap:5px; box-shadow:0 3px 8px rgba(230,74,0,.3); }

/* States */
#loadingState { text-align:center; padding:50px 20px; }
.loader-deer { animation:deerBounce 1s ease-in-out infinite; display:inline-block; }
#loadingState p { color:#FF6B00; font-weight:700; font-size:15px; margin-top:12px; }
#loadingState small { color:#bbb; font-size:12px; display:block; margin-top:4px; }
#errorState { display:none; text-align:center; padding:30px 20px; }
#errorState .err-icon { font-size:44px; margin-bottom:10px; }
#errorState p { color:#E64A00; font-weight:700; font-size:14px; }
#errorState small { color:#aaa; font-size:12px; display:block; margin-top:4px; }
.retry-btn { margin-top:14px; padding:12px 28px; background:linear-gradient(135deg,#FF6B00,#E64A00); color:white; border:none; border-radius:12px; font-family:'Baloo 2',cursive; font-size:14px; font-weight:700; cursor:pointer; }
#emptyState { display:none; text-align:center; padding:50px 20px; }
#emptyState .em-icon { font-size:50px; margin-bottom:12px; }
#emptyState p { color:#ccc; font-size:14px; }

/* Opening overlay */
#openingOverlay { display:none; position:fixed; inset:0; z-index:200; background:linear-gradient(160deg,#FF8C00,#E63200); flex-direction:column; align-items:center; justify-content:center; }
#openingOverlay.show { display:flex; animation:fadeIn .3s ease; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
#openingOverlay .ov-deer { animation:deerBounce 1s ease-in-out infinite; }
#openingOverlay p { color:#FFD700; font-size:18px; font-weight:800; margin-top:16px; text-shadow:2px 2px 0 #8B2500; }
#openingOverlay small { color:rgba(255,240,200,.8); font-size:13px; margin-top:6px; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• SPLASH â•â•â•â•â•â•â•â•â•â• -->
<div id="splash">
  <div class="stars" id="stars"></div>
  <div class="deer-wrap">
    <svg width="150" height="170" viewBox="0 0 160 180" fill="none">
      <ellipse cx="80" cy="115" rx="42" ry="35" fill="#F4A030"/>
      <circle cx="80" cy="68" r="28" fill="#F4A030"/>
      <ellipse cx="57" cy="48" rx="9" ry="13" fill="#F4A030" transform="rotate(-20 57 48)"/>
      <ellipse cx="57" cy="48" rx="5" ry="8" fill="#F8C070" transform="rotate(-20 57 48)"/>
      <ellipse cx="103" cy="48" rx="9" ry="13" fill="#F4A030" transform="rotate(20 103 48)"/>
      <ellipse cx="103" cy="48" rx="5" ry="8" fill="#F8C070" transform="rotate(20 103 48)"/>
      <line x1="60" y1="44" x2="42" y2="18" stroke="#8B4000" stroke-width="5" stroke-linecap="round"/>
      <line x1="42" y1="18" x2="30" y2="10" stroke="#8B4000" stroke-width="4" stroke-linecap="round"/>
      <line x1="42" y1="18" x2="36" y2="5" stroke="#8B4000" stroke-width="4" stroke-linecap="round"/>
      <line x1="100" y1="44" x2="118" y2="18" stroke="#8B4000" stroke-width="5" stroke-linecap="round"/>
      <line x1="118" y1="18" x2="130" y2="10" stroke="#8B4000" stroke-width="4" stroke-linecap="round"/>
      <line x1="118" y1="18" x2="124" y2="5" stroke="#8B4000" stroke-width="4" stroke-linecap="round"/>
      <circle cx="70" cy="64" r="7" fill="white"/><circle cx="90" cy="64" r="7" fill="white"/>
      <circle cx="71" cy="65" r="4" fill="#1a0a00"/><circle cx="91" cy="65" r="4" fill="#1a0a00"/>
      <circle cx="72" cy="63" r="1.5" fill="white"/><circle cx="92" cy="63" r="1.5" fill="white"/>
      <ellipse cx="80" cy="78" rx="9" ry="6" fill="#E07820"/>
      <ellipse cx="80" cy="77" rx="5" ry="3" fill="#CC5500"/>
      <path d="M70 83 Q80 92 90 83" stroke="#CC5500" stroke-width="2.5" stroke-linecap="round" fill="none"/>
      <circle cx="60" cy="76" r="8" fill="rgba(255,120,80,0.35)"/>
      <circle cx="100" cy="76" r="8" fill="rgba(255,120,80,0.35)"/>
      <rect x="58" y="145" width="14" height="28" rx="7" fill="#D4881A"/>
      <rect x="88" y="145" width="14" height="28" rx="7" fill="#D4881A"/>
      <rect x="100" y="100" width="32" height="24" rx="4" fill="#E63200" transform="rotate(15 100 100)"/>
      <rect x="102" y="102" width="14" height="20" rx="2" fill="#FF8040" transform="rotate(15 100 100)"/>
    </svg>
  </div>
  <div class="splash-title">à¤šà¤®à¥à¤ªà¤•</div>
  <div class="splash-sub">âœ¦ Comics Reader âœ¦</div>
  <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
  <div class="leaf-bg">
    <svg viewBox="0 0 400 180" preserveAspectRatio="none" width="100%" height="100%">
      <path d="M0,100 Q50,40 100,80 Q150,110 200,60 Q250,20 300,70 Q350,110 400,50 L400,180 L0,180 Z" fill="rgba(0,100,0,0.4)"/>
      <path d="M0,130 Q60,80 120,110 Q180,140 240,90 Q300,50 360,100 Q390,120 400,90 L400,180 L0,180 Z" fill="rgba(0,130,0,0.35)"/>
      <path d="M0,155 Q80,120 160,145 Q240,165 320,135 Q360,120 400,140 L400,180 L0,180 Z" fill="rgba(0,160,0,0.3)"/>
    </svg>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• HOME â•â•â•â•â•â•â•â•â•â• -->
<div id="home">
  <div class="app-header">
    <div class="header-deer">
      <svg width="34" height="38" viewBox="0 0 160 180" fill="none">
        <ellipse cx="80" cy="115" rx="42" ry="35" fill="#F4A030"/>
        <circle cx="80" cy="68" r="28" fill="#F4A030"/>
        <line x1="60" y1="44" x2="42" y2="18" stroke="#8B4000" stroke-width="6" stroke-linecap="round"/>
        <line x1="42" y1="18" x2="30" y2="10" stroke="#8B4000" stroke-width="4" stroke-linecap="round"/>
        <line x1="100" y1="44" x2="118" y2="18" stroke="#8B4000" stroke-width="6" stroke-linecap="round"/>
        <line x1="118" y1="18" x2="130" y2="10" stroke="#8B4000" stroke-width="4" stroke-linecap="round"/>
        <circle cx="70" cy="64" r="7" fill="white"/><circle cx="90" cy="64" r="7" fill="white"/>
        <circle cx="71" cy="65" r="4" fill="#1a0a00"/><circle cx="91" cy="65" r="4" fill="#1a0a00"/>
        <ellipse cx="80" cy="78" rx="9" ry="6" fill="#E07820"/>
        <path d="M70 83 Q80 92 90 83" stroke="#CC5500" stroke-width="2.5" stroke-linecap="round" fill="none"/>
      </svg>
    </div>
    <div class="header-texts">
      <h1>à¤šà¤®à¥à¤ªà¤• Comics</h1>
      <p>âœ¦ YOUR FAVOURITE COMIC READER âœ¦</p>
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="refreshComics()">ğŸ”„</button>
  </div>

  <!-- Green: Ad Free status -->
  <div class="status-bar">
    <div class="status-dot"></div>
    <div class="status-text">ğŸ›¡ï¸ Ad Blocker: ACTIVE</div>
    <div class="status-count" id="statusCount">...</div>
  </div>

  <!-- Blue: AdGuard DNS status -->
  <div class="dns-bar">
    <div class="dns-dot"></div>
    <div class="dns-text">ğŸ”µ AdGuard DNS: ON</div>
    <div class="dns-count" id="dnsCount">Blocked: 0</div>
  </div>

  <div class="home-body">
    <div class="back-hint">
      <span>ğŸ“±</span>
      <p><strong>Comic padhne ke baad wapas aao:</strong>Android ka â† Back Button dabao</p>
    </div>

    <div id="loadingState">
      <div class="loader-deer">
        <svg width="70" height="80" viewBox="0 0 160 180" fill="none">
          <ellipse cx="80" cy="115" rx="42" ry="35" fill="#F4A030"/>
          <circle cx="80" cy="68" r="28" fill="#F4A030"/>
          <circle cx="70" cy="64" r="7" fill="white"/><circle cx="90" cy="64" r="7" fill="white"/>
          <circle cx="71" cy="65" r="4" fill="#1a0a00"/><circle cx="91" cy="65" r="4" fill="#1a0a00"/>
          <ellipse cx="80" cy="78" rx="9" ry="6" fill="#E07820"/>
          <path d="M70 83 Q80 92 90 83" stroke="#CC5500" stroke-width="2.5" stroke-linecap="round" fill="none"/>
          <rect x="58" y="145" width="14" height="28" rx="7" fill="#D4881A"/>
          <rect x="88" y="145" width="14" height="28" rx="7" fill="#D4881A"/>
        </svg>
      </div>
      <p>Comics la raha hoon... ğŸ“š</p>
      <small>GitHub se load ho raha hai</small>
    </div>

    <div id="errorState">
      <div class="err-icon">ğŸ˜¿</div>
      <p>Comics load nahi hui!</p>
      <small>Internet check karo ya baad mein try karo</small><br>
      <button class="retry-btn" onclick="fetchComics()">ğŸ”„ Dobara Try Karo</button>
    </div>

    <div id="emptyState">
      <div class="em-icon">ğŸ“š</div>
      <p>Abhi koi comic nahi hai.<br>Jaldi nai aayegi!</p>
    </div>

    <div class="sec-title" id="secTitle" style="display:none">ğŸ“š Saari Comics</div>
    <div id="comicGrid"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• OPENING OVERLAY â•â•â•â•â•â•â•â•â•â• -->
<div id="openingOverlay">
  <div class="ov-deer">
    <svg width="100" height="112" viewBox="0 0 160 180" fill="none">
      <ellipse cx="80" cy="115" rx="42" ry="35" fill="#F4A030"/>
      <circle cx="80" cy="68" r="28" fill="#F4A030"/>
      <ellipse cx="57" cy="48" rx="9" ry="13" fill="#F4A030" transform="rotate(-20 57 48)"/>
      <ellipse cx="103" cy="48" rx="9" ry="13" fill="#F4A030" transform="rotate(20 103 48)"/>
      <line x1="60" y1="44" x2="42" y2="18" stroke="#8B4000" stroke-width="5" stroke-linecap="round"/>
      <line x1="42" y1="18" x2="30" y2="10" stroke="#8B4000" stroke-width="4" stroke-linecap="round"/>
      <line x1="100" y1="44" x2="118" y2="18" stroke="#8B4000" stroke-width="5" stroke-linecap="round"/>
      <line x1="118" y1="18" x2="130" y2="10" stroke="#8B4000" stroke-width="4" stroke-linecap="round"/>
      <circle cx="70" cy="64" r="7" fill="white"/><circle cx="90" cy="64" r="7" fill="white"/>
      <circle cx="71" cy="65" r="4" fill="#1a0a00"/><circle cx="91" cy="65" r="4" fill="#1a0a00"/>
      <ellipse cx="80" cy="78" rx="9" ry="6" fill="#E07820"/>
      <path d="M70 83 Q80 92 90 83" stroke="#CC5500" stroke-width="2.5" stroke-linecap="round" fill="none"/>
      <circle cx="60" cy="76" r="8" fill="rgba(255,120,80,0.35)"/>
      <circle cx="100" cy="76" r="8" fill="rgba(255,120,80,0.35)"/>
      <rect x="58" y="145" width="14" height="28" rx="7" fill="#D4881A"/>
      <rect x="88" y="145" width="14" height="28" rx="7" fill="#D4881A"/>
    </svg>
  </div>
  <p>Comic khul rahi hai... ğŸ“–</p>
  <small>ğŸ”µ AdGuard DNS protecting...</small>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COMICS_JSON_URL = 'https://raw.githubusercontent.com/coder0864-cell/champak-app/main/comics.json';

// AdGuard DNS-over-HTTPS endpoint
const ADGUARD_DOH = 'https://dns.adguard-dns.com/dns-query';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ğŸ”µ ADGUARD DNS-over-HTTPS AD BLOCKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let blockedCount = 0;
const dnsCache = {}; // cache results so same domain check nahi ho baar baar

// Check domain via AdGuard DoH
async function isAdDomain(hostname) {
  if(dnsCache[hostname] !== undefined) return dnsCache[hostname];
  try {
    const res = await fetch(`${ADGUARD_DOH}?name=${hostname}&type=A`, {
      headers: { 'Accept': 'application/dns-json' }
    });
    const data = await res.json();
    // AdGuard blocks domains by returning NXDOMAIN (status 3) or 0.0.0.0
    const blocked =
      data.Status === 3 || // NXDOMAIN - domain blocked
      (data.Answer && data.Answer.some(a => a.data === '0.0.0.0' || a.data === ''));
    dnsCache[hostname] = blocked;
    return blocked;
  } catch {
    dnsCache[hostname] = false;
    return false;
  }
}

// Extract hostname from URL safely
function getHostname(url) {
  try { return new URL(url).hostname; } catch { return ''; }
}

// â”€â”€ Known ad domains (fast local check, no DNS needed) â”€â”€
const LOCAL_BLOCKLIST = new Set([
  'doubleclick.net','googlesyndication.com','googleadservices.com',
  'adservice.google.com','adnxs.com','pubmatic.com','rubiconproject.com',
  'openx.net','criteo.com','taboola.com','outbrain.com','media.net',
  'mgid.com','adroll.com','casalemedia.com','appnexus.com','zedo.com',
  'smartadserver.com','yllix.com','popads.net','popcash.net',
  'propellerads.com','adsterra.com','exoclick.com','clickadu.com',
  'googletagmanager.com','hotjar.com','quantserve.com','scorecardresearch.com',
  'pagead2.googlesyndication.com','tpc.googlesyndication.com',
  'securepubads.g.doubleclick.net','ads.appgeyser.com','appgeyser-ads.com',
  'sdk.appgeyser.com','monetization.appgeyser.com',
  'ads.fliphtml5.com','fliphtml5ad.com','static.flipads.com',
  'mc.yandex.ru','counter.yadro.ru','ads.adfox.ru',
]);

function isLocalBlocked(url) {
  const host = getHostname(url);
  if(!host) return false;
  const parts = host.split('.');
  for(let i=0; i<parts.length-1; i++) {
    if(LOCAL_BLOCKLIST.has(parts.slice(i).join('.'))) return true;
  }
  return false;
}

function incrementBlock() {
  blockedCount++;
  document.getElementById('dnsCount').textContent = `Blocked: ${blockedCount}`;
}

// â”€â”€ Intercept fetch â”€â”€
const _fetch = window.fetch.bind(window);
window.fetch = async function(input, init) {
  const url = typeof input === 'string' ? input : (input?.url || '');
  if(url === ADGUARD_DOH || url.startsWith(ADGUARD_DOH)) return _fetch(input, init); // allow DoH itself
  if(isLocalBlocked(url)) {
    incrementBlock();
    return new Response('', { status: 200 });
  }
  const host = getHostname(url);
  if(host) {
    const blocked = await isAdDomain(host);
    if(blocked) {
      incrementBlock();
      return new Response('', { status: 200 });
    }
  }
  return _fetch(input, init);
};

// â”€â”€ Intercept XHR â”€â”€
const _XHR = window.XMLHttpRequest;
function PatchedXHR() {
  const xhr = new _XHR();
  const _open = xhr.open.bind(xhr);
  xhr.open = function(method, url, ...rest) {
    if(isLocalBlocked(url)) {
      incrementBlock();
      return;
    }
    _open(method, url, ...rest);
  };
  return xhr;
}
PatchedXHR.prototype = _XHR.prototype;
window.XMLHttpRequest = PatchedXHR;

// â”€â”€ Block injected ad scripts â”€â”€
const _ce = document.createElement.bind(document);
document.createElement = function(tag) {
  const el = _ce(tag);
  if(tag.toLowerCase() === 'script') {
    const desc = Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype, 'src');
    if(desc) {
      Object.defineProperty(el, 'src', {
        set(v) {
          if(isLocalBlocked(v)) { incrementBlock(); return; }
          desc.set.call(this, v);
        },
        get() { return desc.get.call(this); }
      });
    }
  }
  return el;
};

// â”€â”€ CSS: hide ad elements â”€â”€
const adCSS = document.createElement('style');
adCSS.textContent = `
  [id*="ad-"],[id*="-ad"],[id*="ads"],[id*="banner"],[id*="sponsor"],
  [class*="adsbygoogle"],[class*="ad-wrap"],[class*="ad-container"],
  [class*="ad-banner"],[class*="ad-slot"],[class*="advertisement"],
  [class*="sponsor"],[class*="promoted"],[class*="dfp-"],
  ins.adsbygoogle,.google-auto-placed,
  iframe[src*="doubleclick"],iframe[src*="googlesyndication"],
  iframe[src*="adnxs"],iframe[src*="taboola"],iframe[src*="appgeyser"],
  .appgeyser-ad,.ag-banner,.ag-ad,
  .flip-ad,.fh5co-ad,[class*="flipad"],#fliphtml5-ad,
  .powered-by-fliphtml5,.fh5-watermark,
  [style*="z-index: 2147483647"],[style*="z-index:2147483647"] {
    display:none !important;
    visibility:hidden !important;
    pointer-events:none !important;
    opacity:0 !important;
    height:0 !important;
    width:0 !important;
  }
`;
document.head.appendChild(adCSS);

// â”€â”€ MutationObserver: DOM se ads hatao â”€â”€
const adSelectors = [
  'ins.adsbygoogle','.google-auto-placed','[class*="adsbygoogle"]',
  '[id*="google_ads"]','[class*="ad-container"]','[class*="advertisement"]',
  '.appgeyser-ad','.ag-banner','.ag-ad',
  '.flip-ad','.fh5co-ad','[class*="flipad"]','#fliphtml5-ad',
  '.powered-by-fliphtml5','.fh5-watermark',
  'iframe[src*="doubleclick"]','iframe[src*="googlesyndication"]',
];

const observer = new MutationObserver(mutations => {
  mutations.forEach(m => {
    m.addedNodes.forEach(node => {
      if(node.nodeType !== 1) return;
      const src = node.src || node.getAttribute?.('src') || '';
      if(src && isLocalBlocked(src)) { node.remove(); incrementBlock(); return; }
      adSelectors.forEach(sel => {
        if(node.matches?.(sel)) { node.remove(); incrementBlock(); }
        node.querySelectorAll?.(sel).forEach(el => { el.remove(); incrementBlock(); });
      });
    });
  });
});
observer.observe(document.documentElement, { childList:true, subtree:true });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STARS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const se = document.getElementById('stars');
for(let i=0;i<40;i++){
  const s=document.createElement('div'); s.className='star';
  const sz=Math.random()*5+2;
  s.style.cssText=`width:${sz}px;height:${sz}px;top:${Math.random()*100}%;left:${Math.random()*100}%;animation-duration:${Math.random()*2+1}s;animation-delay:${Math.random()*2}s;`;
  se.appendChild(s);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPLASH â†’ HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setTimeout(()=>{
  document.getElementById('splash').classList.add('hide');
  setTimeout(()=>{
    document.getElementById('splash').style.display='none';
    document.getElementById('home').classList.add('active');
    fetchComics();
  },800);
},3200);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FETCH COMICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let comicsData=[];

async function fetchComics(){
  showState('loading');
  try {
    const url = COMICS_JSON_URL + '?t=' + Date.now();
    const res = await _fetch(url); // use original fetch for our own JSON
    if(!res.ok) throw new Error('HTTP '+res.status);
    comicsData = await res.json();
    localStorage.setItem('champak_cache', JSON.stringify(comicsData));
    renderComics(comicsData);
    document.getElementById('statusCount').textContent = comicsData.length+' Comics âœ…';
  } catch(e) {
    const cached = localStorage.getItem('champak_cache');
    if(cached){
      comicsData=JSON.parse(cached);
      renderComics(comicsData);
      document.getElementById('statusCount').textContent='ğŸ“´ Cached ('+comicsData.length+')';
    } else {
      showState('error');
      document.getElementById('statusCount').textContent='âŒ Offline';
    }
  }
}

async function refreshComics(){
  const btn=document.getElementById('refreshBtn');
  btn.classList.add('spinning');
  await fetchComics();
  setTimeout(()=>btn.classList.remove('spinning'),700);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COLORS=[
  ['#FF6B00','#E64A00'],['#E63280','#B5006E'],
  ['#0066CC','#0044AA'],['#009944','#006622'],
  ['#8B00CC','#5C0099'],['#CC6600','#994400'],
  ['#CC0000','#880000'],['#006666','#004444'],
];

function renderComics(data){
  if(!data||!data.length){showState('empty');return;}
  showState('grid');
  const grid=document.getElementById('comicGrid');
  grid.innerHTML='';
  const sorted=[...data].sort((a,b)=>b.id-a.id);
  const newestId=sorted[0].id;
  sorted.forEach((comic,idx)=>{
    const [c1,c2]=COLORS[idx%COLORS.length];
    const isNew=comic.id===newestId&&data.length>1;
    const card=document.createElement('div');
    card.className='comic-card';
    card.style.animationDelay=(idx*0.07)+'s';
    card.innerHTML=`
      <div class="comic-cover" style="background:linear-gradient(135deg,${c1},${c2})">
        <span style="position:relative;z-index:1">${comic.cover||'ğŸ“•'}</span>
        ${comic.date?`<div class="comic-badge">${comic.date}</div>`:''}
        ${isNew?`<div class="new-badge">ğŸ†• NEW</div>`:''}
      </div>
      <div class="comic-info">
        <div class="comic-name">${comic.name}</div>
        <div class="comic-meta">
          <span>${comic.pages?comic.pages+' pg':''}</span>
          <span style="color:#27ae60;font-weight:700">Free</span>
        </div>
        <div class="open-btn">ğŸ“– Abhi Padho!</div>
      </div>
    `;
    card.onclick=()=>openComic(comic);
    grid.appendChild(card);
  });
}

function showState(s){
  document.getElementById('loadingState').style.display=s==='loading'?'block':'none';
  document.getElementById('errorState').style.display  =s==='error'  ?'block':'none';
  document.getElementById('emptyState').style.display  =s==='empty'  ?'block':'none';
  document.getElementById('comicGrid').style.display   =s==='grid'   ?'grid' :'none';
  document.getElementById('secTitle').style.display    =s==='grid'   ?'flex' :'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OPEN COMIC â€” Direct navigate (no iframe)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openComic(comic){
  document.getElementById('openingOverlay').classList.add('show');
  setTimeout(()=>{
    window.location.href = comic.flipUrl;
  },1200);
}
</script>
</body>
</html>
